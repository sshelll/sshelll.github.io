

<!DOCTYPE html>
<html lang="en" data-default-color-scheme=auto>



<head>
  <meta charset="UTF-8">

  <link rel="apple-touch-icon" sizes="76x76" href="/img/morty.jpeg">
  <link rel="icon" href="/img/morty.jpeg">
  

  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, shrink-to-fit=no">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  
  <meta name="theme-color" content="#2f4154">
  <meta name="author" content="kayce">
  <meta name="keywords" content="">
  
    <meta name="description" content="加密货币交易所中的安全传输实践">
<meta property="og:type" content="article">
<meta property="og:title" content="基于签名的鉴权架构">
<meta property="og:url" content="https://kayce.world/tech/signature_based_auth_arch/index.html">
<meta property="og:site_name" content="kayce">
<meta property="og:description" content="加密货币交易所中的安全传输实践">
<meta property="og:locale" content="en_US">
<meta property="article:published_time" content="2025-01-16T14:53:00.000Z">
<meta property="article:modified_time" content="2025-01-16T14:54:52.650Z">
<meta property="article:author" content="kayce">
<meta property="article:tag" content="Auth">
<meta name="twitter:card" content="summary_large_image">
  
  
    <meta name="referrer" content="no-referrer-when-downgrade">
  
  
  <title>基于签名的鉴权架构 - kayce</title>

  <link  rel="stylesheet" href="https://lib.baomitu.com/twitter-bootstrap/4.6.1/css/bootstrap.min.css" />



  <link  rel="stylesheet" href="https://lib.baomitu.com/github-markdown-css/4.0.0/github-markdown.min.css" />

  <link  rel="stylesheet" href="https://lib.baomitu.com/hint.css/2.7.0/hint.min.css" />

  <link  rel="stylesheet" href="https://lib.baomitu.com/fancybox/3.5.7/jquery.fancybox.min.css" />

  <link  rel="stylesheet" href="https://lib.baomitu.com/KaTeX/0.16.2/katex.min.css" />



<!-- 主题依赖的图标库，不要自行修改 -->
<!-- Do not modify the link that theme dependent icons -->

<link rel="stylesheet" href="//at.alicdn.com/t/c/font_1749284_5i9bdhy70f8.css">



<link rel="stylesheet" href="//at.alicdn.com/t/font_1736178_lbnruvf0jn.css">


<link  rel="stylesheet" href="/css/main.css" />


  <link id="highlight-css" rel="stylesheet" href="/css/highlight.css" />
  
    <link id="highlight-css-dark" rel="stylesheet" href="/css/highlight-dark.css" />
  



  
<link rel="stylesheet" href="//at.alicdn.com/t/c/font_4789608_0mu4sl00qiuq.css">



  <script id="fluid-configs">
    var Fluid = window.Fluid || {};
    Fluid.ctx = Object.assign({}, Fluid.ctx)
    var CONFIG = {"hostname":"kayce.world","root":"/","version":"1.9.8","typing":{"enable":true,"typeSpeed":70,"cursorChar":"_","loop":false,"scope":[]},"anchorjs":{"enable":true,"element":"h1,h2,h3,h4,h5,h6","placement":"left","visible":"hover","icon":""},"progressbar":{"enable":true,"height_px":3,"color":"#29d","options":{"showSpinner":false,"trickleSpeed":100}},"code_language":{"enable":false,"default":"TEXT"},"copy_btn":true,"image_caption":{"enable":true},"image_zoom":{"enable":true,"img_url_replace":["",""]},"toc":{"enable":true,"placement":"right","headingSelector":"h1,h2,h3,h4,h5,h6","collapseDepth":0},"lazyload":{"enable":true,"loading_img":"/img/loading.gif","onlypost":false,"offset_factor":2},"web_analytics":{"enable":true,"follow_dnt":true,"baidu":null,"google":null,"tencent":{"sid":null,"cid":null},"leancloud":{"app_id":null,"app_key":null,"server_url":null,"path":"window.location.pathname","ignore_local":false},"umami":{"src":null,"website_id":null,"domains":null,"start_time":"2024-01-01T00:00:00.000Z","token":null,"api_server":null},"gtag":null,"woyaola":null,"cnzz":null},"search_path":"/local-search.xml","include_content_in_search":true};

    if (CONFIG.web_analytics.follow_dnt) {
      var dntVal = navigator.doNotTrack || window.doNotTrack || navigator.msDoNotTrack;
      Fluid.ctx.dnt = dntVal && (dntVal.startsWith('1') || dntVal.startsWith('yes') || dntVal.startsWith('on'));
    }
  </script>
  <script  src="/js/utils.js" ></script>
  <script  src="/js/color-schema.js" ></script>
  

  

  

  

  

  



  
<meta name="generator" content="Hexo 7.3.0"></head>


<body>
  

  <header>
    

<div class="header-inner" style="height: 70vh;">
  <nav id="navbar" class="navbar fixed-top  navbar-expand-lg navbar-dark scrolling-navbar">
  <div class="container">
    <a class="navbar-brand" href="/">
      <strong>kayce&#39;s world</strong>
    </a>

    <button id="navbar-toggler-btn" class="navbar-toggler" type="button" data-toggle="collapse"
            data-target="#navbarSupportedContent"
            aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
      <div class="animated-icon"><span></span><span></span><span></span></div>
    </button>

    <!-- Collapsible content -->
    <div class="collapse navbar-collapse" id="navbarSupportedContent">
      <ul class="navbar-nav ml-auto text-center">
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/" target="_self">
                <i class="iconfont icon-home-fill"></i>
                <span>Home</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/archives/" target="_self">
                <i class="iconfont icon-archive-fill"></i>
                <span>Archives</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/categories/" target="_self">
                <i class="iconfont icon-category-fill"></i>
                <span>Categories</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/tags/" target="_self">
                <i class="iconfont icon-tags-fill"></i>
                <span>Tags</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/music/" target="_self">
                <i class="iconfont icon-music"></i>
                <span>Music</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/about/" target="_self">
                <i class="iconfont icon-user-fill"></i>
                <span>About</span>
              </a>
            </li>
          
        
        
          <li class="nav-item" id="search-btn">
            <a class="nav-link" target="_self" href="javascript:;" data-toggle="modal" data-target="#modalSearch" aria-label="Search">
              <i class="iconfont icon-search"></i>
            </a>
          </li>
          
        
        
          <li class="nav-item" id="color-toggle-btn">
            <a class="nav-link" target="_self" href="javascript:;" aria-label="Color Toggle">
              <i class="iconfont icon-dark" id="color-toggle-icon"></i>
            </a>
          </li>
        
      </ul>
    </div>
  </div>
</nav>

  

<div id="banner" class="banner" parallax=true
     style="background: url('/img/RanchoNight_16_Tree.png') no-repeat center center; background-size: cover;">
  <div class="full-bg-img">
    <div class="mask flex-center" style="background-color: rgba(0, 0, 0, 0.3)">
      <div class="banner-text text-center fade-in-up">
        <div class="h2">
          
            <span id="subtitle" data-typed-text="基于签名的鉴权架构"></span>
          
        </div>

        
          
  <div class="mt-3">
    
      <span class="post-meta mr-2">
        <i class="iconfont icon-author" aria-hidden="true"></i>
        kayce
      </span>
    
    
      <span class="post-meta">
        <i class="iconfont icon-date-fill" aria-hidden="true"></i>
        <time datetime="2025-01-16 22:53" pubdate>
          January 16, 2025 pm
        </time>
      </span>
    
  </div>

  <div class="mt-1">
    

    

    
    
      
        <span id="busuanzi_container_page_pv" style="display: none">
          <i class="iconfont icon-eye" aria-hidden="true"></i>
          <span id="busuanzi_value_page_pv"></span> views
        </span>
        

      
    
  </div>


        
      </div>

      
    </div>
  </div>
</div>

</div>

  </header>

  <main>
    
      

<div class="container-fluid nopadding-x">
  <div class="row nomargin-x">
    <div class="side-col d-none d-lg-block col-lg-2">
      

    </div>

    <div class="col-lg-8 nopadding-x-md">
      <div class="container nopadding-x-md" id="board-ctn">
        <div id="board">
          <article class="post-content mx-auto">
            <h1 id="seo-header">基于签名的鉴权架构</h1>
            
              <p id="updated-time" class="note note-info" style="">
                
                  
                    Last updated on January 16, 2025 pm
                  
                
              </p>
            
            
              <div class="markdown-body">
                
                <blockquote>
<p>请求处理的核心一环是鉴权，而在加密货币交易所中，鉴权的要求更为严格，因为它涉及到用户的资产安全。本文介绍一下我在前司基础架构组工作时瞥见的鉴权架构与实践。</p>
</blockquote>
<h2 id="核心原理">核心原理</h2>
<p>简单来说，签名鉴权的核心原理就是使用一个字符串对另一个字符串进行散列 / 哈希，然后得到一个新的字符串，该字符串不可逆，且不考虑碰撞的情况下，唯一对应于原字符串。</p>
<p class="katex-block "><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><mi>h</mi><mi>a</mi><mi>s</mi><mi>h</mi><mo stretchy="false">(</mo><mi>k</mi><mi>e</mi><mi>y</mi><mo separator="true">,</mo><mi>d</mi><mi>a</mi><mi>t</mi><mi>a</mi><mo stretchy="false">)</mo><mo>=</mo><mi>s</mi><mi>i</mi><mi>g</mi><mi>n</mi><mi>a</mi><mi>t</mi><mi>u</mi><mi>r</mi><mi>e</mi></mrow><annotation encoding="application/x-tex">hash(key, data) = signature
</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal">ha</span><span class="mord mathnormal">s</span><span class="mord mathnormal">h</span><span class="mopen">(</span><span class="mord mathnormal" style="margin-right:0.03148em;">k</span><span class="mord mathnormal" style="margin-right:0.03588em;">ey</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord mathnormal">d</span><span class="mord mathnormal">a</span><span class="mord mathnormal">t</span><span class="mord mathnormal">a</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.854em;vertical-align:-0.1944em;"></span><span class="mord mathnormal">s</span><span class="mord mathnormal">i</span><span class="mord mathnormal" style="margin-right:0.03588em;">g</span><span class="mord mathnormal">na</span><span class="mord mathnormal">t</span><span class="mord mathnormal">u</span><span class="mord mathnormal">re</span></span></span></span></span></p>
<p>我们将它套用到请求场景中，可以变化为:</p>
<p class="katex-block "><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><mi>h</mi><mi>a</mi><mi>s</mi><mi>h</mi><mo stretchy="false">(</mo><mi>k</mi><mi>e</mi><mi>y</mi><mo separator="true">,</mo><mi>r</mi><mi>e</mi><mi>q</mi><mi>u</mi><mi>e</mi><mi>s</mi><mi>t</mi><mi mathvariant="normal">_</mi><mi>i</mi><mi>n</mi><mi>f</mi><mi>o</mi><mo stretchy="false">)</mo><mo>=</mo><mi>s</mi><mi>i</mi><mi>g</mi><mi>n</mi><mi>a</mi><mi>t</mi><mi>u</mi><mi>r</mi><mi>e</mi></mrow><annotation encoding="application/x-tex">hash(key, request\_info) = signature
</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.06em;vertical-align:-0.31em;"></span><span class="mord mathnormal">ha</span><span class="mord mathnormal">s</span><span class="mord mathnormal">h</span><span class="mopen">(</span><span class="mord mathnormal" style="margin-right:0.03148em;">k</span><span class="mord mathnormal" style="margin-right:0.03588em;">ey</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord mathnormal">re</span><span class="mord mathnormal" style="margin-right:0.03588em;">q</span><span class="mord mathnormal">u</span><span class="mord mathnormal">es</span><span class="mord mathnormal">t</span><span class="mord" style="margin-right:0.02778em;">_</span><span class="mord mathnormal">in</span><span class="mord mathnormal" style="margin-right:0.10764em;">f</span><span class="mord mathnormal">o</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.854em;vertical-align:-0.1944em;"></span><span class="mord mathnormal">s</span><span class="mord mathnormal">i</span><span class="mord mathnormal" style="margin-right:0.03588em;">g</span><span class="mord mathnormal">na</span><span class="mord mathnormal">t</span><span class="mord mathnormal">u</span><span class="mord mathnormal">re</span></span></span></span></span></p>
<p>实践中，我们一般使用 HMAC-SHA256 算法进行签名:</p>
<div class="code-wrapper"><pre><code class="hljs go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> &#123;
	data := <span class="hljs-string">&quot;Hello, world!&quot;</span>
	key := <span class="hljs-string">&quot;my_secret_key&quot;</span>

	h := hmac.New(sha256.New, []<span class="hljs-type">byte</span>(key))
	h.Write([]<span class="hljs-type">byte</span>(data))
	hash := h.Sum(<span class="hljs-literal">nil</span>)

	hashHex := hex.EncodeToString(hash)
	fmt.Println(<span class="hljs-string">&quot;HMAC-SHA-256 Hash:&quot;</span>, hashHex)
&#125;</code></pre></div>

    <div class="fold">
      <div class="fold-title fold-default collapsed" data-toggle="collapse" href="#collapse-5dbffb8d" role="button" aria-expanded="false" aria-controls="collapse-5dbffb8d">
        <div class="fold-arrow">▶</div>OUTPUT
      </div>
      <div class="fold-collapse collapse" id="collapse-5dbffb8d">
        <div class="fold-content">
          <p>HMAC-SHA-256 Hash: 62aedf0125252922581bf109e6efc01ee2fbef97f9d60f5c065ce4a25e75273b</p>
        </div>
      </div>
    </div>
<p>一般来说，需要参与签名的请求信息主要是请求参数，比如 Binance 给出的命令行示例:</p>
<div class="code-wrapper"><pre><code class="hljs bash"><span class="hljs-built_in">echo</span> -n <span class="hljs-string">&quot;symbol=LTCBTC&amp;side=BUY&amp;type=LIMIT&amp;timeInForce=GTC&amp;quantity=1&amp;price=0.1&amp;recvWindow=5000&amp;timestamp=1499827319559&quot;</span> |
	openssl dgst -sha256 -hmac <span class="hljs-string">&quot;NhqPtmdSJYdKjVHjA7PZj4Mge3R5YNiP1e3UZjInClVN65XAbvqqM6A7H5fATj0j&quot;</span>

SHA2-256(stdin)= c8db56825ae71d6d79447849e617115f4a920fa2acdcab2b053c4b2838bd6b71</code></pre></div>
<p>生成出来的 <code>signature</code> 作为一个额外的参数附加在请求中捎带给服务器:</p>
<div class="code-wrapper"><pre><code class="hljs bash">curl -H <span class="hljs-string">&quot;X-MBX-APIKEY: vmPUZE6mv9SD5VNHk4HlWFsOr6aKE2zvsw0MuIgwCIPy6utIco14y7Ju91duEh8A&quot;</span> \
	-X POST <span class="hljs-string">&#x27;https://api.binance.com/api/v3/order&#x27;</span> \
	-d <span class="hljs-string">&#x27;symbol=LTCBTC&amp;side=BUY&amp;type=LIMIT&amp;timeInForce=GTC&amp;quantity=1&amp;price=0.1&amp;recvWindow=5000&amp;timestamp=1499827319559&amp;signature=c8db56825ae71d6d79447849e617115f4a920fa2acdcab2b053c4b2838bd6b71&#x27;</span></code></pre></div>
<p>服务端在接到请求后，会根据请求参数和密钥重新计算签名，然后与请求中的签名进行比对，如果一致则通过，否则拒绝。</p>
<p>考虑一下比对不一致的情况，有如下两种原因：</p>
<ol>
<li>请求被篡改，比如用户想买一个 BTC，被篡改为买 100 个 BTC</li>
<li>密钥不正确</li>
</ol>
<div class="note note-primary">
            <p><strong><em>SUMMARY:</em></strong></p><p>从上可见，如果签名验证成功，我们可以说请求是合法的。</p><p>因为上述签名是基于密钥的，所以混合了防篡改和鉴权的功能。</p><p>不难看出，签名鉴权的核心在于密钥的管理 —— 用户需要使用密钥生成签名，服务器需要使用相同的密钥验证签名。</p>
          </div>
<h2 id="用户创建">用户创建</h2>
<p>前面提到，签名的核心在于密钥的管理，而密钥的初始化就发生在用户创建的时候 —— 用户注册时，我们需要给用户生成一个密钥，后续用户的请求就使用这个密钥进行签名。</p>
<p>这里引出三个问题：</p>
<ol>
<li>
<p>创建请求本身的鉴权 —— 此时还没有用户密钥</p>
</li>
<li>
<p>用户密钥的安全传输 —— 生成密钥后，如何安全地传输给用户</p>
</li>
<li>
<p>用户密钥的安全存储 —— 如何安全地保存密钥</p>
</li>
</ol>
<h3 id="调用方发起请求">调用方发起请求</h3>
<pre><code class=" mermaid">classDiagram
    direction LR
    class CLIENT &#123;
        data_key: string
        fingerprint: string
        user_info: dict
        gen_data_key() string
        gen_fingerprint() string
        encrypt_user_info(user_info, data_key) dict
        encrypt_fingerprint(fingerprint, data_key) string
        encrypt_data_key(data_key) string
        sign(dict) string
    &#125;
    class REQUEST &#123;
        data_key_encrypted: string
        fingerprint_encrypted: string
        user_info_encrypted: dict
        signature: string
    &#125;
    CLIENT --&gt; REQUEST : sends</code></pre>
<p>考虑请求的构建过程如下：</p>
<ol>
<li>用户注册时，初始状态下，主要包含 3 个明文信息：</li>
</ol>
<ul>
<li><code>data_key</code>：当前请求的数据加密密钥，是对称的。并且该密钥是临时生成的，特用于处理账号注册请求。</li>
<li><code>fingerprint</code>：当前用户的指纹，使用特殊算法生成，可以包含设备 ID 或其它的特征。</li>
<li><code>user_info</code>: 用户的基本信息，比如邮箱、电话等。</li>
</ul>
<ol start="2">
<li>然后根据以上信息生成 <code>signature</code>:</li>
</ol>
<div class="note note-light">
            <p>考虑这里的签名是如何生成的：</p><p>可以确定的是，这里的签名和用户密钥无关，因为此时用户还没有密钥。<br>这里的签名实际上是调用方在 AWS KMS 中，使用非对称密钥生成的签名，这个密钥对只有两端能够访问，分别是：</p><ul><li>外层调用方服务</li><li>内层基础架构账号服务</li></ul><p>也就是说，内层基础服务依赖 AWS KMS 来验证请求方的身份，只处理真正来自我司外层服务团队发过来的请求。</p>
          </div>
<ol start="3">
<li>接着，使用 <code>data_key</code> 加密 <code>user_info</code> 和 <code>fingerprint</code></li>
</ol>
<ul>
<li><code>data_key + user_info -&gt; user_info_encrypted</code></li>
<li><code>data_key + fingerprint -&gt; fingerprint_encrypted</code></li>
</ul>
<ol start="4">
<li>最后，加密 <code>data_key</code> 本身<br>
这一步也是利用 AWS KMS 完成的，同样保证只有两端能够访问。即 <code>data_key + KMS -&gt; data_key_encrypted</code></li>
</ol>
<p>至此，我们将上述信息打包成一个请求，发送给服务端。</p>
<div class="note note-primary">
            <p><strong><em>SUMMARY:</em></strong></p><p>考虑这里的请求是如何保证安全性的：</p><ol><li><code>data_key</code> 的理论粒度是请求级别的, 每个新用户注册时使用的 <code>data_key</code> 都是不同的。</li><li>所有数据都使用 <code>data_key</code> 加密，保证了数据的机密性。</li><li>使用基于 AWS KMS 的内部签名，保证了请求的完整性和 ACL 功能。</li></ol>
          </div>
<hr>
<h3 id="服务端验证请求">服务端验证请求</h3>
<p>接下来看服务端接到请求之后如何对请求进行验证。</p>
<pre><code class=" mermaid">classDiagram
    direction LR
    class REQUEST &#123;
        data_key_encrypted: string
        fingerprint_encrypted: string
        user_info_encrypted: dict
        signature: string
    &#125;
    class KMS &#123;
        decrypt_data_key() string
        decrypt_common_salt() string
        sign()
    &#125;
    class SERVER &#123;
        data_key: string
        common_salt: string
    &#125;
    class DATABASE &#123;
        common_salt_encrypted: string
    &#125;
    REQUEST --&gt; KMS
    DATABASE --&gt; KMS
    KMS --&gt; SERVER : data_key + common_salt</code></pre>
<ol>
<li>服务端经过上面步骤可以拿到 <code>data_key</code> 和 <code>common_salt</code></li>
<li>然后使用 <code>data_key</code> 对请求中的 <code>user_info</code> 和 <code>fingerprint</code> 进行解密，得到明文信息</li>
<li>使用解密后的信息找 KMS 验证签名</li>
</ol>
<p>至此，验证步骤已经完成。</p>
<hr>
<h3 id="用户密钥的生成、存储和返回">用户密钥的生成、存储和返回</h3>
<p>生成步骤比较简单，根据一定算法随机生成一下即可。这里省略具体的生成算法。假设我们已经生成了 <span class="label label-info">secret_key_plain_text</span>，重点关注后续步骤：即存储和返回。</p>
<ol>
<li>
<p><strong>存储</strong><br>
分两步骤考虑存储问题：</p>
<ul>
<li>如何加密存储 <code>secret_key_plain_text</code> —— 显然我们不能直接存储明文。</li>
<li>进一步的，密钥的粒度是什么 —— 全局唯一吗？</li>
</ul>
<p>一个简单的思路是，继续利用 AWS KMS 对这个 <code>secret_key_plain_text</code> 进行加密，然后存储密文在数据库中。其实对于大部分场景，这个方案是基本够用的，但是这个方案最明显的问题在于：所有用户的 <code>secret_key</code> 都用的一个密钥加密。假设这个唯一的密钥被破解了，那么所有用户的密钥都可以被解密。</p>
<p>因此我们选择了另外一种方案，在不影响性能的情况下，做到用户粒度的密钥加密，即每个用户的密钥都使用不同的密钥加密。这样即使某个密钥被破解，也只能影响到一个用户:</p>
<p>上一步中我们拿到了 <code>common_salt</code> 以及 <code>fingerprint</code> 的明文，我们可以直接使用这两个信息拼接生成加密密钥。</p>
<div class="code-wrapper"><pre><code class="hljs go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">GenStorageKey</span><span class="hljs-params">(commonSalt, fingerprint <span class="hljs-type">string</span>)</span></span> <span class="hljs-type">string</span> &#123;
    <span class="hljs-keyword">return</span> hash(commonSalt + fingerprint)
&#125;</code></pre></div>
<p>然后我们使用该 <code>storage_key</code> 加密 <code>secret_key</code> 得到 <code>secret_key_encrypted</code> 再进行存储。</p>
<p>存储了用户 <code>secret_key</code> 还不够，<code>storage_key</code> 也需要存储，否则后续无法解密 <code>secret_key</code>。这一步我们选择使用 AWS KMS 分别加密 <code>fingerprint</code> 和 <code>common_salt</code>，然后存储在数据库中，而不是加密 <code>storage_key</code> 在存储。</p>
<pre><code class=" mermaid">classDiagram
 direction RL
	class UserSecretKeyRecord &#123;
		user_id: u64
		secret_key_encrypted: string
		fingerprint_encrypted: string
	&#125;
 class CommonSecretRecord &#123;
		common_salt_encrypted: string
 &#125;
 UserSecretKeyRecord --|&gt; &quot;+&quot; CommonSecretRecord</code></pre>
</li>
<li>
<p><strong>返回生成的密钥，结束请求</strong><br>
使用调用方传过来的 <code>data_key</code> 加密我们生成的 <code>secret_key</code> 进行返回即可。保证该响应只有调用方能够解密查看。</p>
</li>
</ol>
<div class="note note-primary">
            <p><strong><em>SUMMARY:</em></strong></p><table><thead><tr><th>Field</th><th>Security Layer</th><th>Helper</th></tr></thead><tbody><tr><td>data_key</td><td>请求本身的加密</td><td>KMS</td></tr><tr><td>signature</td><td>请求的完整性</td><td>KMS</td></tr><tr><td>fingerprint</td><td>用户指纹，secret_key 的构成部分</td><td>KMS</td></tr><tr><td>common_salt</td><td>secret_key 的构成部分</td><td>KMS</td></tr></tbody></table>
          </div>
<h2 id="用户请求">用户请求</h2>
<p>用户注册完成后，用户拿到了自己的密钥，接下来的请求就可以使用这个密钥进行签名了。</p>
<pre><code class=" mermaid">classDiagram
    direction LR
    class USER &#123;
        api_key: string
        secret_key: string
        sign(dict) string
    &#125;
    class REQUEST &#123;
        params: dict
        signature: string
        api_key: string
    &#125;
    USER --&gt; REQUEST : sends</code></pre>
<p>服务端接到请求后，首先根据 <code>api_key</code> 找到对应的 <code>secret_key</code>（前面我们省略了关于 <code>api_key</code> 的细节，在这个场景下可以简单理解为 <code>user_id</code>），然后使用 <code>secret_key</code> 对请求参数进行签名，最后与请求中的签名进行比对即可。</p>
<p>上述核心原理比较好理解，复杂的点在于工程实践上的实际架构。出于保密等原因，这里不展开说明。</p>
<h2 id="多层签名的实践">多层签名的实践</h2>
<p>前面的场景中，主要介绍的是如何利用签名进行用户请求的合法性校验。在实际工作中，前司的 CTO 提出了一个更高级的要求 —— 基于多层签名验证全链路的合法性。</p>
<p>考虑一个典型的场景：</p>
<pre><code class=" mermaid">flowchart LR
    User --&gt; Gateway --&gt; Service_A --&gt; Service_B --&gt; Service_C</code></pre>
<p>对于服务 C 来说，假设它需要验证请求是否合法，方式与用户请求类似，验证请求中的签名。考虑验证通过的情况下，能够说明什么问题？</p>
<div class="note note-warning">
            <p>服务能过验证说明请求是合法的，但是并不能说明请求的来源是合法的。</p><p>换句话来说，服务 C 在这种状况下不关心请求的来源，只关心请求的合法性。无论是谁，只要发送相同的请求到 C，都能通过验证。</p>
          </div>
<p>CTO 提出，为了避免员工&quot;监守自盗&quot;的问题，需要在基础架构服务上加入验证机制，保证请求来源的可信。</p>
<div class="note note-light">
            <p>这里指的是，假设服务 A 作为入口上游是可信的，服务 C 作为公司基础架构层也是可靠的，此时假设中间服务 B 是外包开发。<br>那么 B 开发者可以利用自己的权限，在没有接到 A 的调用的情况下，手动构造发送一个转账请求到服务 C，于是就未经用户授权，直接将用户的资产转走了。</p>
          </div>
<p>为了应对这种情况，我们引入了多层签名验证机制。</p>
<pre><code class=" mermaid">classDiagram
    direction LR
    class REQUEST_A &#123;
        payload_a: string
        signature_a: string
    &#125;
    class REQUEST_B &#123;
        payload_b: string
        signature_b: string
    &#125;
    class SERVICE_C &#123;
    &#125;
    REQUEST_A &quot;wrap&quot; &lt;-- REQUEST_B
    REQUEST_B --&gt; SERVICE_C : sends</code></pre>
<ol>
<li>
<p>A 构造消息：<br>
A 构造原始请求 PAYLOAD_A<br>
A 生成签名 SIGN_A(PAYLOAD_A)，然后使用 A 的私钥加密<br>
将消息打包为 REQUEST_A = (PAYLOAD_A, SIGN_A)，发送给 B</p>
</li>
<li>
<p>B 接收并签名：<br>
B 收到 REQUEST_A 后，使用 A 的公钥解密 SIGN_A，再验证 A 的签名是否有效。<br>
如果有效，B 对 PAYLOAD_A 和自己的 PAYLOAD_B 信息整体签名，生成 SIGN_B(PAYLOAD_A, PAYLOAD_B)。<br>
将消息打包为 REQUEST_B = (PAYLOAD_A, SIGN_A, PAYLOAD_B, SIGN_B)，发送给 C。</p>
</li>
<li>
<p>C 接收并验证：<br>
C 收到 REQUEST_B 后，逐层验证签名：<br>
先使用 A 的公钥解密后，验证 SIGN_A(PAYLOAD_A) 是否有效。<br>
再使用 B 的公钥解密后，验证 SIGN_B(PAYLOAD_A, PAYLOAD_B) 是否有效。<br>
如果所有签名都通过，C 可以确定请求从 A → B → C 的过程中未被篡改。</p>
</li>
</ol>
<p>这里给一个 Demo 演示基本原理：</p>
<div class="code-wrapper"><pre><code class="hljs go"><span class="hljs-keyword">package</span> main

<span class="hljs-keyword">import</span> (
	<span class="hljs-string">&quot;crypto&quot;</span>
	<span class="hljs-string">&quot;crypto/rand&quot;</span>
	<span class="hljs-string">&quot;crypto/rsa&quot;</span>
	<span class="hljs-string">&quot;crypto/sha256&quot;</span>
	<span class="hljs-string">&quot;encoding/base64&quot;</span>
	<span class="hljs-string">&quot;encoding/json&quot;</span>
	<span class="hljs-string">&quot;time&quot;</span>
)

<span class="hljs-keyword">var</span> (
	PubKeyA *rsa.PublicKey
	PriKeyA *rsa.PrivateKey
	PubKeyB *rsa.PublicKey
	PriKeyB *rsa.PrivateKey
)

<span class="hljs-keyword">type</span> RequestA <span class="hljs-keyword">struct</span> &#123;
	Payload   <span class="hljs-keyword">map</span>[<span class="hljs-type">string</span>]<span class="hljs-type">string</span>
	Signature <span class="hljs-type">string</span>
&#125;

<span class="hljs-keyword">type</span> RequestB <span class="hljs-keyword">struct</span> &#123;
	PayloadA   <span class="hljs-keyword">map</span>[<span class="hljs-type">string</span>]<span class="hljs-type">string</span> <span class="hljs-comment">// A&#x27;s payload</span>
	SignatureA <span class="hljs-type">string</span>
	Payload    <span class="hljs-keyword">map</span>[<span class="hljs-type">string</span>]<span class="hljs-type">string</span> <span class="hljs-comment">// B&#x27;s payload</span>
	Signature  <span class="hljs-type">string</span>
&#125;

<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> &#123;
	chC := serviceC()
	chB := serviceB(chC)

	<span class="hljs-comment">// 模拟 A 发送请求给 B</span>
	payload := <span class="hljs-keyword">map</span>[<span class="hljs-type">string</span>]<span class="hljs-type">string</span>&#123;<span class="hljs-string">&quot;serviceA&quot;</span>: <span class="hljs-string">&quot;serviceA&quot;</span>&#125;
	signature := sign(payload, PriKeyA)
	req := RequestA&#123;
		Payload:   payload,
		Signature: signature,
	&#125;
	chB &lt;- req

	<span class="hljs-comment">// 等待异步处理完成</span>
	time.Sleep(<span class="hljs-number">1</span> * time.Second)
&#125;

<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">serviceB</span><span class="hljs-params">(chanC <span class="hljs-keyword">chan</span> RequestB)</span></span> <span class="hljs-keyword">chan</span> RequestA &#123;
	ch := <span class="hljs-built_in">make</span>(<span class="hljs-keyword">chan</span> RequestA)
	<span class="hljs-keyword">go</span> <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">()</span></span> &#123;
		<span class="hljs-keyword">for</span> req := <span class="hljs-keyword">range</span> ch &#123;
			params := <span class="hljs-built_in">make</span>(<span class="hljs-keyword">map</span>[<span class="hljs-type">string</span>]<span class="hljs-type">string</span>)
			params[<span class="hljs-string">&quot;serviceB&quot;</span>] = <span class="hljs-string">&quot;serviceB&quot;</span>
			<span class="hljs-keyword">for</span> k, v := <span class="hljs-keyword">range</span> req.Payload &#123;
				params[k] = v
			&#125;
			signature := sign(params, PriKeyB)
			reqB := RequestB&#123;
				PayloadA:   req.Payload,
				SignatureA: req.Signature,
				Payload:    <span class="hljs-keyword">map</span>[<span class="hljs-type">string</span>]<span class="hljs-type">string</span>&#123;<span class="hljs-string">&quot;serviceB&quot;</span>: <span class="hljs-string">&quot;serviceB&quot;</span>&#125;,
				Signature:  signature,
			&#125;
			chanC &lt;- reqB
		&#125;
	&#125;()
	<span class="hljs-keyword">return</span> ch
&#125;

<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">serviceC</span><span class="hljs-params">()</span></span> <span class="hljs-keyword">chan</span> RequestB &#123;
	ch := <span class="hljs-built_in">make</span>(<span class="hljs-keyword">chan</span> RequestB)
	<span class="hljs-keyword">go</span> <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">()</span></span> &#123;
		<span class="hljs-keyword">for</span> req := <span class="hljs-keyword">range</span> ch &#123;
			<span class="hljs-comment">// Verify signature A</span>
			<span class="hljs-keyword">if</span> !verifySignature(req.PayloadA, req.SignatureA, PubKeyA) &#123;
				<span class="hljs-built_in">println</span>(<span class="hljs-string">&quot;Invalid signature A&quot;</span>)
				<span class="hljs-keyword">continue</span>
			&#125;

			<span class="hljs-comment">// Verify signature B</span>
			payload := <span class="hljs-built_in">make</span>(<span class="hljs-keyword">map</span>[<span class="hljs-type">string</span>]<span class="hljs-type">string</span>)
			<span class="hljs-keyword">for</span> k, v := <span class="hljs-keyword">range</span> req.Payload &#123;
				payload[k] = v
			&#125;
			<span class="hljs-keyword">for</span> k, v := <span class="hljs-keyword">range</span> req.PayloadA &#123;
				payload[k] = v
			&#125;
			<span class="hljs-keyword">if</span> !verifySignature(payload, req.Signature, PubKeyB) &#123;
				<span class="hljs-built_in">println</span>(<span class="hljs-string">&quot;Invalid signature B&quot;</span>)
				<span class="hljs-keyword">continue</span>
			&#125;

			<span class="hljs-built_in">println</span>(<span class="hljs-string">&quot;Verify OK&quot;</span>)
		&#125;
	&#125;()
	<span class="hljs-keyword">return</span> ch
&#125;

<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">sign</span><span class="hljs-params">(payload <span class="hljs-keyword">map</span>[<span class="hljs-type">string</span>]<span class="hljs-type">string</span>, privateKey *rsa.PrivateKey)</span></span> <span class="hljs-type">string</span> &#123;
	payloadBs, _ := json.Marshal(payload)
	h := sha256.New()
	h.Write(payloadBs)
	hash := h.Sum(<span class="hljs-literal">nil</span>)

	signature, err := rsa.SignPKCS1v15(rand.Reader, privateKey, crypto.SHA256, hash)
	<span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> &#123;
		<span class="hljs-built_in">panic</span>(err)
	&#125;
	<span class="hljs-keyword">return</span> base64.StdEncoding.EncodeToString(signature)
&#125;

<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">verifySignature</span><span class="hljs-params">(payload <span class="hljs-keyword">map</span>[<span class="hljs-type">string</span>]<span class="hljs-type">string</span>, signature <span class="hljs-type">string</span>, publicKey *rsa.PublicKey)</span></span> <span class="hljs-type">bool</span> &#123;
	payloadBs, _ := json.Marshal(payload)
	h := sha256.New()
	h.Write(payloadBs)
	hash := h.Sum(<span class="hljs-literal">nil</span>)

	signatureBytes, _ := base64.StdEncoding.DecodeString(signature)
	err := rsa.VerifyPKCS1v15(publicKey, crypto.SHA256, hash, signatureBytes)
	<span class="hljs-keyword">return</span> err == <span class="hljs-literal">nil</span>
&#125;

<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">init</span><span class="hljs-params">()</span></span> &#123;
	generateRSAKeyPair := <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">(bits <span class="hljs-type">int</span>)</span></span> (*rsa.PrivateKey, *rsa.PublicKey, <span class="hljs-type">error</span>) &#123;
		privateKey, err := rsa.GenerateKey(rand.Reader, bits)
		<span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> &#123;
			<span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span>, <span class="hljs-literal">nil</span>, err
		&#125;
		<span class="hljs-keyword">return</span> privateKey, &amp;privateKey.PublicKey, <span class="hljs-literal">nil</span>
	&#125;
	PriKeyA, PubKeyA, _ = generateRSAKeyPair(<span class="hljs-number">2048</span>)
	PriKeyB, PubKeyB, _ = generateRSAKeyPair(<span class="hljs-number">2048</span>)
&#125;</code></pre></div>
<p>实践中, 可能会发生链路长 / 请求参数过大的情况，为了避免最后一个端点的请求性能严重下降，我们可以把捎带的请求参数列表更换为捎带请求参数的 SHA-256 摘要:</p>
<div class="code-wrapper"><pre><code class="hljs go"><span class="hljs-keyword">type</span> Request <span class="hljs-keyword">struct</span> &#123;
    PayloadDigestSigChain <span class="hljs-keyword">map</span>[<span class="hljs-type">string</span>]<span class="hljs-type">string</span> <span class="hljs-comment">// payload digest -&gt; signature</span>
&#125;</code></pre></div>
<p>实际签名的步骤为:</p>
<ol>
<li>将参数列表转换为 string 拼接起来</li>
<li>对这个 string 进行 SHA-256 摘要</li>
<li>使用私钥对摘要进行签名</li>
</ol>
<p>这样可以避免传输完整的参数列表，减轻服务端的压力。</p>

                
              </div>
            
            <hr/>
            <div>
              <div class="post-metas my-3">
  
    <div class="post-meta mr-3 d-flex align-items-center">
      <i class="iconfont icon-category"></i>
      

<span class="category-chains">
  
  
    
      <span class="category-chain">
        
  <a href="/categories/tech/" class="category-chain-item">tech</a>
  
  

      </span>
    
  
</span>

    </div>
  
  
    <div class="post-meta">
      <i class="iconfont icon-tags"></i>
      
        <a href="/tags/Auth/" class="print-no-link">#Auth</a>
      
    </div>
  
</div>


              
  

  <div class="license-box my-3">
    <div class="license-title">
      <div>基于签名的鉴权架构</div>
      <div>https://kayce.world/tech/signature_based_auth_arch/</div>
    </div>
    <div class="license-meta">
      
        <div class="license-meta-item">
          <div>Author</div>
          <div>kayce</div>
        </div>
      
      
        <div class="license-meta-item license-meta-date">
          <div>Posted on</div>
          <div>January 16, 2025</div>
        </div>
      
      
        <div class="license-meta-item license-meta-date">
          <div>Updated on</div>
          <div>January 16, 2025</div>
        </div>
      
      
        <div class="license-meta-item">
          <div>Licensed under</div>
          <div>
            
              
              
                <a class="print-no-link" target="_blank" href="https://creativecommons.org/licenses/by-nc-sa/4.0/">
                  <span class="hint--top hint--rounded" aria-label="BY - Attribution">
                    <i class="iconfont icon-cc-by"></i>
                  </span>
                </a>
              
                <a class="print-no-link" target="_blank" href="https://creativecommons.org/licenses/by-nc-sa/4.0/">
                  <span class="hint--top hint--rounded" aria-label="NC - Non-commercial">
                    <i class="iconfont icon-cc-nc"></i>
                  </span>
                </a>
              
                <a class="print-no-link" target="_blank" href="https://creativecommons.org/licenses/by-nc-sa/4.0/">
                  <span class="hint--top hint--rounded" aria-label="SA - Share-alike">
                    <i class="iconfont icon-cc-sa"></i>
                  </span>
                </a>
              
            
          </div>
        </div>
      
    </div>
    <div class="license-icon iconfont"></div>
  </div>



              
                <div class="post-prevnext my-3">
                  <article class="post-prev col-6">
                    
                    
                      <a href="/tech/scenario_misc/" title="Scenario Misc">
                        <i class="iconfont icon-arrowleft"></i>
                        <span class="hidden-mobile">Scenario Misc</span>
                        <span class="visible-mobile">Previous</span>
                      </a>
                    
                  </article>
                  <article class="post-next col-6">
                    
                    
                      <a href="/tech/rule_based_auth_sys/" title="基于规则的权限系统">
                        <span class="hidden-mobile">基于规则的权限系统</span>
                        <span class="visible-mobile">Next</span>
                        <i class="iconfont icon-arrowright"></i>
                      </a>
                    
                  </article>
                </div>
              
            </div>

            
  
  
    <article id="comments" lazyload>
      
  <div id="gitalk-container"></div>
  <script type="text/javascript">
    Fluid.utils.loadComments('#gitalk-container', function() {
      Fluid.utils.createCssLink('/css/gitalk.css')
      Fluid.utils.createScript('https://lib.baomitu.com/gitalk/1.8.0/gitalk.min.js', function() {
        var options = Object.assign(
          {"clientID":"b25aa0a3d88c5fc4dbeb","clientSecret":"485e76d306112a519d43b4118efa8971c3ff6069","repo":"sshelll.github.io","owner":"sshelll","admin":["sshelll"],"language":"en-US","labels":["Gitalk"],"perPage":10,"pagerDirection":"last","distractionFreeMode":false,"createIssueManually":true,"proxy":"https://cors-anywhere.azm.workers.dev/https://github.com/login/oauth/access_token"},
          {
            id: '171a8a8cd0ead47b859950026789092d'
          }
        )
        var gitalk = new Gitalk(options);
        gitalk.render('gitalk-container');
      });
    });
  </script>
  <noscript>Please enable JavaScript to view the comments</noscript>


    </article>
  


          </article>
        </div>
      </div>
    </div>

    <div class="side-col d-none d-lg-block col-lg-2">
      
  <aside class="sidebar" style="margin-left: -1rem">
    <div id="toc">
  <p class="toc-header">
    <i class="iconfont icon-list"></i>
    <span>Table of Contents</span>
  </p>
  <div class="toc-body" id="toc-body"></div>
</div>



  </aside>


    </div>
  </div>
</div>





  



  



  



  



  


  
  




  <script>
  Fluid.utils.createScript('https://lib.baomitu.com/mermaid/8.14.0/mermaid.min.js', function() {
    mermaid.initialize({"theme":"default"});

    Fluid.utils.listenDOMLoaded(function() {
      Fluid.events.registerRefreshCallback(function() {
        if ('mermaid' in window) {
          mermaid.init();
        }
      });
    });
  });
</script>






    

    
      <a id="scroll-top-button" aria-label="TOP" href="#" role="button">
        <i class="iconfont icon-arrowup" aria-hidden="true"></i>
      </a>
    

    
      <div class="modal fade" id="modalSearch" tabindex="-1" role="dialog" aria-labelledby="ModalLabel"
     aria-hidden="true">
  <div class="modal-dialog modal-dialog-scrollable modal-lg" role="document">
    <div class="modal-content">
      <div class="modal-header text-center">
        <h4 class="modal-title w-100 font-weight-bold">Search</h4>
        <button type="button" id="local-search-close" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body mx-3">
        <div class="md-form mb-5">
          <input type="text" id="local-search-input" class="form-control validate">
          <label data-error="x" data-success="v" for="local-search-input">Keyword</label>
        </div>
        <div class="list-group" id="local-search-result"></div>
      </div>
    </div>
  </div>
</div>

    

    
  </main>

  <footer>
    <div class="footer-inner">
  
    <div class="footer-content">
      <a>kayce</a>
    </div>
  
  
    <div class="statistics">
  
  

  
    
      <span id="busuanzi_container_site_pv" style="display: none">
        Views: 
        <span id="busuanzi_value_site_pv"></span>
        
      </span>
    
    
      <span id="busuanzi_container_site_uv" style="display: none">
        Visitors: 
        <span id="busuanzi_value_site_uv"></span>
        
      </span>
    
    

  

</div>

  
  
</div>

  </footer>

  <!-- Scripts -->
  
  <script  src="https://lib.baomitu.com/nprogress/0.2.0/nprogress.min.js" ></script>
  <link  rel="stylesheet" href="https://lib.baomitu.com/nprogress/0.2.0/nprogress.min.css" />

  <script>
    NProgress.configure({"showSpinner":false,"trickleSpeed":100})
    NProgress.start()
    window.addEventListener('load', function() {
      NProgress.done();
    })
  </script>


<script  src="https://lib.baomitu.com/jquery/3.6.0/jquery.min.js" ></script>
<script  src="https://lib.baomitu.com/twitter-bootstrap/4.6.1/js/bootstrap.min.js" ></script>
<script  src="/js/events.js" ></script>
<script  src="/js/plugins.js" ></script>


  <script  src="https://lib.baomitu.com/typed.js/2.0.12/typed.min.js" ></script>
  <script>
    (function (window, document) {
      var typing = Fluid.plugins.typing;
      var subtitle = document.getElementById('subtitle');
      if (!subtitle || !typing) {
        return;
      }
      var text = subtitle.getAttribute('data-typed-text');
      
        typing(text);
      
    })(window, document);
  </script>




  
    <script  src="/js/img-lazyload.js" ></script>
  




  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/tocbot/4.18.2/tocbot.min.js', function() {
    var toc = jQuery('#toc');
    if (toc.length === 0 || !window.tocbot) { return; }
    var boardCtn = jQuery('#board-ctn');
    var boardTop = boardCtn.offset().top;

    window.tocbot.init(Object.assign({
      tocSelector     : '#toc-body',
      contentSelector : '.markdown-body',
      linkClass       : 'tocbot-link',
      activeLinkClass : 'tocbot-active-link',
      listClass       : 'tocbot-list',
      isCollapsedClass: 'tocbot-is-collapsed',
      collapsibleClass: 'tocbot-is-collapsible',
      scrollSmooth    : true,
      includeTitleTags: true,
      headingsOffset  : -boardTop,
    }, CONFIG.toc));
    if (toc.find('.toc-list-item').length > 0) {
      toc.css('visibility', 'visible');
    }

    Fluid.events.registerRefreshCallback(function() {
      if ('tocbot' in window) {
        tocbot.refresh();
        var toc = jQuery('#toc');
        if (toc.length === 0 || !tocbot) {
          return;
        }
        if (toc.find('.toc-list-item').length > 0) {
          toc.css('visibility', 'visible');
        }
      }
    });
  });
</script>


  <script src=https://lib.baomitu.com/clipboard.js/2.0.11/clipboard.min.js></script>

  <script>Fluid.plugins.codeWidget();</script>


  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/anchor-js/4.3.1/anchor.min.js', function() {
    window.anchors.options = {
      placement: CONFIG.anchorjs.placement,
      visible  : CONFIG.anchorjs.visible
    };
    if (CONFIG.anchorjs.icon) {
      window.anchors.options.icon = CONFIG.anchorjs.icon;
    }
    var el = (CONFIG.anchorjs.element || 'h1,h2,h3,h4,h5,h6').split(',');
    var res = [];
    for (var item of el) {
      res.push('.markdown-body > ' + item.trim());
    }
    if (CONFIG.anchorjs.placement === 'left') {
      window.anchors.options.class = 'anchorjs-link-left';
    }
    window.anchors.add(res.join(', '));

    Fluid.events.registerRefreshCallback(function() {
      if ('anchors' in window) {
        anchors.removeAll();
        var el = (CONFIG.anchorjs.element || 'h1,h2,h3,h4,h5,h6').split(',');
        var res = [];
        for (var item of el) {
          res.push('.markdown-body > ' + item.trim());
        }
        if (CONFIG.anchorjs.placement === 'left') {
          anchors.options.class = 'anchorjs-link-left';
        }
        anchors.add(res.join(', '));
      }
    });
  });
</script>


  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/fancybox/3.5.7/jquery.fancybox.min.js', function() {
    Fluid.plugins.fancyBox();
  });
</script>


  <script>Fluid.plugins.imageCaption();</script>

  <script  src="/js/local-search.js" ></script>

  <script defer src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js" ></script>





<!-- 主题的启动项，将它保持在最底部 -->
<!-- the boot of the theme, keep it at the bottom -->
<script  src="/js/boot.js" ></script>


  

  <noscript>
    <div class="noscript-warning">Blog works best with JavaScript enabled</div>
  </noscript>
</body>
</html>

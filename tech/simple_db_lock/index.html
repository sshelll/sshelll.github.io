

<!DOCTYPE html>
<html lang="en" data-default-color-scheme=auto>



<head>
  <meta charset="UTF-8">

  <link rel="apple-touch-icon" sizes="76x76" href="/img/morty.jpeg">
  <link rel="icon" href="/img/morty.jpeg">
  

  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, shrink-to-fit=no">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  
  <meta name="theme-color" content="#2f4154">
  <meta name="author" content="kayce">
  <meta name="keywords" content="">
  
    <meta name="description" content="本文介绍了一种基于数据库的分布式锁设计">
<meta property="og:type" content="article">
<meta property="og:title" content="一种基于数据库的分布式锁设计">
<meta property="og:url" content="https://kayce.world/tech/simple_db_lock/index.html">
<meta property="og:site_name" content="kayce">
<meta property="og:description" content="本文介绍了一种基于数据库的分布式锁设计">
<meta property="og:locale" content="en_US">
<meta property="og:image" content="https://kayce.world/img/simple_db_lock/p1.png">
<meta property="article:published_time" content="2023-11-16T03:13:40.000Z">
<meta property="article:modified_time" content="2023-11-16T09:00:40.000Z">
<meta property="article:author" content="kayce">
<meta property="article:tag" content="Golang">
<meta property="article:tag" content="Database">
<meta name="twitter:card" content="summary_large_image">
<meta name="twitter:image" content="https://kayce.world/img/simple_db_lock/p1.png">
  
  
    <meta name="referrer" content="no-referrer-when-downgrade">
  
  
  <title>一种基于数据库的分布式锁设计 - kayce</title>

  <link  rel="stylesheet" href="https://lib.baomitu.com/twitter-bootstrap/4.6.1/css/bootstrap.min.css" />



  <link  rel="stylesheet" href="https://lib.baomitu.com/github-markdown-css/4.0.0/github-markdown.min.css" />

  <link  rel="stylesheet" href="https://lib.baomitu.com/hint.css/2.7.0/hint.min.css" />

  <link  rel="stylesheet" href="https://lib.baomitu.com/fancybox/3.5.7/jquery.fancybox.min.css" />

  <link  rel="stylesheet" href="https://lib.baomitu.com/KaTeX/0.16.2/katex.min.css" />



<!-- 主题依赖的图标库，不要自行修改 -->
<!-- Do not modify the link that theme dependent icons -->

<link rel="stylesheet" href="//at.alicdn.com/t/c/font_1749284_5i9bdhy70f8.css">



<link rel="stylesheet" href="//at.alicdn.com/t/font_1736178_lbnruvf0jn.css">


<link  rel="stylesheet" href="/css/main.css" />


  <link id="highlight-css" rel="stylesheet" href="/css/highlight.css" />
  
    <link id="highlight-css-dark" rel="stylesheet" href="/css/highlight-dark.css" />
  



  
<link rel="stylesheet" href="//at.alicdn.com/t/c/font_4789608_0mu4sl00qiuq.css">



  <script id="fluid-configs">
    var Fluid = window.Fluid || {};
    Fluid.ctx = Object.assign({}, Fluid.ctx)
    var CONFIG = {"hostname":"kayce.world","root":"/","version":"1.9.8","typing":{"enable":true,"typeSpeed":70,"cursorChar":"_","loop":false,"scope":[]},"anchorjs":{"enable":true,"element":"h1,h2,h3,h4,h5,h6","placement":"left","visible":"hover","icon":""},"progressbar":{"enable":true,"height_px":3,"color":"#29d","options":{"showSpinner":false,"trickleSpeed":100}},"code_language":{"enable":false,"default":"TEXT"},"copy_btn":true,"image_caption":{"enable":true},"image_zoom":{"enable":true,"img_url_replace":["",""]},"toc":{"enable":true,"placement":"right","headingSelector":"h1,h2,h3,h4,h5,h6","collapseDepth":0},"lazyload":{"enable":true,"loading_img":"/img/loading.gif","onlypost":false,"offset_factor":2},"web_analytics":{"enable":true,"follow_dnt":true,"baidu":null,"google":null,"tencent":{"sid":null,"cid":null},"leancloud":{"app_id":null,"app_key":null,"server_url":null,"path":"window.location.pathname","ignore_local":false},"umami":{"src":null,"website_id":null,"domains":null,"start_time":"2024-01-01T00:00:00.000Z","token":null,"api_server":null},"gtag":null,"woyaola":null,"cnzz":null},"search_path":"/local-search.xml","include_content_in_search":true};

    if (CONFIG.web_analytics.follow_dnt) {
      var dntVal = navigator.doNotTrack || window.doNotTrack || navigator.msDoNotTrack;
      Fluid.ctx.dnt = dntVal && (dntVal.startsWith('1') || dntVal.startsWith('yes') || dntVal.startsWith('on'));
    }
  </script>
  <script  src="/js/utils.js" ></script>
  <script  src="/js/color-schema.js" ></script>
  

  

  

  

  

  



  
<meta name="generator" content="Hexo 7.3.0"></head>


<body>
  

  <header>
    

<div class="header-inner" style="height: 70vh;">
  <nav id="navbar" class="navbar fixed-top  navbar-expand-lg navbar-dark scrolling-navbar">
  <div class="container">
    <a class="navbar-brand" href="/">
      <strong>kayce&#39;s world</strong>
    </a>

    <button id="navbar-toggler-btn" class="navbar-toggler" type="button" data-toggle="collapse"
            data-target="#navbarSupportedContent"
            aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
      <div class="animated-icon"><span></span><span></span><span></span></div>
    </button>

    <!-- Collapsible content -->
    <div class="collapse navbar-collapse" id="navbarSupportedContent">
      <ul class="navbar-nav ml-auto text-center">
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/" target="_self">
                <i class="iconfont icon-home-fill"></i>
                <span>Home</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/archives/" target="_self">
                <i class="iconfont icon-archive-fill"></i>
                <span>Archives</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/categories/" target="_self">
                <i class="iconfont icon-category-fill"></i>
                <span>Categories</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/tags/" target="_self">
                <i class="iconfont icon-tags-fill"></i>
                <span>Tags</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/music/" target="_self">
                <i class="iconfont icon-music"></i>
                <span>Music</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/about/" target="_self">
                <i class="iconfont icon-user-fill"></i>
                <span>About</span>
              </a>
            </li>
          
        
        
          <li class="nav-item" id="search-btn">
            <a class="nav-link" target="_self" href="javascript:;" data-toggle="modal" data-target="#modalSearch" aria-label="Search">
              <i class="iconfont icon-search"></i>
            </a>
          </li>
          
        
        
          <li class="nav-item" id="color-toggle-btn">
            <a class="nav-link" target="_self" href="javascript:;" aria-label="Color Toggle">
              <i class="iconfont icon-dark" id="color-toggle-icon"></i>
            </a>
          </li>
        
      </ul>
    </div>
  </div>
</nav>

  

<div id="banner" class="banner" parallax=true
     style="background: url('/img/RanchoNight_16_Tree.png') no-repeat center center; background-size: cover;">
  <div class="full-bg-img">
    <div class="mask flex-center" style="background-color: rgba(0, 0, 0, 0.3)">
      <div class="banner-text text-center fade-in-up">
        <div class="h2">
          
            <span id="subtitle" data-typed-text="一种基于数据库的分布式锁设计"></span>
          
        </div>

        
          
  <div class="mt-3">
    
      <span class="post-meta mr-2">
        <i class="iconfont icon-author" aria-hidden="true"></i>
        kayce
      </span>
    
    
      <span class="post-meta">
        <i class="iconfont icon-date-fill" aria-hidden="true"></i>
        <time datetime="2023-11-16 11:13" pubdate>
          November 16, 2023 am
        </time>
      </span>
    
  </div>

  <div class="mt-1">
    

    

    
    
      
        <span id="busuanzi_container_page_pv" style="display: none">
          <i class="iconfont icon-eye" aria-hidden="true"></i>
          <span id="busuanzi_value_page_pv"></span> views
        </span>
        

      
    
  </div>


        
      </div>

      
    </div>
  </div>
</div>

</div>

  </header>

  <main>
    
      

<div class="container-fluid nopadding-x">
  <div class="row nomargin-x">
    <div class="side-col d-none d-lg-block col-lg-2">
      

    </div>

    <div class="col-lg-8 nopadding-x-md">
      <div class="container nopadding-x-md" id="board-ctn">
        <div id="board">
          <article class="post-content mx-auto">
            <h1 id="seo-header">一种基于数据库的分布式锁设计</h1>
            
              <p id="updated-time" class="note note-info" style="">
                
                  
                    Last updated on November 16, 2023 pm
                  
                
              </p>
            
            
              <div class="markdown-body">
                
                <blockquote>
<p>在并发场景中，我们经常使用锁来解决数据的共享问题，但语言标准库中的锁往往只能应用于单机的场景，因为多实例部署的场景下，一个实例并不能获取到另一个实例内存中构建的锁。</p>
</blockquote>
<h2 id="分布式锁">分布式锁</h2>
<p>简单来说，分布式锁一般会额外引入一个“中心化的节点”，让所有服务实例都向它请求锁，这样一来实例与实例之间就能通过这个中心化的节点来进行通信了。</p>
<p>上面提到的“中心化节点”的选型有很多种选择，在业内比较常见的有 Redis / ZooKeeper / 数据库等，本文介绍一种基于数据库的分布式锁设计，数据库本身的选型没有标准的答案，理论上来说只要支持唯一索引（Unique Index）的数据库都符合选型标准，例如常见的 MySQL 和 MongoDB。</p>
<p>为什么需要唯一索引？因为支持了唯一索引的数据库都具备以下的能力（不考虑硬件故障等意外情况）：</p>
<p><u><strong>多个并发请求同时向数据库插入唯一键相同的记录时，只有一个请求能够成功。</strong></u>并且失败的请求往往能够识别出失败的原因是来自竞争，例如 <code>Duplicate Key Error</code>。</p>
<p>可以看到，唯一索引的表现和语言标准库中的锁非常一致。</p>
<h2 id="数据库表结构设计">数据库表结构设计</h2>
<div class="code-wrapper"><pre><code class="hljs go"><span class="hljs-keyword">type</span> PLock <span class="hljs-keyword">struct</span> &#123;
	ID       <span class="hljs-type">string</span> <span class="hljs-comment">// 数据库主键</span>
	Key      <span class="hljs-type">string</span> <span class="hljs-comment">// 锁定的 key, 与 BizType 组成 uniq key</span>
	Val      <span class="hljs-type">string</span> <span class="hljs-comment">// 锁的 value, 可以是业务相关的自定义数据</span>
	BizType  <span class="hljs-type">string</span> <span class="hljs-comment">// 锁的类型, 与 Key 组成 uniq key</span>
	ExpireAt <span class="hljs-type">int64</span>  <span class="hljs-comment">// 过期时间</span>
&#125;</code></pre></div>
<p>这里为了阅读体验，我们将数据库表结构设计的尽量精简，实际情况中可以根据业务需要自行修改表结构。</p>
<p>上面可以看出，我们使用 <code>BizType</code> 和 <code>Key</code> 组成了一个唯一索引 <code>(BizType, Key)</code>，然后添加了两个额外的字段 <code>Val</code> / <code>ExpireAt</code> 来存储锁的额外信息。</p>
<h2 id="加解锁流程设计">加解锁流程设计</h2>
<p>有了基本的表结构后，我们接下来需要考虑如何基于这张表来实现加解锁的流程。我们在开始前不妨先思考清楚我们想要实现的功能是什么，从业务的角度出发不难得到下面的流程图：</p>
<pre><code class=" mermaid">flowchart LR
db(Database.PLock)
p1(Proc1)
p2(Proc2)
p3(Proc3)
p1 --Lock---&gt; db
p2 --Lock---&gt; db
p3 --Lock---&gt; db
db --Result---&gt; res(Proc3 Wins!!!)
res --&gt; do1(Proc1 quit)
res --&gt; do2(Proc2 quit)
res --&gt; do3(Proc3 continue)
do3 --&gt; ok(job success)
do3 --&gt; err(job failed)
ok --&gt; e(end)
err --&gt; e
e --Unlock--&gt; db</code></pre>
<p>可以看到，我们至少需要两个接口：<code>Lock</code> / <code>Unlock</code>，同时，为了实现一个比较完备的组件，我们在运行过程中可能还需要获取一些别的信息，最终我们将一个“选举器”整理为如下的接口：</p>
<div class="code-wrapper"><pre><code class="hljs go"><span class="hljs-comment">// Elect, 选举器接口, 确保多实例部署情况下在同一时刻, 同一 key 只有一个实例在运行对应任务</span>
<span class="hljs-keyword">type</span> Elect <span class="hljs-keyword">interface</span> &#123;
	<span class="hljs-comment">// Lock, 锁定 key 并运行 cb, 通过 cb 传入的 context 可以用于监听任务的取消信号</span>
	<span class="hljs-comment">// 因此 cb 内部实现应当处理 ctx.Done() 信号, 以便在任务取消时及时退出</span>
	<span class="hljs-comment">// 仅当锁定成功时, 才会运行 cb 并返回 true</span>
	<span class="hljs-comment">// 其余情况均返回 false, 如有错误, 则返回错误</span>
	Lock(key <span class="hljs-type">string</span>, cb <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">(ctx context.Context)</span></span>) (ok <span class="hljs-type">bool</span>, err <span class="hljs-type">error</span>)

	<span class="hljs-comment">// Unlock, 解锁 key 并取消运行中的任务</span>
	Unlock(key <span class="hljs-type">string</span>) (err <span class="hljs-type">error</span>)

	<span class="hljs-comment">// HoldingKeys, 返回当前持有的所有 key</span>
	HoldingKeys() []<span class="hljs-type">string</span>

	<span class="hljs-comment">// LockedKeys, 返回当前被锁定的所有 key</span>
	<span class="hljs-comment">// 注意和 HoldingKeys 的区别, HoldingKeys 只返回当前实例持有的 key,</span>
	<span class="hljs-comment">// 而 LockedKeys 返回所有实例持有的 key, 一般从数据库中查询得知</span>
	LockedKeys() ([]<span class="hljs-type">string</span>, <span class="hljs-type">error</span>)

	<span class="hljs-comment">// Close 优雅退出</span>
	Close()
&#125;</code></pre></div>
<p>接口定义的方法也比较简洁，需要实现的具体功能见代码的注释即可。</p>
<p>但是我们不难发现，接口内定义的方法似乎没有覆盖到 <code>PLock</code> 表中全部的字段，尤其是唯一键中的 <code>BizType</code>—— 这里稍微解释一下，我个人的编码习惯会将其放入到实现类中去，这里给出一个基于 MongoDB 的实现：</p>
<div class="code-wrapper"><pre><code class="hljs go"><span class="hljs-comment">// mongoElect, 基于 MongoDB 的 Elect 实现, 字段含义见 MongoElectConfig</span>
<span class="hljs-keyword">type</span> mongoElect <span class="hljs-keyword">struct</span> &#123;
	bizType                          mongodb.PLockBizType
	holder                           <span class="hljs-type">string</span>
	holdDuration                     time.Duration
	refreshInterval, refreshDuration time.Duration

	mu           *sync.RWMutex
	runningTasks <span class="hljs-keyword">map</span>[<span class="hljs-type">string</span>]*lockedTask <span class="hljs-comment">// key: lock key, value: locked task</span>

	logger *logrus.Entry
&#125;

<span class="hljs-keyword">type</span> MongoElectConfig <span class="hljs-keyword">struct</span> &#123;
	<span class="hljs-comment">// BizType 业务类型</span>
	BizType mongodb.PLockBizType

	<span class="hljs-comment">// Holder 锁的持有者名称, 例如: 服务实例 ID</span>
	Holder <span class="hljs-type">string</span>

	<span class="hljs-comment">// HoldDuration 初始锁的持有时间, 例如: 任务执行时间</span>
	HoldDuration time.Duration

	<span class="hljs-comment">// RefreshInterval 锁的续期间隔, 例如: 任务执行时间的 1/3</span>
	RefreshInterval time.Duration

	<span class="hljs-comment">// RefreshDuration 锁的续期时间(以 now 为标准), 至少为 RefreshInterval 的 2 倍</span>
	RefreshDuration time.Duration
&#125;

<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">NewMongoElect</span><span class="hljs-params">(conf *MongoElectConfig)</span></span> Elect &#123;
	<span class="hljs-keyword">if</span> conf == <span class="hljs-literal">nil</span> &#123;
		<span class="hljs-built_in">panic</span>(<span class="hljs-string">&quot;conf must not be nil&quot;</span>)
	&#125;
	<span class="hljs-keyword">if</span> conf.BizType == <span class="hljs-string">&quot;&quot;</span> &#123;
		<span class="hljs-built_in">panic</span>(<span class="hljs-string">&quot;bizType must not be empty&quot;</span>)
	&#125;
	<span class="hljs-keyword">if</span> conf.Holder == <span class="hljs-string">&quot;&quot;</span> &#123;
		<span class="hljs-built_in">panic</span>(<span class="hljs-string">&quot;holder must not be empty&quot;</span>)
	&#125;
	<span class="hljs-keyword">if</span> conf.HoldDuration &lt;= <span class="hljs-number">0</span> &#123;
		<span class="hljs-built_in">panic</span>(<span class="hljs-string">&quot;holdDuration must be positive&quot;</span>)
	&#125;
	<span class="hljs-keyword">if</span> conf.RefreshInterval &lt;= <span class="hljs-number">0</span> &#123;
		<span class="hljs-built_in">panic</span>(<span class="hljs-string">&quot;refreshInterval must be positive&quot;</span>)
	&#125;
	<span class="hljs-keyword">if</span> conf.RefreshDuration &lt;= <span class="hljs-number">0</span> &#123;
		<span class="hljs-built_in">panic</span>(<span class="hljs-string">&quot;refreshDuration must be positive&quot;</span>)
	&#125;
	<span class="hljs-keyword">if</span> conf.RefreshDuration &lt; conf.RefreshInterval*<span class="hljs-number">2</span> &#123;
		<span class="hljs-built_in">panic</span>(<span class="hljs-string">&quot;refreshDuration must be greater than 2 * refreshInterval&quot;</span>)
	&#125;
	<span class="hljs-keyword">return</span> &amp;mongoElect&#123;
		bizType:         conf.BizType,
		holder:          conf.Holder,
		holdDuration:    conf.HoldDuration,
		refreshInterval: conf.RefreshInterval,
		refreshDuration: conf.RefreshDuration,
		mu:              <span class="hljs-built_in">new</span>(sync.RWMutex),
		runningTasks:    <span class="hljs-built_in">make</span>(<span class="hljs-keyword">map</span>[<span class="hljs-type">string</span>]*lockedTask),
		logger: logrus.WithFields(logrus.Fields&#123;
			<span class="hljs-string">&quot;bizType&quot;</span>:      conf.BizType,
			<span class="hljs-string">&quot;holder&quot;</span>:       conf.Holder,
			<span class="hljs-string">&quot;holdDuration&quot;</span>: conf.HoldDuration,
			<span class="hljs-string">&quot;refresh&quot;</span>:      fmt.Sprintf(<span class="hljs-string">&quot;%v/%v&quot;</span>, conf.RefreshInterval, conf.RefreshDuration),
			<span class="hljs-string">&quot;module&quot;</span>:       <span class="hljs-string">&quot;mongo_elect&quot;</span>,
		&#125;),
	&#125;
&#125;</code></pre></div>
<p>上面这个实现类实现的具体功能是：加锁时，初始设置好锁的过期时间为 <code>HoldDuration</code>，如果加锁成功，则开始运行任务，运行过程中每经过 <code>RefreshInterval</code> 的间隔，就把锁的过期时间延长为 <code>time.Now + RefreshDuration</code>，直到任务结束为止。</p>
<p>通过这种设计，我们可以“大致”保证<u><strong>在任务完成之前锁不会过期</strong></u>，因为我们会不断的进行 refresh 操作来延长锁的持有时间。当然如果想要让程序健壮地达到这个目标，我们需要引入更多的复杂性，仅仅依赖一个结构体的字段定义是不足以实现的。</p>
<p>接下来，我们开始实现加解锁的流程（接口中的其他方法比较简单，略过）：</p>
<div class="code-wrapper"><pre><code class="hljs go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(e *mongoElect)</span></span> Lock(key <span class="hljs-type">string</span>, cb <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">(context.Context)</span></span>) (ok <span class="hljs-type">bool</span>, err <span class="hljs-type">error</span>) &#123;
	e.mu.Lock()
	<span class="hljs-keyword">defer</span> e.mu.Unlock()

	<span class="hljs-comment">// 锁定成功后, 运行任务</span>
	<span class="hljs-keyword">defer</span> <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">()</span></span> &#123;
		<span class="hljs-keyword">if</span> ok &#123;
			e.logger.Infof(<span class="hljs-string">&quot;[Lock] elect success, key: %v&quot;</span>, key)
			task := e.runningTasks[key]
			<span class="hljs-keyword">if</span> task == <span class="hljs-literal">nil</span> &#123;
				<span class="hljs-built_in">panic</span>(<span class="hljs-string">&quot;[Lock] task not found after lock&quot;</span>)
			&#125;
			e.runTask(task, cb)
		&#125;
	&#125;()

	<span class="hljs-comment">// 预查询目标锁</span>
	lock, err := mongodb.PLockDAL.QueryByUniqKey(key, e.bizType)
	<span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> &#123;
		e.logger.WithError(err).Error(<span class="hljs-string">&quot;[Lock] elect failed with query error&quot;</span>)
		<span class="hljs-keyword">return</span>
	&#125;

	<span class="hljs-comment">// 目标锁不存在, 尝试创建</span>
	<span class="hljs-keyword">if</span> lock == <span class="hljs-literal">nil</span> &#123;
		isDup, err := e.createLock(key)
		<span class="hljs-keyword">return</span> err == <span class="hljs-literal">nil</span> &amp;&amp; !isDup, err
	&#125;

	<span class="hljs-comment">// 目标锁存在, 但已过期, 精确删除该锁后再尝试创建</span>
	<span class="hljs-keyword">if</span> lock.ExpireAt &lt; common.Millisec(time.Now()) &#123;
		e.logger.Warnf(<span class="hljs-string">&quot;[Lock] elect for an expired lock, try delete it, key: %v, lock: %v&quot;</span>, key, lock)
		<span class="hljs-keyword">if</span> err = mongodb.PLockDAL.DeleteByID(lock.ID); err != <span class="hljs-literal">nil</span> &#123;
			e.logger.WithError(err).Error(<span class="hljs-string">&quot;[Lock] elect failed with delete error&quot;</span>)
			<span class="hljs-keyword">return</span>
		&#125;
		isDup, err := e.createLock(key)
		<span class="hljs-keyword">return</span> err == <span class="hljs-literal">nil</span> &amp;&amp; !isDup, err
	&#125;

	<span class="hljs-comment">// 锁是自己创建的, 报错提示</span>
	<span class="hljs-keyword">if</span> lock.Value == e.holder &#123;
		<span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>, fmt.Errorf(<span class="hljs-string">&quot;lock of %s already owned&quot;</span>, key)
	&#125;

	<span class="hljs-comment">// 锁不是自己创建的, 返回失败</span>
	e.logger.WithFields(logrus.Fields&#123;
		<span class="hljs-string">&quot;key&quot;</span>:  key,
		<span class="hljs-string">&quot;lock&quot;</span>: lock,
	&#125;).Warn(<span class="hljs-string">&quot;[Lock] elect failed for already locked&quot;</span>)

	<span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>, <span class="hljs-literal">nil</span>
&#125;

<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(e *mongoElect)</span></span> createLock(key <span class="hljs-type">string</span>) (dup <span class="hljs-type">bool</span>, err <span class="hljs-type">error</span>) &#123;
	expireAt := common.Millisec(time.Now().Add(e.holdDuration))
	id, isDup, err := mongodb.PLockDAL.Create(key, e.holder, e.bizType, expireAt)
	e.logger.Infof(<span class="hljs-string">&quot;[createLock] elect result, key: %v, id: %v, err: %v&quot;</span>, key, id, err)
	<span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> &#123;
		<span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>, err
	&#125;

	<span class="hljs-keyword">if</span> isDup &#123;
		e.logger.Warnf(<span class="hljs-string">&quot;[createLock] elect failed for already locked, key: %v&quot;</span>, key)
		<span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>, <span class="hljs-literal">nil</span>
	&#125;

	<span class="hljs-keyword">if</span> id == <span class="hljs-literal">nil</span> &#123;
		err = fmt.Errorf(<span class="hljs-string">&quot;[createLock] elect failed for missing lock id, key: %v&quot;</span>, key)
		e.logger.WithError(err).Error(<span class="hljs-string">&quot;Unknown error&quot;</span>)
		<span class="hljs-keyword">return</span>
	&#125;

	<span class="hljs-comment">// 成功创建锁, 记录任务</span>
	task := defaultLockedTask(key)
	task.lockID = *id
	e.runningTasks[key] = task

	<span class="hljs-keyword">return</span>
&#125;

<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(e *mongoElect)</span></span> runTask(task *lockedTask, cb <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">(context.Context)</span></span>) &#123;
	refreshFn := <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">()</span></span> &#123;
		ticker := time.NewTicker(e.refreshInterval)
		lockID := task.lockID.(primitive.ObjectID)
		logger := e.logger.WithField(<span class="hljs-string">&quot;lockID&quot;</span>, lockID.String())

		<span class="hljs-keyword">for</span> &#123;
			<span class="hljs-keyword">select</span> &#123;
			<span class="hljs-keyword">case</span> &lt;-task.canceled():
				e.logger.Info(<span class="hljs-string">&quot;[refreshFn] refresh lock canceled&quot;</span>)
				ticker.Stop()
				e.safeCancelTask(task)
				<span class="hljs-keyword">return</span>

			<span class="hljs-keyword">case</span> &lt;-ticker.C:
				<span class="hljs-comment">// 查询锁</span>
				<span class="hljs-keyword">var</span> lock *mongodb.PLock
				<span class="hljs-keyword">for</span> &#123;
					<span class="hljs-keyword">var</span> err <span class="hljs-type">error</span>
					lock, err = mongodb.PLockDAL.QueryByID(lockID)
					<span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> &#123;
						logger.WithError(err).Error(<span class="hljs-string">&quot;[refreshFn] refresh lock failed with query error&quot;</span>)
						time.Sleep(time.Second)
						<span class="hljs-keyword">continue</span>
					&#125;
					<span class="hljs-keyword">break</span>
				&#125;

				nowTs := common.Millisec(time.Now())

				<span class="hljs-comment">// 锁不存在, 异常情况, 直接退出</span>
				<span class="hljs-comment">// 或者续期不及时, 已被其他实例抢占</span>
				<span class="hljs-keyword">if</span> lock == <span class="hljs-literal">nil</span> || lock.ExpireAt &lt; nowTs &#123;
					logger.Errorf(<span class="hljs-string">&quot;[refreshFn] refresh lock failed for lock not found, maybe released&quot;</span>)
					e.safeCancelTask(task)
					<span class="hljs-keyword">return</span>
				&#125;

				<span class="hljs-comment">// 正常续期</span>
				expireAt := common.Millisec(time.Now().Add(e.refreshDuration))
				e.logger.Infof(<span class="hljs-string">&quot;[refreshFn] refresh lock start, new expireAt: %v&quot;</span>, expireAt)
				<span class="hljs-keyword">if</span> err := mongodb.PLockDAL.UpdateExpireAtByID(lockID, expireAt); err != <span class="hljs-literal">nil</span> &#123;
					logger.WithError(err).Error(<span class="hljs-string">&quot;[refreshFn] refresh lock failed with update error&quot;</span>)
					<span class="hljs-comment">// 如果续期失败, 且距离过期时间不足 2 倍的 refresh interval, 则直接退出</span>
					<span class="hljs-comment">// 否则可能导致锁过期时, 任务还在执行</span>
					<span class="hljs-comment">// 其余情况暂时不管, 会在下次续期时重试</span>
					<span class="hljs-keyword">if</span> lock.ExpireAt-nowTs &lt; e.refreshInterval.Milliseconds()*<span class="hljs-number">2</span> &#123;
						logger.Error(<span class="hljs-string">&quot;[refreshFn] refresh lock failed for too late&quot;</span>)
						e.safeCancelTask(task)
						<span class="hljs-keyword">return</span>
					&#125;
				&#125;
				e.logger.Infof(<span class="hljs-string">&quot;[refreshFn] refresh lock success, new expireAt: %v&quot;</span>, expireAt)
			&#125;
		&#125;
	&#125;

	task.run(cb, refreshFn)
&#125;

<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(e *mongoElect)</span></span> safeCancelTask(task *lockedTask) &#123;
	e.mu.Lock()
	<span class="hljs-keyword">defer</span> e.mu.Unlock()
	e.cancelTask(task)
&#125;

<span class="hljs-comment">// WARN: 该方法需要在持有锁的情况下调用</span>
<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(e *mongoElect)</span></span> cancelTask(task *lockedTask) &#123;
	<span class="hljs-comment">// 先取消任务</span>
	task.cancelAndWait()
	lockID := task.lockID.(primitive.ObjectID)

	<span class="hljs-comment">// 再删除 db 锁, 重试直到成功</span>
	common.WithRetry(<span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">()</span></span> <span class="hljs-type">error</span> &#123;
		<span class="hljs-keyword">if</span> err := mongodb.PLockDAL.DeleteByID(lockID); err != <span class="hljs-literal">nil</span> &#123;
			e.logger.WithError(err).Error(<span class="hljs-string">&quot;[cancelTask] cancel task failed with delete error&quot;</span>)
			<span class="hljs-keyword">return</span> err
		&#125;
		<span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span>
	&#125;, <span class="hljs-number">-1</span>, time.Second)

	<span class="hljs-comment">// 最后删除任务</span>
	<span class="hljs-built_in">delete</span>(e.runningTasks, task.key())
&#125;</code></pre></div>
<p>上面的代码比较长，我们逐步进行解释（注，本文将省略数据库层面的代码）：</p>
<ol>
<li>加锁时，首先查询想要锁的唯一键是否存在
<ol>
<li>如果不存在，则直接进行加锁即可（可能会由于竞争而加锁失败）</li>
<li>如果存在，到 2</li>
</ol>
</li>
<li>目标锁存在，进一步检查其是否过期
<ol>
<li>如果过期了，则通过 id 字段精确删除这条锁记录后，再尝试创建</li>
<li>如果没有过期，是一把正常的锁，到 3</li>
</ol>
</li>
<li>目标锁正常，进一步检查这把锁的持有人是谁
<ol>
<li>如果是自己，则报错，这里我们暂不支持可重入</li>
<li>如果不是自己，也报错，说明加锁失败的原因</li>
</ol>
</li>
</ol>
<p>最后，我们回到开头就写好的 <code>defer</code> 函数，如果最终加锁的结果是成功的，则开始运行 <code>cb</code> 函数，上面代码中使用了一个封装好的 <code>lockedTask</code> 类型，具体实现我们放在下文展示，这里先继续关注运行的流程。</p>
<hr>
<p>可以看到，在 <code>runTask</code> 函数中，我们定义了一个 <code>refreshFn</code> 用于刷新锁的有效期，然后将这个 <code>refreshFn</code> 和业务的 <code>cb</code> 一起运行了，这里我们聚焦到刷新的逻辑上：</p>
<ol>
<li>
<p>监听 task 的退出信号</p>
<ol>
<li>如果退出了，说明 task 以及不再运行了，直接返回即可（当然我们冗余调用了一次 <code>safeCancelTask</code>，目的主要是将 task 从结构体维护的 <code>runningTask</code> 中清理出去）</li>
<li>如果没有退出，则到 2</li>
</ol>
</li>
<li>
<p>监听 ticker</p>
<p>前面我们提到了，我们的设计是每经过 A 时间，就续期 B 时间，所以依赖一个 ticker 来实现 A 的逻辑。</p>
<p>续期的逻辑如下：</p>
<p>a. 查询持有的锁记录，不存在或过期则直接调用 <code>safeCancelTask</code> 退出。（事实上，这种情况理论上不应存在，除非前置的查询由于 db 的问题不断重试，但为了以防万一还是写上了这段兜底的代码，具体原因见 b）</p>
<p>b. 锁存在且未过期的情况下，我们调用 Update 函数进行续期，失败时如下处理：</p>
<p>​ b.1. 如果 Update 失败，且锁的过期时间小于当前时间 + 2 倍的续期间隔，则直接中断</p>
<p>​ b.2. 否则暂时忽略，等待下一次续期重试</p>
<p>看到这里，我们应该能明白，为什么说续期时理论上不会发生锁记录不存在或锁过期的情况了，因为在续期过程中，即使续期的 Update 行为发生了错误，我们也会妥善的进行处理 —— 一旦发现锁临近过期，我们就会立即终止任务，防范于未然；如果锁过期时间较为久远，则容忍本次失败。</p>
</li>
</ol>
<hr>
<p>接下来看一看解锁的实现：</p>
<div class="code-wrapper"><pre><code class="hljs go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(e *mongoElect)</span></span> Unlock(key <span class="hljs-type">string</span>) <span class="hljs-type">error</span> &#123;
	e.mu.Lock()
	<span class="hljs-keyword">defer</span> e.mu.Unlock()

	task, ok := e.runningTasks[key]
	<span class="hljs-keyword">if</span> !ok &#123;
		<span class="hljs-keyword">return</span> fmt.Errorf(<span class="hljs-string">&quot;lock of %s not owned&quot;</span>, key)
	&#125;

	e.cancelTask(task)
	<span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span>
&#125;</code></pre></div>
<p>有了加锁的底子，解锁实现起来就比较简单了，只需要调用 <code>cancelTask</code> 方法即可。</p>
<hr>
<p>附：lockedTask 具体实现</p>
<div class="code-wrapper"><pre><code class="hljs go"><span class="hljs-keyword">type</span> lockedTask <span class="hljs-keyword">struct</span> &#123;
	ctx    context.Context
	cancel context.CancelFunc

	lockKey <span class="hljs-type">string</span>
	lockID  any

	doneCh  <span class="hljs-keyword">chan</span> <span class="hljs-keyword">struct</span>&#123;&#125;
	runOnce *sync.Once
&#125;

<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">defaultLockedTask</span><span class="hljs-params">(key <span class="hljs-type">string</span>)</span></span> *lockedTask &#123;
	ctx, cancel := context.WithCancel(context.Background())
	<span class="hljs-keyword">return</span> &amp;lockedTask&#123;
		ctx:     ctx,
		cancel:  cancel,
		lockKey: key,
		doneCh:  <span class="hljs-built_in">make</span>(<span class="hljs-keyword">chan</span> <span class="hljs-keyword">struct</span>&#123;&#125;),
		runOnce: <span class="hljs-built_in">new</span>(sync.Once),
	&#125;
&#125;

<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(lt *lockedTask)</span></span> run(cb <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">(context.Context)</span></span>, refresh <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">()</span></span>) &#123;
	lt.runOnce.Do(<span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">()</span></span> &#123;
		<span class="hljs-comment">// 后台运行任务</span>
		<span class="hljs-keyword">go</span> <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">()</span></span> &#123;
			cb(lt.ctx)
			<span class="hljs-built_in">close</span>(lt.doneCh)
			lt.cancel()
			log.WithFields(logrus.Fields&#123;
				<span class="hljs-string">&quot;lockKey&quot;</span>: lt.lockKey,
				<span class="hljs-string">&quot;lockID&quot;</span>:  lt.lockID,
			&#125;).Info(<span class="hljs-string">&quot;locked task done&quot;</span>)
		&#125;()

		<span class="hljs-comment">// 后台刷新锁有效期</span>
		<span class="hljs-keyword">go</span> refresh()
	&#125;)
&#125;

<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(lt *lockedTask)</span></span> cancelAndWait() &#123;
	lt.cancel()
	&lt;-lt.doneCh
&#125;

<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(lt *lockedTask)</span></span> canceled() &lt;-<span class="hljs-keyword">chan</span> <span class="hljs-keyword">struct</span>&#123;&#125; &#123;
	<span class="hljs-keyword">return</span> lt.ctx.Done()
&#125;

<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(lt *lockedTask)</span></span> key() <span class="hljs-type">string</span> &#123;
	<span class="hljs-keyword">return</span> lt.lockKey
&#125;</code></pre></div>
<p>不难看出，<code>lockedTask</code> 类型主要是封装了业务任务的执行流程，为其添加了基于 <code>context.Context</code> 的中断控制以及刷新锁的有效期的方法。</p>
<hr>
<p>最终我们得到的选举器的工作过程大致如下图所示：</p>
<p><img src="/img/simple_db_lock/p1.png" srcset="/img/loading.gif" lazyload alt="流程图"></p>
<h2 id="结尾">结尾</h2>
<p>结束了吗？还没有，即使我们实现了一个 <code>Elect</code> 接口，我们仍需要考虑一个问题：调用方应该怎样合理的进行调用？</p>
<p>我在实际工作中遇到过这样的需求：一个服务的多实例同时启动后，均匀的让每个实例处理同一个类型的不同任务。比如说，这个服务需要订阅 100 个消息队列的 topic，我将部署 10 台实例，在他们启动后，让这 100 个订阅任务均匀的分配到这些实例上去。</p>
<p>此时，我们在应用层也有许多工作要做，例如：</p>
<ol>
<li>限制每个实例最多处理的任务数量，在本例中可以是 20 （此时允许有 5 台实例挂掉，剩下 5 台实例可以接管）。</li>
<li>启动异步的监控协程，监控有哪些任务没有实例在处理，一旦发现则尝试抢占对应任务的锁并接管。</li>
</ol>
<p>总而言之，本文实现了一个与业务无关的中间组件，目的是向大家展示分布式系统下复杂的情况以及我们可能的处理方式，希望能对读者有所启发。</p>
<p>如何将程序写得更为健壮一直是计算机领域内的一大难题，我们可以针对不同的场景对其需要的健壮性进行合理评估。对于很多不重要的场景而言，将代码实现得无比健壮也许是浪费时间的，例如，我也会在很多场景下简单地使用 redis 中的 <code>set nx ex</code> 指令来充当一个简单的分布式锁，但对于很多重要的场景而言（例如银行、电商），这种方式往往都是不可取的。</p>

                
              </div>
            
            <hr/>
            <div>
              <div class="post-metas my-3">
  
    <div class="post-meta mr-3 d-flex align-items-center">
      <i class="iconfont icon-category"></i>
      

<span class="category-chains">
  
  
    
      <span class="category-chain">
        
  <a href="/categories/tech/" class="category-chain-item">tech</a>
  
  

      </span>
    
  
</span>

    </div>
  
  
    <div class="post-meta">
      <i class="iconfont icon-tags"></i>
      
        <a href="/tags/Golang/" class="print-no-link">#Golang</a>
      
        <a href="/tags/Database/" class="print-no-link">#Database</a>
      
    </div>
  
</div>


              
  

  <div class="license-box my-3">
    <div class="license-title">
      <div>一种基于数据库的分布式锁设计</div>
      <div>https://kayce.world/tech/simple_db_lock/</div>
    </div>
    <div class="license-meta">
      
        <div class="license-meta-item">
          <div>Author</div>
          <div>kayce</div>
        </div>
      
      
        <div class="license-meta-item license-meta-date">
          <div>Posted on</div>
          <div>November 16, 2023</div>
        </div>
      
      
        <div class="license-meta-item license-meta-date">
          <div>Updated on</div>
          <div>November 16, 2023</div>
        </div>
      
      
        <div class="license-meta-item">
          <div>Licensed under</div>
          <div>
            
              
              
                <a class="print-no-link" target="_blank" href="https://creativecommons.org/licenses/by-nc-sa/4.0/">
                  <span class="hint--top hint--rounded" aria-label="BY - Attribution">
                    <i class="iconfont icon-cc-by"></i>
                  </span>
                </a>
              
                <a class="print-no-link" target="_blank" href="https://creativecommons.org/licenses/by-nc-sa/4.0/">
                  <span class="hint--top hint--rounded" aria-label="NC - Non-commercial">
                    <i class="iconfont icon-cc-nc"></i>
                  </span>
                </a>
              
                <a class="print-no-link" target="_blank" href="https://creativecommons.org/licenses/by-nc-sa/4.0/">
                  <span class="hint--top hint--rounded" aria-label="SA - Share-alike">
                    <i class="iconfont icon-cc-sa"></i>
                  </span>
                </a>
              
            
          </div>
        </div>
      
    </div>
    <div class="license-icon iconfont"></div>
  </div>



              
                <div class="post-prevnext my-3">
                  <article class="post-prev col-6">
                    
                    
                      <a href="/imagination/gods_currency/" title="「胡思乱想」：马克思的货币与神造的 BTC">
                        <i class="iconfont icon-arrowleft"></i>
                        <span class="hidden-mobile">「胡思乱想」：马克思的货币与神造的 BTC</span>
                        <span class="visible-mobile">Previous</span>
                      </a>
                    
                  </article>
                  <article class="post-next col-6">
                    
                    
                      <a href="/chores/analyze_stocks/" title="从「股市」App 看股市">
                        <span class="hidden-mobile">从「股市」App 看股市</span>
                        <span class="visible-mobile">Next</span>
                        <i class="iconfont icon-arrowright"></i>
                      </a>
                    
                  </article>
                </div>
              
            </div>

            
  
  
    <article id="comments" lazyload>
      
  <div id="gitalk-container"></div>
  <script type="text/javascript">
    Fluid.utils.loadComments('#gitalk-container', function() {
      Fluid.utils.createCssLink('/css/gitalk.css')
      Fluid.utils.createScript('https://lib.baomitu.com/gitalk/1.8.0/gitalk.min.js', function() {
        var options = Object.assign(
          {"clientID":"b25aa0a3d88c5fc4dbeb","clientSecret":"485e76d306112a519d43b4118efa8971c3ff6069","repo":"sshelll.github.io","owner":"sshelll","admin":["sshelll"],"language":"en-US","labels":["Gitalk"],"perPage":10,"pagerDirection":"last","distractionFreeMode":false,"createIssueManually":true,"proxy":"https://cors-anywhere.azm.workers.dev/https://github.com/login/oauth/access_token"},
          {
            id: '8cb1cd1653d9ccaa728ffd311178dfd1'
          }
        )
        var gitalk = new Gitalk(options);
        gitalk.render('gitalk-container');
      });
    });
  </script>
  <noscript>Please enable JavaScript to view the comments</noscript>


    </article>
  


          </article>
        </div>
      </div>
    </div>

    <div class="side-col d-none d-lg-block col-lg-2">
      
  <aside class="sidebar" style="margin-left: -1rem">
    <div id="toc">
  <p class="toc-header">
    <i class="iconfont icon-list"></i>
    <span>Table of Contents</span>
  </p>
  <div class="toc-body" id="toc-body"></div>
</div>



  </aside>


    </div>
  </div>
</div>





  



  



  



  



  


  
  




  <script>
  Fluid.utils.createScript('https://lib.baomitu.com/mermaid/8.14.0/mermaid.min.js', function() {
    mermaid.initialize({"theme":"default"});

    Fluid.utils.listenDOMLoaded(function() {
      Fluid.events.registerRefreshCallback(function() {
        if ('mermaid' in window) {
          mermaid.init();
        }
      });
    });
  });
</script>






    

    
      <a id="scroll-top-button" aria-label="TOP" href="#" role="button">
        <i class="iconfont icon-arrowup" aria-hidden="true"></i>
      </a>
    

    
      <div class="modal fade" id="modalSearch" tabindex="-1" role="dialog" aria-labelledby="ModalLabel"
     aria-hidden="true">
  <div class="modal-dialog modal-dialog-scrollable modal-lg" role="document">
    <div class="modal-content">
      <div class="modal-header text-center">
        <h4 class="modal-title w-100 font-weight-bold">Search</h4>
        <button type="button" id="local-search-close" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body mx-3">
        <div class="md-form mb-5">
          <input type="text" id="local-search-input" class="form-control validate">
          <label data-error="x" data-success="v" for="local-search-input">Keyword</label>
        </div>
        <div class="list-group" id="local-search-result"></div>
      </div>
    </div>
  </div>
</div>

    

    
  </main>

  <footer>
    <div class="footer-inner">
  
    <div class="footer-content">
      <a>kayce</a>
    </div>
  
  
    <div class="statistics">
  
  

  
    
      <span id="busuanzi_container_site_pv" style="display: none">
        Views: 
        <span id="busuanzi_value_site_pv"></span>
        
      </span>
    
    
      <span id="busuanzi_container_site_uv" style="display: none">
        Visitors: 
        <span id="busuanzi_value_site_uv"></span>
        
      </span>
    
    

  

</div>

  
  
</div>

  </footer>

  <!-- Scripts -->
  
  <script  src="https://lib.baomitu.com/nprogress/0.2.0/nprogress.min.js" ></script>
  <link  rel="stylesheet" href="https://lib.baomitu.com/nprogress/0.2.0/nprogress.min.css" />

  <script>
    NProgress.configure({"showSpinner":false,"trickleSpeed":100})
    NProgress.start()
    window.addEventListener('load', function() {
      NProgress.done();
    })
  </script>


<script  src="https://lib.baomitu.com/jquery/3.6.0/jquery.min.js" ></script>
<script  src="https://lib.baomitu.com/twitter-bootstrap/4.6.1/js/bootstrap.min.js" ></script>
<script  src="/js/events.js" ></script>
<script  src="/js/plugins.js" ></script>


  <script  src="https://lib.baomitu.com/typed.js/2.0.12/typed.min.js" ></script>
  <script>
    (function (window, document) {
      var typing = Fluid.plugins.typing;
      var subtitle = document.getElementById('subtitle');
      if (!subtitle || !typing) {
        return;
      }
      var text = subtitle.getAttribute('data-typed-text');
      
        typing(text);
      
    })(window, document);
  </script>




  
    <script  src="/js/img-lazyload.js" ></script>
  




  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/tocbot/4.18.2/tocbot.min.js', function() {
    var toc = jQuery('#toc');
    if (toc.length === 0 || !window.tocbot) { return; }
    var boardCtn = jQuery('#board-ctn');
    var boardTop = boardCtn.offset().top;

    window.tocbot.init(Object.assign({
      tocSelector     : '#toc-body',
      contentSelector : '.markdown-body',
      linkClass       : 'tocbot-link',
      activeLinkClass : 'tocbot-active-link',
      listClass       : 'tocbot-list',
      isCollapsedClass: 'tocbot-is-collapsed',
      collapsibleClass: 'tocbot-is-collapsible',
      scrollSmooth    : true,
      includeTitleTags: true,
      headingsOffset  : -boardTop,
    }, CONFIG.toc));
    if (toc.find('.toc-list-item').length > 0) {
      toc.css('visibility', 'visible');
    }

    Fluid.events.registerRefreshCallback(function() {
      if ('tocbot' in window) {
        tocbot.refresh();
        var toc = jQuery('#toc');
        if (toc.length === 0 || !tocbot) {
          return;
        }
        if (toc.find('.toc-list-item').length > 0) {
          toc.css('visibility', 'visible');
        }
      }
    });
  });
</script>


  <script src=https://lib.baomitu.com/clipboard.js/2.0.11/clipboard.min.js></script>

  <script>Fluid.plugins.codeWidget();</script>


  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/anchor-js/4.3.1/anchor.min.js', function() {
    window.anchors.options = {
      placement: CONFIG.anchorjs.placement,
      visible  : CONFIG.anchorjs.visible
    };
    if (CONFIG.anchorjs.icon) {
      window.anchors.options.icon = CONFIG.anchorjs.icon;
    }
    var el = (CONFIG.anchorjs.element || 'h1,h2,h3,h4,h5,h6').split(',');
    var res = [];
    for (var item of el) {
      res.push('.markdown-body > ' + item.trim());
    }
    if (CONFIG.anchorjs.placement === 'left') {
      window.anchors.options.class = 'anchorjs-link-left';
    }
    window.anchors.add(res.join(', '));

    Fluid.events.registerRefreshCallback(function() {
      if ('anchors' in window) {
        anchors.removeAll();
        var el = (CONFIG.anchorjs.element || 'h1,h2,h3,h4,h5,h6').split(',');
        var res = [];
        for (var item of el) {
          res.push('.markdown-body > ' + item.trim());
        }
        if (CONFIG.anchorjs.placement === 'left') {
          anchors.options.class = 'anchorjs-link-left';
        }
        anchors.add(res.join(', '));
      }
    });
  });
</script>


  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/fancybox/3.5.7/jquery.fancybox.min.js', function() {
    Fluid.plugins.fancyBox();
  });
</script>


  <script>Fluid.plugins.imageCaption();</script>

  <script  src="/js/local-search.js" ></script>

  <script defer src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js" ></script>





<!-- 主题的启动项，将它保持在最底部 -->
<!-- the boot of the theme, keep it at the bottom -->
<script  src="/js/boot.js" ></script>


  

  <noscript>
    <div class="noscript-warning">Blog works best with JavaScript enabled</div>
  </noscript>
</body>
</html>

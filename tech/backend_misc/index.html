

<!DOCTYPE html>
<html lang="en" data-default-color-scheme=auto>



<head>
  <meta charset="UTF-8">

  <link rel="apple-touch-icon" sizes="76x76" href="/img/morty.jpeg">
  <link rel="icon" href="/img/morty.jpeg">
  

  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, shrink-to-fit=no">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  
  <meta name="theme-color" content="#2f4154">
  <meta name="author" content="kayce">
  <meta name="keywords" content="">
  
    <meta name="description" content="WIP FOEVER">
<meta property="og:type" content="article">
<meta property="og:title" content="Backend Misc">
<meta property="og:url" content="https://kayce.world/tech/backend_misc/index.html">
<meta property="og:site_name" content="kayce">
<meta property="og:description" content="WIP FOEVER">
<meta property="og:locale" content="en_US">
<meta property="article:published_time" content="2024-12-30T13:38:27.000Z">
<meta property="article:modified_time" content="2025-04-14T08:19:00.000Z">
<meta property="article:author" content="kayce">
<meta property="article:tag" content="Backend">
<meta property="article:tag" content="Misc">
<meta name="twitter:card" content="summary_large_image">
  
  
    <meta name="referrer" content="no-referrer-when-downgrade">
  
  
  <title>Backend Misc - kayce</title>

  <link  rel="stylesheet" href="https://lib.baomitu.com/twitter-bootstrap/4.6.1/css/bootstrap.min.css" />



  <link  rel="stylesheet" href="https://lib.baomitu.com/github-markdown-css/4.0.0/github-markdown.min.css" />

  <link  rel="stylesheet" href="https://lib.baomitu.com/hint.css/2.7.0/hint.min.css" />

  <link  rel="stylesheet" href="https://lib.baomitu.com/fancybox/3.5.7/jquery.fancybox.min.css" />

  <link  rel="stylesheet" href="https://lib.baomitu.com/KaTeX/0.16.2/katex.min.css" />



<!-- 主题依赖的图标库，不要自行修改 -->
<!-- Do not modify the link that theme dependent icons -->

<link rel="stylesheet" href="//at.alicdn.com/t/c/font_1749284_5i9bdhy70f8.css">



<link rel="stylesheet" href="//at.alicdn.com/t/font_1736178_lbnruvf0jn.css">


<link  rel="stylesheet" href="/css/main.css" />


  <link id="highlight-css" rel="stylesheet" href="/css/highlight.css" />
  
    <link id="highlight-css-dark" rel="stylesheet" href="/css/highlight-dark.css" />
  



  
<link rel="stylesheet" href="//at.alicdn.com/t/c/font_4789608_0mu4sl00qiuq.css">



  <script id="fluid-configs">
    var Fluid = window.Fluid || {};
    Fluid.ctx = Object.assign({}, Fluid.ctx)
    var CONFIG = {"hostname":"kayce.world","root":"/","version":"1.9.8","typing":{"enable":true,"typeSpeed":70,"cursorChar":"_","loop":false,"scope":[]},"anchorjs":{"enable":true,"element":"h1,h2,h3,h4,h5,h6","placement":"left","visible":"hover","icon":""},"progressbar":{"enable":true,"height_px":3,"color":"#29d","options":{"showSpinner":false,"trickleSpeed":100}},"code_language":{"enable":false,"default":"TEXT"},"copy_btn":true,"image_caption":{"enable":true},"image_zoom":{"enable":true,"img_url_replace":["",""]},"toc":{"enable":true,"placement":"right","headingSelector":"h1,h2,h3,h4,h5,h6","collapseDepth":0},"lazyload":{"enable":true,"loading_img":"/img/loading.gif","onlypost":false,"offset_factor":2},"web_analytics":{"enable":true,"follow_dnt":true,"baidu":null,"google":null,"tencent":{"sid":null,"cid":null},"leancloud":{"app_id":null,"app_key":null,"server_url":null,"path":"window.location.pathname","ignore_local":false},"umami":{"src":null,"website_id":null,"domains":null,"start_time":"2024-01-01T00:00:00.000Z","token":null,"api_server":null},"gtag":null,"woyaola":null,"cnzz":null},"search_path":"/local-search.xml","include_content_in_search":true};

    if (CONFIG.web_analytics.follow_dnt) {
      var dntVal = navigator.doNotTrack || window.doNotTrack || navigator.msDoNotTrack;
      Fluid.ctx.dnt = dntVal && (dntVal.startsWith('1') || dntVal.startsWith('yes') || dntVal.startsWith('on'));
    }
  </script>
  <script  src="/js/utils.js" ></script>
  <script  src="/js/color-schema.js" ></script>
  

  

  

  

  

  



  
<meta name="generator" content="Hexo 7.3.0"></head>


<body>
  

  <header>
    

<div class="header-inner" style="height: 70vh;">
  <nav id="navbar" class="navbar fixed-top  navbar-expand-lg navbar-dark scrolling-navbar">
  <div class="container">
    <a class="navbar-brand" href="/">
      <strong>kayce&#39;s world</strong>
    </a>

    <button id="navbar-toggler-btn" class="navbar-toggler" type="button" data-toggle="collapse"
            data-target="#navbarSupportedContent"
            aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
      <div class="animated-icon"><span></span><span></span><span></span></div>
    </button>

    <!-- Collapsible content -->
    <div class="collapse navbar-collapse" id="navbarSupportedContent">
      <ul class="navbar-nav ml-auto text-center">
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/" target="_self">
                <i class="iconfont icon-home-fill"></i>
                <span>Home</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/archives/" target="_self">
                <i class="iconfont icon-archive-fill"></i>
                <span>Archives</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/categories/" target="_self">
                <i class="iconfont icon-category-fill"></i>
                <span>Categories</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/tags/" target="_self">
                <i class="iconfont icon-tags-fill"></i>
                <span>Tags</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/music/" target="_self">
                <i class="iconfont icon-music"></i>
                <span>Music</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/about/" target="_self">
                <i class="iconfont icon-user-fill"></i>
                <span>About</span>
              </a>
            </li>
          
        
        
          <li class="nav-item" id="search-btn">
            <a class="nav-link" target="_self" href="javascript:;" data-toggle="modal" data-target="#modalSearch" aria-label="Search">
              <i class="iconfont icon-search"></i>
            </a>
          </li>
          
        
        
          <li class="nav-item" id="color-toggle-btn">
            <a class="nav-link" target="_self" href="javascript:;" aria-label="Color Toggle">
              <i class="iconfont icon-dark" id="color-toggle-icon"></i>
            </a>
          </li>
        
      </ul>
    </div>
  </div>
</nav>

  

<div id="banner" class="banner" parallax=true
     style="background: url('/img/RanchoNight_16_Tree.png') no-repeat center center; background-size: cover;">
  <div class="full-bg-img">
    <div class="mask flex-center" style="background-color: rgba(0, 0, 0, 0.3)">
      <div class="banner-text text-center fade-in-up">
        <div class="h2">
          
            <span id="subtitle" data-typed-text="Backend Misc"></span>
          
        </div>

        
          
  <div class="mt-3">
    
      <span class="post-meta mr-2">
        <i class="iconfont icon-author" aria-hidden="true"></i>
        kayce
      </span>
    
    
      <span class="post-meta">
        <i class="iconfont icon-date-fill" aria-hidden="true"></i>
        <time datetime="2024-12-30 21:38" pubdate>
          December 30, 2024 pm
        </time>
      </span>
    
  </div>

  <div class="mt-1">
    

    

    
    
      
        <span id="busuanzi_container_page_pv" style="display: none">
          <i class="iconfont icon-eye" aria-hidden="true"></i>
          <span id="busuanzi_value_page_pv"></span> views
        </span>
        

      
    
  </div>


        
      </div>

      
    </div>
  </div>
</div>

</div>

  </header>

  <main>
    
      

<div class="container-fluid nopadding-x">
  <div class="row nomargin-x">
    <div class="side-col d-none d-lg-block col-lg-2">
      

    </div>

    <div class="col-lg-8 nopadding-x-md">
      <div class="container nopadding-x-md" id="board-ctn">
        <div id="board">
          <article class="post-content mx-auto">
            <h1 id="seo-header">Backend Misc</h1>
            
              <p id="updated-time" class="note note-info" style="">
                
                  
                    Last updated on April 14, 2025 pm
                  
                
              </p>
            
            
              <div class="markdown-body">
                
                <div class="note note-warning">
            <p>WIP FOREVER!</p>
          </div>
<div class="note note-secondary">
            <p><strong>problems</strong> I encountered(wondered) + <strong>solutions</strong> I found =&gt; <strong>knowledges</strong> I learned.</p>
          </div>
<h2 id="Database">Database</h2>
<h3 id="Index-types">Index types</h3>
<p>Basically there’re 3 core index types of databases:</p>
<ul>
<li>B / B+ Tree</li>
<li>LSM Tree</li>
<li>Hash</li>
</ul>
<p>Comparison:</p>
<table>
<thead>
<tr>
<th>Type</th>
<th>Benifits</th>
<th>Downsides</th>
</tr>
</thead>
<tbody>
<tr>
<td>Hash</td>
<td>Super fast</td>
<td>No range queries;<br>keys need to fit in memory</td>
</tr>
<tr>
<td>B / B+ Tree</td>
<td>Fast range-queries;<br>Number of keys not limited by memory</td>
<td>Slow write to btree on disk</td>
</tr>
<tr>
<td>LSM Tree</td>
<td>Number of keys not limited by memory;<br>Write faster than B tree and slower than Hash;<br>Support range-queries but slower than B tree</td>
<td>Extra CPU cost for Compaction</td>
</tr>
</tbody>
</table>
<p>Check this video for more details: <a target="_blank" rel="noopener" href="https://www.youtube.com/watch?v=ciGAVER_erw">LSM Tree + SSTable</a></p>
<hr>
<h3 id="LSM-Tree">LSM-Tree</h3>
<p><strong>Core primitives:</strong></p>
<div class="code-wrapper"><pre><code class="hljs text">
                                          ┌───────┐ ┌───────┐
                                      ┌──►│SSTable├►│SSTable│ ... L0
┌───────────┐   ┌───────────────────┐ │   └───┬───┘ └───────┘
│ MemTable  ├──►│ ImmutableMemTable ├─┘   ┌───┴───┐ ┌───────┐
└───────────┘   └───────────────────┘     │SSTable├►│SSTable│ ... L1+
                                          └───┬───┘ └───────┘
                                          ┌───┴───┐ ┌───────┐
                                          │SSTable├►│SSTable│ ... L1+
                                          └───────┘ └───────┘
</code></pre></div>
<p><strong>Writing:</strong></p>
<div class="code-wrapper"><pre><code class="hljs text">
 disk
┌───┐     ┌────────┐
│WAL├────►│MemTable│
└───┘     └──┬─────┘
             │
             │ if data is too much
      ┌──────┴─────────────────┐
 ┌────┴────────────┐    ┌──────┴─────┐
 │ImmutableMemTable│    │New MemTable│
 └───────┬─────────┘    └────────────┘
         │
         │ inorder traversal the tree
         │
     ┌───┴───┐
     │SSTable│ disk L0
     └───┬───┘
         │ compaction
     ┌───┴───┐
     │SSTable│ disk L1
     └───────┘
</code></pre></div>
<p><strong>Querying:</strong></p>
<div class="code-wrapper"><pre><code class="hljs text">
     ┌────────┐
     │MemTable│ mem query
     └────┬───┘
          │
  ┌───────┴─────────┐
  │ImmutableMemTable│  mem query
  └───┬─────────────┘
      │
      ├─────────────────┐
┌─────┴──────┐    ┌─────┴──────┐
│Bloom Filter│    │Bloom Filter│  use bloom filter to check if the target exists in the file
│------------│    │------------│
│  SSTable   │    │  SSTable   │  L0, the SSTables might intersect, so we have to check each of &#x27;em
└─────┬──────┘    └────────────┘
      │
┌─────┴──────┐    ┌────────────┐
│  SSTable   │    │  SSTable   │  L1+, the SSTables aren&#x27;t intersected, so we can use a binary search to get the target file
└────────────┘    └────────────┘
     ...
</code></pre></div>
<hr>
<h3 id="Other-types-except-Index">Other types(except Index)</h3>
<blockquote>
<p>I didn’t intend to go into detail on each of them—just a brief introduction and the core ideas.</p>
</blockquote>
<ol>
<li><u><strong>Group by storage</strong></u>
<ul>
<li><strong>Row-oriented</strong>: store the data in rows, and it’s good for OLTP.</li>
<li><strong>Column-oriented</strong>: store the data in columns, and it’s good for OLAP.</li>
<li><strong>Column-family</strong>: store the data in column families.</li>
<li><strong>Doc</strong>: store the data as a document.</li>
<li><strong>KV</strong>: store the data as HASH.</li>
</ul>
</li>
</ol>
<p><code>Row-oriented</code> is simple and common, let’s skip it here.</p>
<p><code>Column-oriented</code> stores data in columns, which speeds up the query like: <code>select col from table where ...</code>(that’s why it’s good for OLAP), but what if you perform a query like <code>select * from table where ...</code>?</p>
<p>Usually there’re 3 steps:</p>
<ul>
<li>Find the rows according to the <code>where clause</code>.</li>
<li>Use <strong><em>multi-threads</em></strong> to fetch the columns of the rows.</li>
<li>Aggregate the results.</li>
</ul>
<p><code>Column-family</code> could be a litte bit more complex, let’s break it down from 2 perspectives:</p>
<ul>
<li>What does it look like?</li>
<li>What problems does it solve?</li>
</ul>
<p>Assume we have a table like this(Row-oriented):</p>
<table>
<thead>
<tr>
<th>user_id</th>
<th>name</th>
<th>age</th>
<th>order1</th>
<th>order2</th>
<th>addr1</th>
<th>addr2</th>
</tr>
</thead>
<tbody>
<tr>
<td>1</td>
<td>Alice</td>
<td>30</td>
<td>iPhone</td>
<td>MacBook</td>
<td>NY</td>
<td>LA</td>
</tr>
<tr>
<td>2</td>
<td>Bob</td>
<td>28</td>
<td>Android</td>
<td>Laptop</td>
<td>SF</td>
<td>TX</td>
</tr>
</tbody>
</table>
<p>If we convert it into Column-oriented, there’re 7 columns.</p>
<p>Column-family is like split the single one table into several related tables, and each table has a group of columns. For example, we could split the table above into 3 column families:</p>
<div class="code-wrapper"><pre><code class="hljs text">Column-family1 stands for user basic info:
Row1: (1, Alice, 30)
Row2: (2, Bob, 28)

Column-family2 stands for user orders:
Row1: (iPhone, MacBook)
Row2: (Android, Laptop)

Column-family3 stands for user addresses:
Row1: (NY, LA)
Row2: (SF, TX)</code></pre></div>
<p>This design benifits in several ways:</p>
<ul>
<li>
<p>Comparing to Row-oriented databases, it avoids loading useless data.</p>
<p>In Row-oriented db, it will load all the columns of the row and extract the needed ones.</p>
</li>
<li>
<p>Comparing to Column-oriented databases, it avoids extra IOs.</p>
<p>In Column-oriented db, like we mentioned before, it needs to fetch the columns of the rows from different location of the disk(with or without multi-threads).</p>
<p>In Column-family db, we can query by rows with a specific family just like a Row-oriented db, which reduces the count of IOs.</p>
</li>
</ul>
<p>Now, we can see that Column-family follows a design pattern that sits between Row-oriented and Column-oriented storage models.</p>
<p>Let’s consider another question: <u>what if I decide to use a Row-oriented db and manully split a wide table into several related table instead of using a Column-family db?</u></p>
<p>This question cannot be answered easily, because a Column-family database usually works with LSM-Tree, and a classic RDBMS usually works with B+ Tree. The difference between them is not just about the storage model, but also about the query model, the transaction model, the consistency model, and so on.</p>
<p>E.g. when we perform DDL to a LSM-Tree based Column-family database to modify a ‘family’ of a table, things’re totally different:</p>
<ul>
<li>Adding a column doesn’t require heavy operations for Column-family db, cuz LSM-Tree is append only, which is a bit like the <code>INSTANT</code> mode of MySQL.</li>
<li>Removing a column is almost the same, we only need to modify the metadata of the family without deleting it from the disk.</li>
</ul>
<hr>
<ol start="2">
<li><u><strong>Different Aims</strong></u>
<ul>
<li>GraphDB: solves the n-degree relationship problem.</li>
<li>TSDB: solves the time series data problem.</li>
<li>VectorDB: solves the vector data problem.</li>
</ul>
</li>
</ol>
<p>GraphDB: what does <code>n-degree</code> mean?</p>
<p>The example below is a classic <code>2-degree</code> relationship:</p>
<div class="code-wrapper"><pre><code class="hljs text">user_friends_ref:
| user_id | friend_user_id |
|    1    |      2         |
|    1    |      31        |
|    1    |      283       |

If we want to recommend the friends of the friends of user 1 to himself,
how to acheive this in a RDBMS?

E.g Alice knows Bob, and Bob knows Charlie, and we want to recommend Charlie to Alice.

We have to do things like these:
1. select friend_user_id from user_friends_ref where user_id = alice.user_id;
2. select distinct(friend_user_id) from user_friends_ref where user_id in $(the_result_above);
3. recommend the result in the 2nd step;</code></pre></div>
<p>And if we want to recommend my friends’ friends’ friends to me, it’ll be a <code>3-degree</code> problem and a disaster:</p>
<div class="code-wrapper"><pre><code class="hljs text">┌──┐  ┌────┐  ┌───┐  ┌─────┐
│Me├─►│Jack├─►│Amy├─►│Steve│
└──┘  └────┘  └───┘  └──┬──┘
 ▲       recommend      │
 └──────────────────────┘</code></pre></div>
<p>Time Series Databases (TSDBs), such as InfluxDB, are built on LSM-Tree architecture, with extensive optimizations tailored specifically for time series data.</p>
<p>As for VectorDB, it’s built for vector data, you can use it to perform calculation like <code>L2</code> and <code>Cosine Similarity</code> easily:</p>
<p class="katex-block "><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><mi>L</mi><mn>2</mn><mo stretchy="false">(</mo><mi>A</mi><mo separator="true">,</mo><mi>B</mi><mo stretchy="false">)</mo><mo>=</mo><msqrt><mrow><mo stretchy="false">(</mo><msub><mi>A</mi><mn>1</mn></msub><mo>−</mo><msub><mi>B</mi><mn>1</mn></msub><msup><mo stretchy="false">)</mo><mn>2</mn></msup><mo>+</mo><mo stretchy="false">(</mo><msub><mi>A</mi><mn>2</mn></msub><mo>−</mo><msub><mi>B</mi><mn>2</mn></msub><msup><mo stretchy="false">)</mo><mn>2</mn></msup><mo>+</mo><mo>…</mo><mo>+</mo><mo stretchy="false">(</mo><msub><mi>A</mi><mi>n</mi></msub><mo>−</mo><msub><mi>B</mi><mi>n</mi></msub><msup><mo stretchy="false">)</mo><mn>2</mn></msup></mrow></msqrt></mrow><annotation encoding="application/x-tex">L2(A, B) = \sqrt{(A_1 - B_1)^2 + (A_2 - B_2)^2 + \text{…} + (A_n - B_n)^2}
</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal">L</span><span class="mord">2</span><span class="mopen">(</span><span class="mord mathnormal">A</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord mathnormal" style="margin-right:0.05017em;">B</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:1.24em;vertical-align:-0.2561em;"></span><span class="mord sqrt"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.9839em;"><span class="svg-align" style="top:-3.2em;"><span class="pstrut" style="height:3.2em;"></span><span class="mord" style="padding-left:1em;"><span class="mopen">(</span><span class="mord"><span class="mord mathnormal">A</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.05017em;">B</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:-0.0502em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mclose"><span class="mclose">)</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.7401em;"><span style="top:-2.989em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal">A</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.05017em;">B</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:-0.0502em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mclose"><span class="mclose">)</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.7401em;"><span style="top:-2.989em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mord text"><span class="minner">…</span></span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal">A</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.1514em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">n</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.05017em;">B</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.1514em;"><span style="top:-2.55em;margin-left:-0.0502em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">n</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mclose"><span class="mclose">)</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.7401em;"><span style="top:-2.989em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span></span></span></span></span></span></span><span style="top:-2.9439em;"><span class="pstrut" style="height:3.2em;"></span><span class="hide-tail" style="min-width:1.02em;height:1.28em;"><svg xmlns="http://www.w3.org/2000/svg" width="400em" height="1.28em" viewBox="0 0 400000 1296" preserveAspectRatio="xMinYMin slice"><path d="M263,681c0.7,0,18,39.7,52,119
c34,79.3,68.167,158.7,102.5,238c34.3,79.3,51.8,119.3,52.5,120
c340,-704.7,510.7,-1060.3,512,-1067
l0 -0
c4.7,-7.3,11,-11,19,-11
H40000v40H1012.3
s-271.3,567,-271.3,567c-38.7,80.7,-84,175,-136,283c-52,108,-89.167,185.3,-111.5,232
c-22.3,46.7,-33.8,70.3,-34.5,71c-4.7,4.7,-12.3,7,-23,7s-12,-1,-12,-1
s-109,-253,-109,-253c-72.7,-168,-109.3,-252,-110,-252c-10.7,8,-22,16.7,-34,26
c-22,17.3,-33.3,26,-34,26s-26,-26,-26,-26s76,-59,76,-59s76,-60,76,-60z
M1001 80h400000v40h-400000z"/></svg></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2561em;"><span></span></span></span></span></span></span></span></span></span></p>
<p class="katex-block "><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><mi>cos</mi><mo>⁡</mo><mo stretchy="false">(</mo><mi>θ</mi><mo stretchy="false">)</mo><mo>=</mo><mfrac><mrow><mi>A</mi><mo>⋅</mo><mi>B</mi></mrow><mrow><mi mathvariant="normal">∣</mi><mi mathvariant="normal">∣</mi><mi>A</mi><mi mathvariant="normal">∣</mi><mi mathvariant="normal">∣</mi><mo>×</mo><mi mathvariant="normal">∣</mi><mi mathvariant="normal">∣</mi><mi>B</mi><mi mathvariant="normal">∣</mi><mi mathvariant="normal">∣</mi></mrow></mfrac></mrow><annotation encoding="application/x-tex">\cos(\theta) = \frac{A \cdot B}{||A|| \times ||B||}
</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mop">cos</span><span class="mopen">(</span><span class="mord mathnormal" style="margin-right:0.02778em;">θ</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:2.2963em;vertical-align:-0.936em;"></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.3603em;"><span style="top:-2.314em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord">∣∣</span><span class="mord mathnormal">A</span><span class="mord">∣∣</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">×</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mord">∣∣</span><span class="mord mathnormal" style="margin-right:0.05017em;">B</span><span class="mord">∣∣</span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"></span><span class="frac-line" style="border-bottom-width:0.04em;"></span></span><span style="top:-3.677em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord mathnormal">A</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">⋅</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mord mathnormal" style="margin-right:0.05017em;">B</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.936em;"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span></span></span></span></span></p>
<p>…</p>
<hr>
<h3 id="Transactions">Transactions</h3>
<h4 id="Optimistic-and-pessimistic-Txs-like-TiDB">Optimistic and pessimistic Txs(like TiDB)</h4>
<ul>
<li>Optimistic: commit anyway, if there’re any conflicts, rollback.</li>
<li>Pessimistic: lock the rows to make sure there’re no conflicts, commit.</li>
</ul>
<div class="note note-light">
            <p>The lock is a little bit different, cuz we usually use locks to gurantee the resources are modified correctly.</p><p>E.g. if we try to deduct the inventory of a item:<br>using a optimistic lock is like: <code>update item set amount = amount - 1 where amount &gt; 0 and id = 1</code>, and then we check whether the rows affected is <code>1</code>;<br>while using a pessimistic lock is like <code>BEGIN; select amount of item where id = 1; check the amount and do sth; COMMIT;</code></p>
          </div>
<hr>
<h3 id="MVCC">MVCC</h3>
<p>MVCC (Multi-Version Concurrency Control) is a solution designed to address transaction management challenges in concurrent environments, allowing for consistent reads and writes without locking.</p>
<p>Therefore, MVCC is <u>tightly coupled with transactions</u> and is typically a requirement in <u>relational databases</u> to ensure data consistency and concurrency control.</p>
<p>Different dbs have different approaches, and I don’t intend to go into detail on each of them. Instead, let’s focus on the core ideas:</p>
<p>Since there’re multi txs trying to perform r/w ops to a same line at the same time(before they ‘COMMIT’), <u>a single row might have several different versions</u>. And when a tx tries to read a row, it’ll try its best to read the latest version.</p>
<p>To achieve the target, there’re 2 things to be done:</p>
<ul>
<li>Determine which version is the ‘latest’ - so I can read it exactly(neither the outdated data nor the uncommitted data).</li>
<li>And to determine it, we need to know the order of the txs.</li>
</ul>
<p><u>Keeping the global tx order is easy, all we need to do is using a serial adder to generate the tx id.</u></p>
<p>With the tx id, the row might look like this:</p>
<div class="code-wrapper"><pre><code class="hljs text">              ┌────────────────────┐
          ┌──►│ id=1 | data | tx_0 │
          │   └────────────────────┘
          └─────────────────────┐
         ┌────────────────────┐ │
       ┌►│ id=1 | data | tx_1 ├─┘
       │ └────────────────────┘
       └───────────────────┐
    ┌────────────────────┐ │
    │ id=1 | data | tx_2 ├─┘
    └────────────────────┘

All of these versions of data can be read</code></pre></div>
<p>Don’t worry about the disk usage, thoese copies will be cleaned up after the tx is committed by a daemon thread / task asynchronously.</p>
<p>Now, we can easily get the below information when we’re creating a READ VIEW:</p>
<ul>
<li>current active txs
<ul>
<li>the minimal tx_id indicates the oldest active tx</li>
<li>the maximum tx_id indicates the newest active tx</li>
</ul>
</li>
</ul>
<p>Finally, we can determine whether a specific version of row can be read with the following steps:</p>
<div class="code-wrapper"><pre><code class="hljs rust">
<span class="hljs-comment">// cur_v is the version of the row we&#x27;re trying to access</span>
<span class="hljs-comment">// min_id, max_id, my_id are literal meanings</span>
<span class="hljs-keyword">fn</span> <span class="hljs-title function_">can_read</span>(cur_v: <span class="hljs-type">i32</span>, active_tx_ids: &amp;[<span class="hljs-type">i32</span>], min_id: <span class="hljs-type">i32</span>, max_id: <span class="hljs-type">i32</span>, my_id: <span class="hljs-type">i32</span>) <span class="hljs-punctuation">-&gt;</span> <span class="hljs-type">bool</span> &#123;
    <span class="hljs-comment">// current version is old enough</span>
    <span class="hljs-keyword">if</span> cur_v &lt; min_id &#123;
        <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;
    &#125;

    <span class="hljs-comment">// current version is created by me</span>
    <span class="hljs-keyword">if</span> cur_v == my_id &#123;
        <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;
    &#125;

    <span class="hljs-comment">// current version is newer than the newest active tx</span>
    <span class="hljs-keyword">if</span> cur_v &gt; max_id &#123;
        <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;
    &#125;

    <span class="hljs-comment">// if not contains, that means the cur_v was committed before the read view is created</span>
    <span class="hljs-comment">// otherwise it means the cur_v is still active and uncommitted</span>
    active_tx_ids.<span class="hljs-title function_ invoke__">contains</span>(&amp;cur_v)
&#125;</code></pre></div>
<p>Moreover, we can achieve different <strong>isolation levels</strong> by adjusting the timing of READ VIEW creation:</p>
<ul>
<li>If we create a READ VIEW before starting a tx and keep it until the transaction completes, we achieve Repeatable Read (RR) isolation, as the view remains unchanged throughout the transaction’s lifetime.</li>
<li>If we create a READ VIEW before each query within a transaction, we achieve Read Committed (RC) isolation, as each view may differ, but the data read is always committed.</li>
</ul>
<hr>
<h3 id="Join">Join</h3>
<h4 id="Nested-Loop-Join">Nested Loop Join</h4>
<ul>
<li>
<p>SQL:<br>
<code>select * from TableA join TableB on TableA.user_id = TableB.user_id</code></p>
</li>
<li>
<p>Pseudo code:</p>
<div class="code-wrapper"><pre><code class="hljs rust"><span class="hljs-keyword">for</span> <span class="hljs-variable">rowA</span> <span class="hljs-keyword">in</span> TableA &#123;
    <span class="hljs-keyword">for</span> <span class="hljs-variable">rowB</span> <span class="hljs-keyword">in</span> TableB &#123;
        <span class="hljs-keyword">if</span> rowA.key == rowB.key &#123;
            <span class="hljs-title function_ invoke__">output</span>(rowA, rowB);
        &#125;
    &#125;
&#125;</code></pre></div>
</li>
</ul>
<p>In the above example, <code>TableA</code> is the <code>Outer table</code> and <code>TableB</code> is the <code>Inner table</code>. By default the inner table is <code>TableB</code>, but the actual situation is determined by the SQL Execution Optimizer – it prefer to choose the <strong>smaller</strong> table as the inner table.</p>
<p>If we have a index on <code>TableB.user_id</code>, the pseudo code should be like:</p>
<div class="code-wrapper"><pre><code class="hljs rust"><span class="hljs-keyword">for</span> <span class="hljs-variable">rowA</span> <span class="hljs-keyword">in</span> TableA &#123;
    rowB = <span class="hljs-title function_ invoke__">index_lookup</span>(TableB, rowA.key); <span class="hljs-comment">// use index</span>
    <span class="hljs-keyword">if</span> rowB.<span class="hljs-title function_ invoke__">exists</span>() &#123;
        <span class="hljs-title function_ invoke__">output</span>(rowA, rowB);
    &#125;
&#125;</code></pre></div>
<div class="note note-primary">
            <p>The applicable cases are:</p><ul><li>rows are not too many</li><li>the inner table has proper indexes</li></ul><p>Time complexity: <code>O(n * m)</code>, where <code>n</code> is the number of rows in <code>TableA</code> and <code>m</code> is the number of rows in <code>TableB</code>.<br>With index: <code>O(n * log(m))</code>, if the index provides the <code>O(log(m))</code> time complexity – like B+ Tree.</p>
          </div>
<hr>
<h4 id="Hash-Join">Hash Join</h4>
<ul>
<li>
<p>Pseudo code:</p>
<div class="code-wrapper"><pre><code class="hljs rust"><span class="hljs-comment">// Build: walk the inner table to build a hash table</span>
hash_table = HashMap::<span class="hljs-title function_ invoke__">new</span>();
<span class="hljs-keyword">for</span> <span class="hljs-variable">rowB</span> <span class="hljs-keyword">in</span> TableB &#123;
    hash_table.<span class="hljs-title function_ invoke__">insert</span>(rowB.key, rowB);
&#125;

<span class="hljs-comment">// Probe: walk the outer table to find the corresponding rows</span>
<span class="hljs-keyword">for</span> <span class="hljs-variable">rowA</span> <span class="hljs-keyword">in</span> TableA &#123;
    <span class="hljs-keyword">if</span> hash_table.<span class="hljs-title function_ invoke__">contains_key</span>(rowA.key) &#123;
        <span class="hljs-title function_ invoke__">output</span>(rowA, hash_table[rowA.key]);
    &#125;
&#125;</code></pre></div>
</li>
</ul>
<div class="note note-primary">
            <p>The applicable cases are:</p><ul><li>no indexes</li><li>many rows but fit in the mem</li><li>no sorting requirements</li></ul><p>Time complexity: <code>O(n)</code> for building hash table, <code>O(m)</code> for probing, thus the total time complexity is <code>O(n + m)</code> which is faster than <code>Nested Loop Join</code>.</p>
          </div>
<h4 id="Merged-Join">Merged Join</h4>
<ul>
<li>
<p>Pseudo code:</p>
<div class="code-wrapper"><pre><code class="hljs rust">iterA = TableA.<span class="hljs-title function_ invoke__">iterator</span>();
iterB = TableB.<span class="hljs-title function_ invoke__">iterator</span>();
rowA = iterA.<span class="hljs-title function_ invoke__">next</span>();
rowB = iterB.<span class="hljs-title function_ invoke__">next</span>();

<span class="hljs-keyword">while</span> rowA and rowB &#123;
    <span class="hljs-keyword">if</span> rowA.key == rowB.key &#123;
        <span class="hljs-title function_ invoke__">output</span>(rowA, rowB);
        rowA = iterA.<span class="hljs-title function_ invoke__">next</span>();
        rowB = iterB.<span class="hljs-title function_ invoke__">next</span>();
    &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> rowA.key &lt; rowB.key &#123;
        rowA = iterA.<span class="hljs-title function_ invoke__">next</span>();
    &#125; <span class="hljs-keyword">else</span> &#123;
        rowB = iterB.<span class="hljs-title function_ invoke__">next</span>();
    &#125;
&#125;</code></pre></div>
</li>
</ul>
<div class="note note-primary">
            <p>The applicable cases are:</p><ul><li>both tables are sorted</li><li>need sorting</li><li>range query</li></ul><p>Time complexity: <code>O(n + m)</code>.</p>
          </div>
<hr>
<h4 id="Another-example">Another example</h4>
<p>SQL:</p>
<div class="code-wrapper"><pre><code class="hljs sql"><span class="hljs-keyword">SELECT</span> <span class="hljs-operator">*</span> <span class="hljs-keyword">FROM</span> <span class="hljs-keyword">user</span>
<span class="hljs-keyword">JOIN</span> avatar <span class="hljs-keyword">ON</span> user.user_id <span class="hljs-operator">=</span> avatar.user_id
<span class="hljs-keyword">WHERE</span> user.user_id <span class="hljs-operator">=</span> <span class="hljs-number">1</span>;</code></pre></div>
<p>If we have the <code>user_id_idx</code> on both tables, the exec process should be like:</p>
<div class="code-wrapper"><pre><code class="hljs rust"><span class="hljs-keyword">for</span> <span class="hljs-variable">rowA</span> <span class="hljs-keyword">in</span> (SELECT * FROM user WHERE user_id = <span class="hljs-number">1</span>) &#123;
    <span class="hljs-keyword">for</span> <span class="hljs-variable">rowB</span> <span class="hljs-keyword">in</span> (SELECT * FROM avatar WHERE user_id = rowA.user_id) &#123;
        <span class="hljs-title function_ invoke__">output</span>(rowA, rowB);
    &#125;
&#125;</code></pre></div>
<p>If not, the process is like:</p>
<div class="code-wrapper"><pre><code class="hljs rust"><span class="hljs-keyword">for</span> <span class="hljs-variable">rowA</span> <span class="hljs-keyword">in</span> (SELECT * FROM user WHERE user_id = <span class="hljs-number">1</span>) &#123;
    <span class="hljs-keyword">for</span> <span class="hljs-variable">rowB</span> <span class="hljs-keyword">in</span> (SELECT * FROM avatar) &#123; <span class="hljs-comment">// PERF: scan all the table</span>
        <span class="hljs-keyword">if</span> rowA.user_id == rowB.user_id &#123;
            <span class="hljs-title function_ invoke__">output</span>(rowA, rowB);
        &#125;
    &#125;
&#125;</code></pre></div>
<hr>
<h3 id="How-much-data-is-appropriate-for-a-table-B-Tree-type-index">How much data is appropriate for a table? (B+ Tree type index)</h3>
<p>Actually this is a math problem, before we dive into it, we need to figure out the <strong><em>page size</em></strong> of the database, like:</p>
<div class="code-wrapper"><pre><code class="hljs text">postgres@localhost:my_db&gt; show block_size
+------------+
| block_size |
|------------|
| 8192       |
+------------+
SHOW
Time: 0.262s</code></pre></div>
<p>For PostgreSQL it’s 8KB, and for MySQL it’s usually 16KB.</p>
<p>Assume we’re using MySQL, and the data type of <code>id</code> is <code>BIGINT</code>, which takes 8B(64 bit), and the pointer or any other necessary data of a tree node takes another 8B, thus each level can hold <code>16KB / 16B ≈ 1000</code> nodes.</p>
<p>And we all know that for a <code>cluster index</code>, the leaf node is the actual data, and the non-leaf node is the index, and of course we have a root node. In that case, if the B+ Tree has 3 level, then the count of leaf nodes are:</p>
<p class="katex-block "><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><mtext>Leaf nodes</mtext><mo>=</mo><msup><mn>1000</mn><mn>2</mn></msup><mo>=</mo><mn>1</mn><mo separator="true">,</mo><mn>000</mn><mo separator="true">,</mo><mn>000</mn></mrow><annotation encoding="application/x-tex">\text{Leaf nodes} = 1000^2 = 1,000,000
</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6944em;"></span><span class="mord text"><span class="mord">Leaf nodes</span></span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.8641em;"></span><span class="mord">100</span><span class="mord"><span class="mord">0</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8641em;"><span style="top:-3.113em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.8389em;vertical-align:-0.1944em;"></span><span class="mord">1</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord">000</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord">000</span></span></span></span></span></p>
<p>Now assume each row takes 1KB, then a single page could hold <code>16KB / 1KB = 16</code> rows, thus for a 3 level B+ Tree it could hold:</p>
<p class="katex-block "><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><mtext>Rows</mtext><mo>=</mo><mtext>Leaf nodes</mtext><mo>∗</mo><mn>16</mn><mo>=</mo><mn>1</mn><mo separator="true">,</mo><mn>000</mn><mo separator="true">,</mo><mn>000</mn><mo>∗</mo><mn>16</mn><mo>=</mo><mn>16</mn><mo separator="true">,</mo><mn>000</mn><mo separator="true">,</mo><mn>000</mn></mrow><annotation encoding="application/x-tex">\text{Rows} = \text{Leaf nodes} * 16 = 1,000,000 * 16 = 16,000,000
</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord text"><span class="mord">Rows</span></span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.6944em;"></span><span class="mord text"><span class="mord">Leaf nodes</span></span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">∗</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:0.6444em;"></span><span class="mord">16</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.8389em;vertical-align:-0.1944em;"></span><span class="mord">1</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord">000</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord">000</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">∗</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:0.6444em;"></span><span class="mord">16</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.8389em;vertical-align:-0.1944em;"></span><span class="mord">16</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord">000</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord">000</span></span></span></span></span></p>
<p>For each query it takes 3 IOs(cuz there’re 3 levels). And continuing this idea from above, when the database has more rows, it will take 4-5 and even more IOs for each query in the worst case(there’re buffers, so typically we don’t have to perform that many IOs).</p>
<hr>
<p><strong><em>But things’re different in PostgreSQL - it doesn’t store the row data in the leaf nodes!</em></strong></p>
<p>Instead, it stores the disk pointer in the leaf nodes, and the actual data is stored in the heap. So the leaf nodes of a B+ Tree in PostgreSQL are much smaller than in MySQL, and the number of rows that a single page could hold is much larger.</p>
<p>Typically a disk pointer takes 6B space, which means a single block can hold <code>7KB(8KB - some reserved space) / 6B ≈ 1200</code> pointers, much more than the MySQL. But keep in mind that since the block stores a pointer instead of the row data, an additional I/O operation is required to fetch the row.</p>
<p>Let’s do the math again:</p>
<p class="katex-block "><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><mtext>Nodes of each level</mtext><mo>=</mo><mn>8</mn><mi>K</mi><mi>B</mi><mi mathvariant="normal">/</mi><mn>16</mn><mi>B</mi><mo>=</mo><mn>500</mn></mrow><annotation encoding="application/x-tex">\text{Nodes of each level} = 8KB / 16B = 500
</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6944em;"></span><span class="mord text"><span class="mord">Nodes of each level</span></span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord">8</span><span class="mord mathnormal" style="margin-right:0.07153em;">K</span><span class="mord mathnormal" style="margin-right:0.05017em;">B</span><span class="mord">/16</span><span class="mord mathnormal" style="margin-right:0.05017em;">B</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.6444em;"></span><span class="mord">500</span></span></span></span></span></p>
<p class="katex-block "><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><mtext>Leaf nodes</mtext><mo>=</mo><msup><mn>500</mn><mn>2</mn></msup><mo>=</mo><mn>250</mn><mo separator="true">,</mo><mn>000</mn></mrow><annotation encoding="application/x-tex">\text{Leaf nodes} = 500^2 = 250,000
</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6944em;"></span><span class="mord text"><span class="mord">Leaf nodes</span></span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.8641em;"></span><span class="mord">50</span><span class="mord"><span class="mord">0</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8641em;"><span style="top:-3.113em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.8389em;vertical-align:-0.1944em;"></span><span class="mord">250</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord">000</span></span></span></span></span></p>
<p class="katex-block "><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><mtext>Rows</mtext><mo>=</mo><mtext>Leaf nodes</mtext><mo>∗</mo><mn>1200</mn><mo>=</mo><mn>250</mn><mo separator="true">,</mo><mn>000</mn><mo>∗</mo><mn>1200</mn><mo>=</mo><mn>300</mn><mo separator="true">,</mo><mn>000</mn><mo separator="true">,</mo><mn>000</mn></mrow><annotation encoding="application/x-tex">\text{Rows} = \text{Leaf nodes} * 1200 = 250,000 * 1200 = 300,000,000
</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord text"><span class="mord">Rows</span></span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.6944em;"></span><span class="mord text"><span class="mord">Leaf nodes</span></span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">∗</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:0.6444em;"></span><span class="mord">1200</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.8389em;vertical-align:-0.1944em;"></span><span class="mord">250</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord">000</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">∗</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:0.6444em;"></span><span class="mord">1200</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.8389em;vertical-align:-0.1944em;"></span><span class="mord">300</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord">000</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord">000</span></span></span></span></span></p>
<p>LOL, 300 millions!(With an extra IO though)</p>
<div class="note note-light">
            <p><strong><em>Why don’t you use a larger page size?(to reduce the num of tree layers)</em></strong></p><p>Cuz databases are read and written on a page-by-page basis, not key-by-key. Therefore:</p><p>A large page size will cause <u><strong>Write Amplification</strong> problem</u>, even if we only modified a single row, the whole page will be written to the disk.</p><p>Meanwhile, when we’re reading a single row, we have to read the whole page, which will <u>slow down the query speed</u>.</p><p>What’s more, the <code>Buffer Pool</code> of databases is also based on the page size, and a larger page size will <u>cause a waste of memory</u>.</p><p>Last but not least, a larger page size will <u>cause a waste of disk space</u>, cuz the page is not full, and the <u>file block of operating system is usually 4KB</u>.</p>
          </div>
<hr>
<h3 id="PostgreSQL">PostgreSQL</h3>
<h4 id="Conditional-Index">Conditional Index</h4>
<p>Assume we have a state machine table with stages ‘1’, ‘2’ and ‘3’, and there’s a ‘user_id’ column in the table.</p>
<table>
<thead>
<tr>
<th>id</th>
<th>user_id</th>
<th>stage</th>
</tr>
</thead>
<tbody>
<tr>
<td>1</td>
<td>38413</td>
<td>1</td>
</tr>
<tr>
<td>2</td>
<td>38418</td>
<td>2</td>
</tr>
<tr>
<td>3</td>
<td>38413</td>
<td>3</td>
</tr>
<tr>
<td>4</td>
<td>38413</td>
<td>3</td>
</tr>
<tr>
<td>5</td>
<td>38413</td>
<td>3</td>
</tr>
</tbody>
</table>
<p>If we want to make sure that the ‘user_id’ is unique within the stage ‘1’ and ‘2’, but it’s allowed to be duplicated in the stage ‘3’, we can create a conditional index like this:</p>
<div class="code-wrapper"><pre><code class="hljs sql"><span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">UNIQUE</span> INDEX index_name <span class="hljs-keyword">ON</span> table_name (user_id) <span class="hljs-keyword">WHERE</span> stage <span class="hljs-keyword">IN</span> (<span class="hljs-number">1</span>, <span class="hljs-number">2</span>);</code></pre></div>
<p>If the scope is defined by a <code>varchar</code> column, the DDL is a little bit more complex:</p>
<div class="code-wrapper"><pre><code class="hljs sql"><span class="hljs-keyword">create</span> <span class="hljs-keyword">unique</span> index index_name
    <span class="hljs-keyword">on</span> table_name (user_id, to_user_id)
    <span class="hljs-keyword">where</span> ((status)::text <span class="hljs-operator">=</span> <span class="hljs-keyword">ANY</span>
           ((<span class="hljs-keyword">ARRAY</span> [<span class="hljs-string">&#x27;INIT&#x27;</span>::<span class="hljs-type">character</span> <span class="hljs-type">varying</span>, <span class="hljs-string">&#x27;PENDING&#x27;</span>::<span class="hljs-type">character</span> <span class="hljs-type">varying</span>, <span class="hljs-string">&#x27;ACCEPTED&#x27;</span>::<span class="hljs-type">character</span> <span class="hljs-type">varying</span>])::text[]));</code></pre></div>
<hr>
<h4 id="Concurrent-Queries-on-One-Connection">Concurrent Queries on One Connection</h4>
<p><u><em>This is not allowed</em></u> due to the limitation of the PostgreSQL protocol. If you want to run multiple queries in parallel, you need to use multiple connections.</p>
<p>However, you can use <code>pipelining</code> to send multiple queries to the server in a batch.</p>
<p>Check this out: <a target="_blank" rel="noopener" href="https://github.com/MagicStack/asyncpg/issues/738">Concurrent queries on single connection #738</a></p>
<hr>
<h4 id="Connection-Pool-Size-and-QPS">Connection Pool Size and QPS</h4>
<p>Assume:</p>
<ul>
<li>Average query time: t <em>seconds</em></li>
<li>Connection pool size: n</li>
<li>QPS: q</li>
</ul>
<p>We have the following formula:</p>
<p class="katex-block "><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><mi>q</mi><mo>≤</mo><mfrac><mi>n</mi><mi>t</mi></mfrac><mo>=</mo><mi>max</mi><mo>⁡</mo><mo stretchy="false">(</mo><mi>q</mi><mi>p</mi><mi>s</mi><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">q \leq \frac{n}{t} = \max(qps)
</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8304em;vertical-align:-0.1944em;"></span><span class="mord mathnormal" style="margin-right:0.03588em;">q</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">≤</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:1.7936em;vertical-align:-0.686em;"></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.1076em;"><span style="top:-2.314em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord mathnormal">t</span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"></span><span class="frac-line" style="border-bottom-width:0.04em;"></span></span><span style="top:-3.677em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord mathnormal">n</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.686em;"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mop">max</span><span class="mopen">(</span><span class="mord mathnormal">qp</span><span class="mord mathnormal">s</span><span class="mclose">)</span></span></span></span></span></p>
<p>What will happen if the QPS exceeds the limit? - The connection pool will be exhausted.</p>
<p>Let’s say that <code>q &gt; n/t</code>, then we have:</p>
<p class="katex-block "><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><mtext>Extra Reqs</mtext><mo>=</mo><mi>m</mi><mo>=</mo><mi>q</mi><mo>−</mo><mfrac><mi>n</mi><mi>t</mi></mfrac></mrow><annotation encoding="application/x-tex">\text{Extra Reqs} = m = q - \frac{n}{t}
</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8778em;vertical-align:-0.1944em;"></span><span class="mord text"><span class="mord">Extra Reqs</span></span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.4306em;"></span><span class="mord mathnormal">m</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.7778em;vertical-align:-0.1944em;"></span><span class="mord mathnormal" style="margin-right:0.03588em;">q</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:1.7936em;vertical-align:-0.686em;"></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.1076em;"><span style="top:-2.314em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord mathnormal">t</span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"></span><span class="frac-line" style="border-bottom-width:0.04em;"></span></span><span style="top:-3.677em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord mathnormal">n</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.686em;"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span></span></span></span></span></p>
<p>These requests will be queued and wait for the connection to be available.</p>
<p class="katex-block "><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><mtext>delay rounds</mtext><mo>=</mo><mrow><mo fence="true">{</mo><mtable rowspacing="0.36em" columnalign="left left" columnspacing="1em"><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mrow><mn>0</mn><mo separator="true">,</mo></mrow></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mrow><mtext>if </mtext><mi>n</mi><mo>≥</mo><mi>m</mi><mo separator="true">,</mo><mtext>but the next n gets smaller</mtext><mo>:</mo><mi>n</mi><mo>−</mo><mi>m</mi></mrow></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mrow><mi>m</mi><mi mathvariant="normal">/</mi><mi>n</mi><mo separator="true">,</mo></mrow></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mrow><mtext>if </mtext><mi>n</mi><mo>&lt;</mo><mi>m</mi><mo separator="true">,</mo><mtext>and the last n gets smaller</mtext><mo>:</mo><mi>n</mi><mo>−</mo><mi>m</mi><mtext> </mtext><mo lspace="0.22em" rspace="0.22em"><mrow><mi mathvariant="normal">m</mi><mi mathvariant="normal">o</mi><mi mathvariant="normal">d</mi></mrow></mo><mtext> </mtext><mi>n</mi></mrow></mstyle></mtd></mtr></mtable></mrow></mrow><annotation encoding="application/x-tex">\text{delay rounds} =
\begin{cases}
0,&amp; \text{if } n \geq m, \text{but the next n gets smaller}: n-m\\
m / n,&amp; \text{if } n &lt; m, \text{and the last n gets smaller}: n-m \bmod n\\
\end{cases}
</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8889em;vertical-align:-0.1944em;"></span><span class="mord text"><span class="mord">delay rounds</span></span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:3em;vertical-align:-1.25em;"></span><span class="minner"><span class="mopen delimcenter" style="top:0em;"><span class="delimsizing size4">{</span></span><span class="mord"><span class="mtable"><span class="col-align-l"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.69em;"><span style="top:-3.69em;"><span class="pstrut" style="height:3.008em;"></span><span class="mord"><span class="mord">0</span><span class="mpunct">,</span></span></span><span style="top:-2.25em;"><span class="pstrut" style="height:3.008em;"></span><span class="mord"><span class="mord mathnormal">m</span><span class="mord">/</span><span class="mord mathnormal">n</span><span class="mpunct">,</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:1.19em;"><span></span></span></span></span></span><span class="arraycolsep" style="width:1em;"></span><span class="col-align-l"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.69em;"><span style="top:-3.69em;"><span class="pstrut" style="height:3.008em;"></span><span class="mord"><span class="mord text"><span class="mord">if </span></span><span class="mord mathnormal">n</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">≥</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mord mathnormal">m</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord text"><span class="mord">but the next n gets smaller</span></span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">:</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mord mathnormal">n</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mord mathnormal">m</span></span></span><span style="top:-2.25em;"><span class="pstrut" style="height:3.008em;"></span><span class="mord"><span class="mord text"><span class="mord">if </span></span><span class="mord mathnormal">n</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">&lt;</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mord mathnormal">m</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord text"><span class="mord">and the last n gets smaller</span></span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">:</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mord mathnormal">n</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mord mathnormal">m</span><span class="mspace" style="margin-right:0.0556em;"></span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin"><span class="mord"><span class="mord mathrm">mod</span></span></span><span class="mspace" style="margin-right:0.0556em;"></span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mord mathnormal">n</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:1.19em;"><span></span></span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span></span></span></span></span></p>
<p>So if the qps is too high, it’ll cause a delay in the response time. What’s worse, <u><em>if the qps consistently exceeds the limit, the delay will be accumulated</em></u>.</p>
<div class="note note-light">
            <p>However, things’re going well in the real world in most cases.</p><p>Because the average query time shoule be quite small (like 10ms), while the connection pool size is usually large enough(like 50).</p><p>Then the limit of QPS is quite high(5000 in this case).</p>
          </div>
<hr>
<h3 id="MongoDB-vs-MySQL">MongoDB vs MySQL</h3>
<h4 id="Comparison">Comparison</h4>
<p><strong>Performance</strong> is rarely the primary factor when choosing between MongoDB and MySQL.</p>
<div class="note note-warning">
            <p>I’m not trying to convince developers to use MongoDB instead of MySQL, or vice verse, or bragging about the benifits of MongoDB. Even if it looks like so…</p><p>Read this: <a target="_blank" rel="noopener" href="https://www.mongodb.com/resources/compare/mongodb-mysql"><u>MongoDB vs. MySQL Differences</u></a></p>
          </div>
<p>The “real” differences / considerations are:</p>
<ul>
<li>
<p><strong>user-friendliness</strong><br>
No schema means less work, but it also means less control. Do you really need it? – Think about this question.<br>
What’s more, MongoDB also provides a collection of friendly APIs, which makes it easier to use.</p>
</li>
<li>
<p><strong>scalability</strong><br>
MongoDB provides both <strong><em>sharded cluster</em></strong> and <strong><em>replica set</em></strong> to scale horizontally and vertically, while MySQL doesn’t.</p>
</li>
<li>
<p><strong>performance</strong><br>
Like we’ve mentioned above, this is usually not the primary factor cuz it’s really difficult to assessing two completely different database systems.<br>
For example, MySQL is optmized for <code>join</code> tables that have been appropriately indexed, while MongoDB uses <code>$lookup</code> to achieve this function - which is slower.<br>
However, <code>join</code> is not how Mongo Doc tend to be used - why don’t you merge those collections into the same one to make it simple and compact?</p>
</li>
<li>
<p><strong>dev experience</strong><br>
<u>You do not need to exec any DDL with MongoDB.</u><br>
You do not need ORM with MongoDB.</p>
</li>
</ul>
<p>And here’re some frequently asked questions within the community:</p>
<ol>
<li>
<p><strong><em>Does MongoDB faster than MySQL?</em></strong><br>
Hard to explain and assess, cuz you can always choose to denormalize the tables when using MySQL, and anohter consideration is how you query the data.</p>
<div class="note note-info">
            <ul><li><p>Generally speaking, <u><em>querying a single doc</em></u> from MongoDB is faster than using <code>join</code> with MySQL.</p><blockquote><p>It’s easy to understand, join cross a lot of tables and it’s slow, while MongoDB stores the doc in a single collection.</p></blockquote></li><li><p><u><em>Querying a single document</em></u> from MongoDB is <strong><em>theoretically</em></strong> faster than querying a single row from MySQL in theory when <u>using secondary indexes and the queried columns are not covered by the indexes</u>.</p><blockquote><p>Be aware of that’s only ‘in theory’, the reason is MongoDB stores the disk pointer at the leaf nodes, while MySQL stores the primary key at the leaf nodes, thus MySQL has to do an extra lookup on the clustered index.</p></blockquote></li><li><p><u><em>Range query docs</em></u> from MongoDB is <strong><em>theoretically</em></strong> slower than range query rows from MySQL.</p><blockquote><p>The reason is the same as above, MySQL can use the clustered index to get the rows directly, while MongoDB has to do an extra lookup on the disk.</p></blockquote></li></ul><p>However, the real world is more complex, and the performance of the database is not just about the query speed. For example, the <code>join</code> in MySQL is slow, but it’s not a big deal if you have a small dataset.</p>
          </div>
</li>
<li>
<p><strong><em>Does MongoDB support ACID Tx?</em></strong><br>
Yes, and it makes MongoDB even more user-friendly.</p>
</li>
<li>
<p><strong><em>Does MySQL support JSON docs?</em></strong><br>
Yes, but still, it’s not as good as MySQL’s BSON. Cuz MySQL’s approach can detract from developer productivity, consider the following:</p>
<ul>
<li>You’ll have to spend time on learning the MySQL-specific SQL functions to access documents - not user-friendly enough.</li>
<li>You’re tied to the low-level drivers like JDBC - these layers impose high learning overhead.</li>
<li>MySQL drivers do not have the capability to properly and precisely convert JSON into a useful native data type used by the application.</li>
<li>MySQL cannot validate the schema of docs, while MongoDB can.</li>
</ul>
</li>
</ol>
<p>Anyway, the choice between MongoDB and MySQL is not a simple one, and it’s not just about performance. And in my daily work, I use <code>PostgreSQL</code> to store documents, too - I really spent some time on learning it(the SQLs, the functions and the column types), but for me it’s not a big deal :)</p>
<hr>
<h4 id="What-happens-when-a-doc-grows-larger">What happens when a doc grows larger?</h4>
<p>Since MongoDB is schema-less, we have the flexibility to append any data to a document as needed. This allows for dynamic growth, but it also raises important considerations regarding performance and storage efficiency.</p>
<p>The first question to consider is: <u>how does MongoDB store docs on disk</u>? We’re not going to explain it in detail, instead, let’s simplify it into this question: are those docs stored in a <strong><em>compact</em></strong> or <strong><em>sparse</em></strong> format?</p>
<div class="code-wrapper"><pre><code class="hljs text">Compact:
┌──────┬──────┬──────┬──────┐
│ doc1 │ doc2 │ doc3 │ doc4 │
└──────┴──────┴──────┴──────┘

Sparse:
┌──────┬──────┬──────┬──────┐
│ doc1 │ free │ doc2 │ free │
└──────┴──────┴──────┴──────┘</code></pre></div>
<p>From a common-sense perspective, a sparse format seems more reasonable. It allows data to be appended to a document without requiring the entire document to be relocated, though this comes at the cost of increased disk space usage.</p>
<p><u>But the truth is, <code>WiredTiger</code> uses the <strong><em>compact</em></strong> format to store documents on disk.</u></p>
<p>Before we dive in, it’s important to clarify one key point: “compact” does not imply absolute compaction. There is still some gap space between slots, but compared to a sparse format, these gaps are significantly smaller.</p>
<p>Each slot is allocated in sizes of 2^n, and since most documents are smaller than the allocated slot, there is usually some leftover space available for appending additional data.</p>
<p>So how does <code>WiredTiger</code> deal with the situation when a document gets larger than the slot?</p>
<p>It moves the doc elsewhere — often to the tail end of the available slots, and leaves a pointer in the original location to reference its new position:</p>
<div class="code-wrapper"><pre><code class="hljs text">┌──────┬──────┬──────┬──────┬──────────┐
│ doc1 │ ptr_ │ doc3 │ doc4 │ new_doc2 │
└──────┴──┬───┴──────┴──────┴──────────┘
          │                      ▲
          └──────────────────────┘</code></pre></div>
<p>And it’ll compact thoes fragmented slots in the background.</p>
<hr>
<p>Things are completely different in MySQL. Since MySQL enforces a schema, you must modify the table structure using DDL (Data Definition Language) before appending extra data to a row.</p>
<p>Basically there’re 2 ways to run DDL:</p>
<ol>
<li><code>INSTANT</code>, only modifies the metadata of the table, and the actual data is not moved.</li>
<li><code>COPY TABLE</code>, create a new temporary table, copy the data to the new table, and then swap the tables and delete the original one.</li>
</ol>
<p>The <code>COPY TABLE</code> approach is straightforward but comes with a major drawback—it’s slow.</p>
<p>On the other hand, the <code>INSTANT</code> method is extremely fast, but it may lead to increased page splits during future write operations.</p>
<p>E.g. If we execute this SQL query immediately after altering a row using the INSTANT method, it will still be super slow:</p>
<div class="code-wrapper"><pre><code class="hljs sql"><span class="hljs-keyword">alter table</span> userinfo <span class="hljs-keyword">add</span> new_col <span class="hljs-type">varchar</span>(<span class="hljs-number">255</span>) <span class="hljs-keyword">default</span> <span class="hljs-keyword">null</span>, ALGORITHM<span class="hljs-operator">=</span>INSTANT;

<span class="hljs-keyword">update</span> userinfo <span class="hljs-keyword">set</span> new_col <span class="hljs-operator">=</span> <span class="hljs-string">&#x27;xx&#x27;</span>; <span class="hljs-comment">-- this sql leads to a lot of page splits</span></code></pre></div>
<hr>
<h3 id="Docker-setup-instructions">Docker setup instructions</h3>
<h4 id="InfluxDB">InfluxDB</h4>
<p>To setup both cli and http console, follow these steps:</p>
<div class="code-wrapper"><pre><code class="hljs bash"><span class="hljs-comment"># pull latest image</span>
docker pull influxdb

<span class="hljs-comment"># start</span>
docker run -d \
  --name influxdb \
  -p 8086:8086 \
  influxdb:latest

<span class="hljs-comment"># go to the http console</span>
open localhost:8086

<span class="hljs-comment"># after setup, you should create an api token, and then:</span>
influx config create --config-name localtest \
    --host-url <span class="hljs-string">&quot;http://localhost:8086&quot;</span> \
    --org <span class="hljs-string">&quot;<span class="hljs-variable">$&#123;ORGNIZATION&#125;</span>&quot;</span> \
    --token <span class="hljs-string">&quot;<span class="hljs-variable">$&#123;API_TOKEN&#125;</span>&quot;</span> \
    --active

<span class="hljs-comment"># test it</span>
influx ping &amp;&amp; influx bucket <span class="hljs-built_in">ls</span></code></pre></div>
<hr>
<h2 id="Rust">Rust</h2>
<h3 id="Cross-Compile">Cross Compile</h3>
<p>See this blog: <a href="https://kayce.world/tech/rust_cross_compile_on_osx/">Rust Cross Compile on OSX</a></p>
<h2 id="Neovim">Neovim</h2>
<p>Check my NeoVim configuration <a target="_blank" rel="noopener" href="https://github.com/sshelll/dotconfigs/tree/master/nvim">here</a>.</p>
<h3 id="Lua-snippet">Lua snippet</h3>
<div class="code-wrapper"><pre><code class="hljs lua"><span class="hljs-comment">-- print debug info to another buf</span>
vim.cmd(<span class="hljs-string">&quot;new&quot;</span>)
<span class="hljs-keyword">local</span> buf = vim.api.nvim_get_current_buf()
vim.api.nvim_buf_set_lines(buf, <span class="hljs-number">0</span>, <span class="hljs-number">-1</span>, <span class="hljs-literal">false</span>, vim.split(vim.inspect(your_own_target), <span class="hljs-string">&quot;\n&quot;</span>))

<span class="hljs-keyword">local</span> buf = vim.api.nvim_create_buf(<span class="hljs-literal">false</span>, <span class="hljs-literal">true</span>)
vim.api.nvim_buf_set_lines(buf, <span class="hljs-number">0</span>, <span class="hljs-number">-1</span>, <span class="hljs-literal">false</span>, result)
vim.api.nvim_buf_set_option(buf, <span class="hljs-string">&quot;modifiable&quot;</span>, ext_opt.display_with_buf.modifiable) <span class="hljs-comment">-- deprecated</span>
vim.api.nvim_set_option_value(<span class="hljs-string">&quot;modifiable&quot;</span>, ext_opt.display_with_buf.modifiable, &#123; buf = buf &#125;)
vim.cmd(<span class="hljs-string">&#x27;botright &#x27;</span> .. ext_opt.display_with_buf.height .. <span class="hljs-string">&#x27; split | &#x27;</span> .. buf .. <span class="hljs-string">&#x27;buffer&#x27;</span>)</code></pre></div>
<h2 id="Common">Common</h2>
<h3 id="Git-Github-Setup">Git / Github Setup</h3>
<div class="code-wrapper"><pre><code class="hljs bash"><span class="hljs-comment"># generate ssh key pair and configure it on github settings</span>
ssh-keygen -t ed25519 -C <span class="hljs-string">&quot;your_email&quot;</span>

<span class="hljs-comment"># generate gpg key and configure it on github settings</span>
gpg --full-generate-key
gpg --list-secret-keys --keyid-format=long
gpg --armor --<span class="hljs-built_in">export</span> $(KEY_ID_OR_SUB_KEY_ID)</code></pre></div>
<p>To use different ssh/gpg keys on the same device on different repos, follow these steps:</p>
<div class="code-wrapper"><pre><code class="hljs bash"><span class="hljs-built_in">cd</span> repo
git config user.name <span class="hljs-string">&quot;your_name&quot;</span>
git config user.email <span class="hljs-string">&quot;your_email&quot;</span>
git config user.signingkey <span class="hljs-string">&quot;gpg_key_id&quot;</span>
git config commit.gpgsign <span class="hljs-literal">true</span>
ssh-add ~/.ssh/id_ed25519
ssh-add ~/.ssh/another_ssh_key</code></pre></div>
<p>And to pull different repos with different ssh keys, you should configure the ssh config like this:</p>
<div class="code-wrapper"><pre><code class="hljs text">Host github-work
    HostName github.com
    User git
    IdentityFile ~/.ssh/another_ssh_key</code></pre></div>
<p>After that, you should replace the original clone address to a new one:</p>
<div class="code-wrapper"><pre><code class="hljs bash"><span class="hljs-comment"># replace</span>
git <span class="hljs-built_in">clone</span> git@github.com:kayce/kayce.git
<span class="hljs-comment"># with</span>
git <span class="hljs-built_in">clone</span> git@github-work:kayce/kayce.git</code></pre></div>
<hr>
<h3 id="SSH">SSH</h3>
<p>Using proxy for ssh:</p>
<div class="code-wrapper"><pre><code class="hljs ssh_config">Host hertz-dev-server
    HostName 1.2.3.4
    User ubuntu
    ProxyCommand nc -X 5 -x 127.0.0.1:7897 %h %p
    ProxyCommand nc -X connect -x 127.0.0.1:7897 %h %p
    IdentityFile ~/.ssh/id_ed25519</code></pre></div>
<h3 id="Go-vendor-and-Makefile">Go vendor and Makefile</h3>
<p>We don’t want to run <code>go mod vendor</code> each time, we only want to run it when we modify the <code>go.mod</code> file.</p>
<div class="code-wrapper"><pre><code class="hljs make"><span class="hljs-section">tidy:</span>
	@go mod tidy

<span class="hljs-section">vendor: tidy vendor/modules.txt</span>

<span class="hljs-section">vendor/modules.txt: go.mod go.sum</span>
	<span class="hljs-comment"># use `vendor` to avoid `go get` in docker build</span>
	@go mod vendor</code></pre></div>
<hr>
<h3 id="Common-Sense">Common Sense</h3>
<ul>
<li>
<p>x86-64:<br>
The 64-bit version of the x86 architecture implemented by Intel and AMD processors used in the majority of laptops, desktops, servers, and some game consoles. While the originally 16-bit x86 architecture and its very popular 32-bit extension were developed by Intel, the 64-bit version that we now call x86-64 was initially an extension developed by AMD, often referred to as AMD64. Intel also developed its own 64-bit architecture, IA-64, but ended up adopting AMD’s more popular x86 extension instead (under the names IA-32e, EM64T, and later Intel 64).</p>
</li>
<li>
<p>ARM64:<br>
The 64-bit version of the ARM architecture used by nearly all modern mobile devices, high performance embedded systems, and also increasingly in recent laptops and desktops. It is also known as AArch64 and was introduced as part of ARMv8. Earlier (32-bit) versions of ARM, which are similar in many ways, are used in an even wider variety of applications. Many popular microcontrollers in every kind of embedded system imaginable, from cars to electronic COVID tests, are based on ARMv6 and ARMv7.</p>
</li>
</ul>
<hr>
<h3 id="Max-open-files-limit">Max open files limit</h3>
<p>One day I found that the <code>max open files limit</code> of my server was set to <code>1024</code>:</p>
<div class="code-wrapper"><pre><code class="hljs bash"><span class="hljs-built_in">ulimit</span> -n
1024

<span class="hljs-built_in">ulimit</span> -Hn
1048576</code></pre></div>
<p>And then I checked the java service process:</p>
<div class="code-wrapper"><pre><code class="hljs bash"><span class="hljs-built_in">cat</span> /proc/2562403/limits

Limit                     Soft Limit           Hard Limit           Units
Max open files            1048576              1048576              files</code></pre></div>
<p>I checked another rust process:</p>
<div class="code-wrapper"><pre><code class="hljs bash"><span class="hljs-built_in">cat</span> /proc/2562403/limits

Limit                     Soft Limit           Hard Limit           Units
Max open files            1024                 1048576              files</code></pre></div>
<p>As we can see, the <code>Max open files</code> limit of the <code>java</code> process was set to <code>1048576</code>, which was increased to the hard limit of the system. Both of them were set to <code>1048576</code>.</p>
<p>So I did a little bit research and figured out that was the <u>JVM default behavior</u>.</p>
<p>Check this out:</p>
<ul>
<li><a target="_blank" rel="noopener" href="https://stackoverflow.com/questions/30487284/how-and-when-and-where-jvm-change-the-max-open-files-value-of-linux">stackoverflow</a></li>
<li><a target="_blank" rel="noopener" href="https://access.redhat.com/solutions/1339423#:~:text=Issue-,Java%20process%20ignores%20the%20soft%20limit%20of%20%22open%20files%22%20%28%2C%2Dn%22%20of%20the%20user.%29">redhat</a></li>
</ul>
<hr>
<h3 id="Don’t-forget-ssh-agent">Don’t forget ssh-agent</h3>
<p>One day a colleague asked me why he couldn’t clone the git repo from github. I checked his github ssh key settings, and it’s all good.</p>
<p>Then I tried to regenerate a brand new ssh key pair and configured it in the github settings. But it still didn’t work.</p>
<p>I solved the problem by doing these steps:</p>
<div class="code-wrapper"><pre><code class="hljs bash"><span class="hljs-comment"># Check the ssh connection to github</span>
ssh -T git@github.com
<span class="hljs-comment"># The output was like this:</span>
<span class="hljs-comment"># Hi $&#123;another_guys_username&#125;! You&#x27;ve successfully authenticated, but GitHub does not provide shell access.</span>

<span class="hljs-comment"># Bingo! The reason must be that he forgot to clean the `ssh-agent`.</span>
<span class="hljs-comment"># So I checked with this command and of course, there was an old key in the agent:</span>
ssh-add -l

<span class="hljs-comment"># Finally, I removed the old key from the agent:</span>
ssh-add -D</code></pre></div>
<hr>
<h3 id="Tools">Tools</h3>
<div class="code-wrapper"><pre><code class="hljs bash"><span class="hljs-comment"># compress image</span>
magick before.png -resize 35% after.png

<span class="hljs-comment"># transcode audio</span>
ffmpeg -i path/to/input_audio.flac -ar 44100 -sample_fmt s16 path/to/output_audio.wav

<span class="hljs-comment"># convert flac to alac</span>
xld -o ~/Downloads song.flac -f alac</code></pre></div>
<hr>
<h3 id="Mac">Mac</h3>
<p>to change the password of root: the <code>Directory Utility.app</code></p>
<h2 id="Simple-Math">Simple Math</h2>
<p>I’ve been doing some practicing(kata) on Codewars, and I’ve noticed that there’re some frequently used math tricks / formulas.</p>
<h3 id="GCD-LCM">GCD / LCM</h3>
<div class="code-wrapper"><pre><code class="hljs go"><span class="hljs-comment">// gcd(a, b) = gcd(b, a % b)</span>
<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">gcd</span><span class="hljs-params">(a, b *big.Int)</span></span> *big.Int &#123;
	<span class="hljs-keyword">for</span> b.Cmp(big.NewInt(<span class="hljs-number">0</span>)) != <span class="hljs-number">0</span> &#123;
		a, b = b, <span class="hljs-built_in">new</span>(big.Int).Mod(a, b)
	&#125;
	<span class="hljs-keyword">return</span> a
&#125;

<span class="hljs-comment">// (a * b) / gcd(a, b)</span>
<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">lcm</span><span class="hljs-params">(a, b *big.Int)</span></span> *big.Int &#123;
	<span class="hljs-keyword">return</span> <span class="hljs-built_in">new</span>(big.Int).Div(<span class="hljs-built_in">new</span>(big.Int).Mul(a, b), gcd(a, b))
&#125;</code></pre></div>
<hr>
<h3 id="Prime">Prime</h3>
<div class="code-wrapper"><pre><code class="hljs rust"><span class="hljs-comment">// gen prime of [0, m]</span>
<span class="hljs-keyword">fn</span> <span class="hljs-title function_">gen_prime</span>(m: <span class="hljs-type">u64</span>) <span class="hljs-punctuation">-&gt;</span> <span class="hljs-type">Vec</span>&lt;<span class="hljs-type">u64</span>&gt; &#123;
    <span class="hljs-keyword">let</span> <span class="hljs-keyword">mut </span><span class="hljs-variable">primes</span> = <span class="hljs-built_in">vec!</span>[<span class="hljs-number">2</span>];
    <span class="hljs-keyword">for</span> <span class="hljs-variable">i</span> <span class="hljs-keyword">in</span> (<span class="hljs-number">3</span>..m).<span class="hljs-title function_ invoke__">step_by</span>(<span class="hljs-number">2</span>) &#123;
        <span class="hljs-keyword">let</span> <span class="hljs-keyword">mut </span><span class="hljs-variable">is_prime</span> = <span class="hljs-literal">true</span>;
        <span class="hljs-keyword">for</span> &amp;p <span class="hljs-keyword">in</span> &amp;primes &#123;
            <span class="hljs-keyword">if</span> p * p &gt; i &#123;
                <span class="hljs-keyword">break</span>;
            &#125;
            <span class="hljs-keyword">if</span> i % p == <span class="hljs-number">0</span> &#123;
                is_prime = <span class="hljs-literal">false</span>;
                <span class="hljs-keyword">break</span>;
            &#125;
        &#125;
        <span class="hljs-keyword">if</span> is_prime &#123;
            primes.<span class="hljs-title function_ invoke__">push</span>(i);
        &#125;
    &#125;
    primes
&#125;

<span class="hljs-comment">// find the prime divisors of n</span>
<span class="hljs-keyword">fn</span> <span class="hljs-title function_">prime_factors</span>(<span class="hljs-keyword">mut</span> n: <span class="hljs-type">u64</span>) <span class="hljs-punctuation">-&gt;</span> HashMap&lt;<span class="hljs-type">u64</span>, <span class="hljs-type">u64</span>&gt; &#123;
    <span class="hljs-keyword">let</span> <span class="hljs-keyword">mut </span><span class="hljs-variable">factors</span> = HashMap::<span class="hljs-title function_ invoke__">new</span>();
    <span class="hljs-keyword">let</span> <span class="hljs-keyword">mut </span><span class="hljs-variable">divisor</span> = <span class="hljs-number">2</span>;

    <span class="hljs-keyword">while</span> n &gt;= divisor * divisor &#123;
        <span class="hljs-keyword">while</span> n % divisor == <span class="hljs-number">0</span> &#123;
            *factors.<span class="hljs-title function_ invoke__">entry</span>(divisor).<span class="hljs-title function_ invoke__">or_insert</span>(<span class="hljs-number">0</span>) += <span class="hljs-number">1</span>;
            n /= divisor;
        &#125;
        divisor += <span class="hljs-number">1</span>;
    &#125;

    <span class="hljs-keyword">if</span> n &gt; <span class="hljs-number">1</span> &#123;
        *factors.<span class="hljs-title function_ invoke__">entry</span>(n).<span class="hljs-title function_ invoke__">or_insert</span>(<span class="hljs-number">0</span>) += <span class="hljs-number">1</span>;
    &#125;

    factors
&#125;</code></pre></div>
<hr>
<h3 id="Bit-Op">Bit Op</h3>
<ul>
<li>xor</li>
</ul>
<div class="code-wrapper"><pre><code class="hljs rust"><span class="hljs-keyword">fn</span> <span class="hljs-title function_">xor_encrypt_decrypt</span>(data: &amp;<span class="hljs-type">str</span>, key: <span class="hljs-type">u8</span>) <span class="hljs-punctuation">-&gt;</span> <span class="hljs-type">String</span> &#123;
    data.<span class="hljs-title function_ invoke__">chars</span>().<span class="hljs-title function_ invoke__">map</span>(|c| (c <span class="hljs-keyword">as</span> <span class="hljs-type">u8</span> ^ key) <span class="hljs-keyword">as</span> <span class="hljs-type">char</span>).<span class="hljs-title function_ invoke__">collect</span>()
&#125;

<span class="hljs-keyword">fn</span> <span class="hljs-title function_">xor_swap</span>(a: &amp;<span class="hljs-keyword">mut</span> <span class="hljs-type">u8</span>, b: &amp;<span class="hljs-keyword">mut</span> <span class="hljs-type">u8</span>) &#123;
    *a ^= *b;
    *b ^= *a;
    *a ^= *b;
&#125;

<span class="hljs-keyword">fn</span> <span class="hljs-title function_">xor_find_once_in_twice</span>(arr: &amp;[<span class="hljs-type">u8</span>]) <span class="hljs-punctuation">-&gt;</span> <span class="hljs-type">u8</span> &#123;
    arr.<span class="hljs-title function_ invoke__">iter</span>().<span class="hljs-title function_ invoke__">fold</span>(<span class="hljs-number">0</span>, |acc, &amp;x| acc ^ x)
&#125;

<span class="hljs-keyword">fn</span> <span class="hljs-title function_">xor_bit_flip</span>(bit: <span class="hljs-type">u8</span>) <span class="hljs-punctuation">-&gt;</span> <span class="hljs-type">u8</span> &#123;
    <span class="hljs-keyword">static</span> MASK: <span class="hljs-type">u8</span> = <span class="hljs-number">0b11111111</span>;
    bit ^ MASK
&#125;

<span class="hljs-keyword">fn</span> <span class="hljs-title function_">xor_checksum</span>(data: &amp;[<span class="hljs-type">u8</span>]) <span class="hljs-punctuation">-&gt;</span> <span class="hljs-type">u8</span> &#123;
    data.<span class="hljs-title function_ invoke__">iter</span>().<span class="hljs-title function_ invoke__">fold</span>(<span class="hljs-number">0</span>, |acc, &amp;x| acc ^ x)
&#125;</code></pre></div>
<hr>
<h3 id="Which-x-for-that-sum">Which x for that sum?</h3>
<p>This is a Codewars kata, you can find it <a target="_blank" rel="noopener" href="https://www.codewars.com/kata/5b1cd19fcd206af728000056">here</a>.</p>
<p>Actually this isn’t that ‘simple’… Cuz I almost forgot those math fundamentals. <strong>And thanks to the ChatGPT which helped me solve this kata!!! (•`_´•)!!!</strong></p>
<p>Consider we have a sum of the num sequence below:</p>
<p class="katex-block "><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><mi>S</mi><mi>u</mi><mi>m</mi><mo>=</mo><mi>x</mi><mo>+</mo><mn>2</mn><msup><mi>x</mi><mn>2</mn></msup><mo>+</mo><mn>3</mn><msup><mi>x</mi><mn>3</mn></msup><mo>+</mo><mtext>...</mtext><mo>+</mo><mi>n</mi><msup><mi>x</mi><mi>n</mi></msup></mrow><annotation encoding="application/x-tex">Sum = x + 2x^2 + 3x^3 + \text{...} + nx^n
</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord mathnormal" style="margin-right:0.05764em;">S</span><span class="mord mathnormal">u</span><span class="mord mathnormal">m</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.6667em;vertical-align:-0.0833em;"></span><span class="mord mathnormal">x</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:0.9474em;vertical-align:-0.0833em;"></span><span class="mord">2</span><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8641em;"><span style="top:-3.113em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:0.9474em;vertical-align:-0.0833em;"></span><span class="mord">3</span><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8641em;"><span style="top:-3.113em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">3</span></span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:0.6667em;vertical-align:-0.0833em;"></span><span class="mord text"><span class="mord">...</span></span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:0.7144em;"></span><span class="mord mathnormal">n</span><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.7144em;"><span style="top:-3.113em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">n</span></span></span></span></span></span></span></span></span></span></span></span></p>
<p>We can convert it into:</p>
<p class="katex-block "><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><munderover><mo>∑</mo><mrow><mi>k</mi><mo>=</mo><mn>1</mn></mrow><mi>n</mi></munderover><mrow><mi>k</mi><msup><mi>x</mi><mi>k</mi></msup></mrow></mrow><annotation encoding="application/x-tex">\sum_{k=1}^n{kx^k}
</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:2.9535em;vertical-align:-1.3021em;"></span><span class="mop op-limits"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.6514em;"><span style="top:-1.8479em;margin-left:0em;"><span class="pstrut" style="height:3.05em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.03148em;">k</span><span class="mrel mtight">=</span><span class="mord mtight">1</span></span></span></span><span style="top:-3.05em;"><span class="pstrut" style="height:3.05em;"></span><span><span class="mop op-symbol large-op">∑</span></span></span><span style="top:-4.3em;margin-left:0em;"><span class="pstrut" style="height:3.05em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">n</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:1.3021em;"><span></span></span></span></span></span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.03148em;">k</span><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8991em;"><span style="top:-3.113em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.03148em;">k</span></span></span></span></span></span></span></span></span></span></span></span></span></p>
<p>And when <code>x</code> in its domain of convergence, the sum goes to a finite limit depending on <code>x</code>(when <code>n</code> goes to infinite). <u><strong>Now with the given <code>Sum</code>, how to calculate the value of <code>x</code></strong></u>?</p>
<ol>
<li>
<p>Before we start, we could easily tell that <code>abs(x) &lt; 1</code>, otherwise the sum should be infinite.</p>
</li>
<li>
<p>First let’s consider the sum this sequence:</p>
<p class="katex-block "><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><munderover><mo>∑</mo><mrow><mi>k</mi><mo>=</mo><mn>0</mn></mrow><mi>n</mi></munderover><msup><mi>x</mi><mi>k</mi></msup><mo>=</mo><mn>1</mn><mo>+</mo><mi>x</mi><mo>+</mo><msup><mi>x</mi><mn>2</mn></msup><mo>+</mo><mtext>...</mtext><mo>+</mo><msup><mi>x</mi><mi>n</mi></msup></mrow><annotation encoding="application/x-tex">\sum_{k=0}^n{x^k} = 1 + x + x^2 + \text{...} + x^n
</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:2.9535em;vertical-align:-1.3021em;"></span><span class="mop op-limits"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.6514em;"><span style="top:-1.8479em;margin-left:0em;"><span class="pstrut" style="height:3.05em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.03148em;">k</span><span class="mrel mtight">=</span><span class="mord mtight">0</span></span></span></span><span style="top:-3.05em;"><span class="pstrut" style="height:3.05em;"></span><span><span class="mop op-symbol large-op">∑</span></span></span><span style="top:-4.3em;margin-left:0em;"><span class="pstrut" style="height:3.05em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">n</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:1.3021em;"><span></span></span></span></span></span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord"><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8991em;"><span style="top:-3.113em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.03148em;">k</span></span></span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.7278em;vertical-align:-0.0833em;"></span><span class="mord">1</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:0.6667em;vertical-align:-0.0833em;"></span><span class="mord mathnormal">x</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:0.9474em;vertical-align:-0.0833em;"></span><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8641em;"><span style="top:-3.113em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:0.6667em;vertical-align:-0.0833em;"></span><span class="mord text"><span class="mord">...</span></span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:0.7144em;"></span><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.7144em;"><span style="top:-3.113em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">n</span></span></span></span></span></span></span></span></span></span></span></span></p>
<p>With this formula:</p>
<p class="katex-block "><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><msub><mi>S</mi><mi>n</mi></msub><mo>=</mo><mfrac><mrow><mi>a</mi><mo stretchy="false">(</mo><mn>1</mn><mo>−</mo><msup><mi>r</mi><mi>n</mi></msup><mo stretchy="false">)</mo></mrow><mrow><mn>1</mn><mo>−</mo><mi>r</mi></mrow></mfrac></mrow><annotation encoding="application/x-tex">S_n = \frac{a(1-r^n)}{1-r}
</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8333em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.05764em;">S</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.1514em;"><span style="top:-2.55em;margin-left:-0.0576em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">n</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:2.1963em;vertical-align:-0.7693em;"></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.427em;"><span style="top:-2.314em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord">1</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mord mathnormal" style="margin-right:0.02778em;">r</span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"></span><span class="frac-line" style="border-bottom-width:0.04em;"></span></span><span style="top:-3.677em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord mathnormal">a</span><span class="mopen">(</span><span class="mord">1</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.02778em;">r</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.6644em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">n</span></span></span></span></span></span></span></span><span class="mclose">)</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.7693em;"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span></span></span></span></span></p>
<p>We got:</p>
<p class="katex-block "><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><munderover><mo>∑</mo><mrow><mi>k</mi><mo>=</mo><mn>1</mn></mrow><mi>n</mi></munderover><msup><mi>x</mi><mi>k</mi></msup><mo>=</mo><mfrac><mrow><mn>1</mn><mo stretchy="false">(</mo><mn>1</mn><mo>−</mo><msup><mi>x</mi><mi>n</mi></msup><mo stretchy="false">)</mo></mrow><mrow><mn>1</mn><mo>−</mo><mi>x</mi></mrow></mfrac><mo>=</mo><mfrac><mrow><mn>1</mn><mo>−</mo><msup><mi>x</mi><mi>n</mi></msup></mrow><mrow><mn>1</mn><mo>−</mo><mi>x</mi></mrow></mfrac></mrow><annotation encoding="application/x-tex">\sum_{k=1}^n{x^k} = \frac{1(1-x^n)}{1-x} = \frac{1-x^n}{1-x}
</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:2.9535em;vertical-align:-1.3021em;"></span><span class="mop op-limits"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.6514em;"><span style="top:-1.8479em;margin-left:0em;"><span class="pstrut" style="height:3.05em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.03148em;">k</span><span class="mrel mtight">=</span><span class="mord mtight">1</span></span></span></span><span style="top:-3.05em;"><span class="pstrut" style="height:3.05em;"></span><span><span class="mop op-symbol large-op">∑</span></span></span><span style="top:-4.3em;margin-left:0em;"><span class="pstrut" style="height:3.05em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">n</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:1.3021em;"><span></span></span></span></span></span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord"><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8991em;"><span style="top:-3.113em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.03148em;">k</span></span></span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:2.1963em;vertical-align:-0.7693em;"></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.427em;"><span style="top:-2.314em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord">1</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mord mathnormal">x</span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"></span><span class="frac-line" style="border-bottom-width:0.04em;"></span></span><span style="top:-3.677em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord">1</span><span class="mopen">(</span><span class="mord">1</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.6644em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">n</span></span></span></span></span></span></span></span><span class="mclose">)</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.7693em;"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:2.1107em;vertical-align:-0.7693em;"></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.3414em;"><span style="top:-2.314em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord">1</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mord mathnormal">x</span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"></span><span class="frac-line" style="border-bottom-width:0.04em;"></span></span><span style="top:-3.677em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord">1</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.6644em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">n</span></span></span></span></span></span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.7693em;"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span></span></span></span></span></p>
<p>And when <code>n</code> goes infinity:</p>
<p class="katex-block "><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><munderover><mo>∑</mo><mrow><mi>k</mi><mo>=</mo><mn>1</mn></mrow><mi mathvariant="normal">∞</mi></munderover><msup><mi>x</mi><mi>k</mi></msup><mo>=</mo><mfrac><mrow><mn>1</mn><mo>−</mo><msup><mi>x</mi><mi>n</mi></msup></mrow><mrow><mn>1</mn><mo>−</mo><mi>x</mi></mrow></mfrac><mo>=</mo><mfrac><mn>1</mn><mrow><mn>1</mn><mo>−</mo><mi>x</mi></mrow></mfrac><mo stretchy="false">(</mo><mtext>cuz </mtext><msup><mi>x</mi><mi>n</mi></msup><mtext> goes to 0</mtext><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">\sum_{k=1}^\infty{x^k} = \frac{1-x^n}{1-x} = \frac{1}{1-x}
(\text{cuz } x^n \text{ goes to 0})
</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:2.9535em;vertical-align:-1.3021em;"></span><span class="mop op-limits"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.6514em;"><span style="top:-1.8479em;margin-left:0em;"><span class="pstrut" style="height:3.05em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.03148em;">k</span><span class="mrel mtight">=</span><span class="mord mtight">1</span></span></span></span><span style="top:-3.05em;"><span class="pstrut" style="height:3.05em;"></span><span><span class="mop op-symbol large-op">∑</span></span></span><span style="top:-4.3em;margin-left:0em;"><span class="pstrut" style="height:3.05em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">∞</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:1.3021em;"><span></span></span></span></span></span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord"><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8991em;"><span style="top:-3.113em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.03148em;">k</span></span></span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:2.1107em;vertical-align:-0.7693em;"></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.3414em;"><span style="top:-2.314em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord">1</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mord mathnormal">x</span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"></span><span class="frac-line" style="border-bottom-width:0.04em;"></span></span><span style="top:-3.677em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord">1</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.6644em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">n</span></span></span></span></span></span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.7693em;"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:2.0908em;vertical-align:-0.7693em;"></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.3214em;"><span style="top:-2.314em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord">1</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mord mathnormal">x</span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"></span><span class="frac-line" style="border-bottom-width:0.04em;"></span></span><span style="top:-3.677em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.7693em;"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span><span class="mopen">(</span><span class="mord text"><span class="mord">cuz </span></span><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.7144em;"><span style="top:-3.113em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">n</span></span></span></span></span></span></span></span><span class="mord text"><span class="mord"> goes to 0</span></span><span class="mclose">)</span></span></span></span></span></p>
</li>
<li>
<p>Now let’s calculate the derivative of this sum:</p>
<p>First let’s cal the left side:</p>
<p class="katex-block "><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><mfrac><mi>d</mi><mrow><mi>d</mi><mi>x</mi></mrow></mfrac><munderover><mo>∑</mo><mrow><mi>k</mi><mo>=</mo><mn>1</mn></mrow><mi mathvariant="normal">∞</mi></munderover><msup><mi>x</mi><mi>k</mi></msup><mo>=</mo><munderover><mo>∑</mo><mrow><mi>k</mi><mo>=</mo><mn>1</mn></mrow><mi mathvariant="normal">∞</mi></munderover><mrow><mi>k</mi><msup><mi>x</mi><mrow><mi>k</mi><mo>−</mo><mn>1</mn></mrow></msup></mrow></mrow><annotation encoding="application/x-tex">\frac{d}{dx}\sum_{k=1}^\infty{x^k} = \sum_{k=1}^\infty{kx^{k-1}}
</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:2.9535em;vertical-align:-1.3021em;"></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.3714em;"><span style="top:-2.314em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord mathnormal">d</span><span class="mord mathnormal">x</span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"></span><span class="frac-line" style="border-bottom-width:0.04em;"></span></span><span style="top:-3.677em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord mathnormal">d</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.686em;"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mop op-limits"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.6514em;"><span style="top:-1.8479em;margin-left:0em;"><span class="pstrut" style="height:3.05em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.03148em;">k</span><span class="mrel mtight">=</span><span class="mord mtight">1</span></span></span></span><span style="top:-3.05em;"><span class="pstrut" style="height:3.05em;"></span><span><span class="mop op-symbol large-op">∑</span></span></span><span style="top:-4.3em;margin-left:0em;"><span class="pstrut" style="height:3.05em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">∞</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:1.3021em;"><span></span></span></span></span></span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord"><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8991em;"><span style="top:-3.113em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.03148em;">k</span></span></span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:2.9535em;vertical-align:-1.3021em;"></span><span class="mop op-limits"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.6514em;"><span style="top:-1.8479em;margin-left:0em;"><span class="pstrut" style="height:3.05em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.03148em;">k</span><span class="mrel mtight">=</span><span class="mord mtight">1</span></span></span></span><span style="top:-3.05em;"><span class="pstrut" style="height:3.05em;"></span><span><span class="mop op-symbol large-op">∑</span></span></span><span style="top:-4.3em;margin-left:0em;"><span class="pstrut" style="height:3.05em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">∞</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:1.3021em;"><span></span></span></span></span></span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.03148em;">k</span><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8991em;"><span style="top:-3.113em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.03148em;">k</span><span class="mbin mtight">−</span><span class="mord mtight">1</span></span></span></span></span></span></span></span></span></span></span></span></span></span></p>
<p>Now the right side:</p>
<p class="katex-block "><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><mfrac><mi>d</mi><mrow><mi>d</mi><mi>x</mi></mrow></mfrac><mfrac><mn>1</mn><mrow><mn>1</mn><mo>−</mo><mi>x</mi></mrow></mfrac><mo>=</mo><mfrac><mn>1</mn><mrow><mo stretchy="false">(</mo><mn>1</mn><mo>−</mo><mi>x</mi><msup><mo stretchy="false">)</mo><mn>2</mn></msup></mrow></mfrac></mrow><annotation encoding="application/x-tex">\frac{d}{dx}\frac{1}{1-x} = \frac{1}{(1-x)^2}
</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:2.1408em;vertical-align:-0.7693em;"></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.3714em;"><span style="top:-2.314em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord mathnormal">d</span><span class="mord mathnormal">x</span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"></span><span class="frac-line" style="border-bottom-width:0.04em;"></span></span><span style="top:-3.677em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord mathnormal">d</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.686em;"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.3214em;"><span style="top:-2.314em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord">1</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mord mathnormal">x</span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"></span><span class="frac-line" style="border-bottom-width:0.04em;"></span></span><span style="top:-3.677em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.7693em;"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:2.2574em;vertical-align:-0.936em;"></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.3214em;"><span style="top:-2.314em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mopen">(</span><span class="mord">1</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mord mathnormal">x</span><span class="mclose"><span class="mclose">)</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.7401em;"><span style="top:-2.989em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span></span></span></span></span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"></span><span class="frac-line" style="border-bottom-width:0.04em;"></span></span><span style="top:-3.677em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.936em;"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span></span></span></span></span></p>
<p>So we have:</p>
<p class="katex-block "><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><munderover><mo>∑</mo><mrow><mi>k</mi><mo>=</mo><mn>1</mn></mrow><mi mathvariant="normal">∞</mi></munderover><mrow><mi>k</mi><msup><mi>x</mi><mrow><mi>k</mi><mo>−</mo><mn>1</mn></mrow></msup></mrow><mo>=</mo><mfrac><mn>1</mn><mrow><mo stretchy="false">(</mo><mn>1</mn><mo>−</mo><mi>x</mi><msup><mo stretchy="false">)</mo><mn>2</mn></msup></mrow></mfrac></mrow><annotation encoding="application/x-tex">\sum_{k=1}^\infty{kx^{k-1}} = \frac{1}{(1-x)^2}
</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:2.9535em;vertical-align:-1.3021em;"></span><span class="mop op-limits"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.6514em;"><span style="top:-1.8479em;margin-left:0em;"><span class="pstrut" style="height:3.05em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.03148em;">k</span><span class="mrel mtight">=</span><span class="mord mtight">1</span></span></span></span><span style="top:-3.05em;"><span class="pstrut" style="height:3.05em;"></span><span><span class="mop op-symbol large-op">∑</span></span></span><span style="top:-4.3em;margin-left:0em;"><span class="pstrut" style="height:3.05em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">∞</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:1.3021em;"><span></span></span></span></span></span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.03148em;">k</span><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8991em;"><span style="top:-3.113em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.03148em;">k</span><span class="mbin mtight">−</span><span class="mord mtight">1</span></span></span></span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:2.2574em;vertical-align:-0.936em;"></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.3214em;"><span style="top:-2.314em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mopen">(</span><span class="mord">1</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mord mathnormal">x</span><span class="mclose"><span class="mclose">)</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.7401em;"><span style="top:-2.989em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span></span></span></span></span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"></span><span class="frac-line" style="border-bottom-width:0.04em;"></span></span><span style="top:-3.677em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.936em;"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span></span></span></span></span></p>
<p>We almost got there! Now we only need to plus x to both side, we can get the original formula:</p>
<p class="katex-block "><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><munderover><mo>∑</mo><mrow><mi>k</mi><mo>=</mo><mn>1</mn></mrow><mi mathvariant="normal">∞</mi></munderover><mrow><mi>k</mi><msup><mi>x</mi><mi>k</mi></msup></mrow><mo>=</mo><mfrac><mi>x</mi><mrow><mo stretchy="false">(</mo><mn>1</mn><mo>−</mo><mi>x</mi><msup><mo stretchy="false">)</mo><mn>2</mn></msup></mrow></mfrac></mrow><annotation encoding="application/x-tex">\sum_{k=1}^\infty{kx^{k}} = \frac{x}{(1-x)^2}
</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:2.9535em;vertical-align:-1.3021em;"></span><span class="mop op-limits"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.6514em;"><span style="top:-1.8479em;margin-left:0em;"><span class="pstrut" style="height:3.05em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.03148em;">k</span><span class="mrel mtight">=</span><span class="mord mtight">1</span></span></span></span><span style="top:-3.05em;"><span class="pstrut" style="height:3.05em;"></span><span><span class="mop op-symbol large-op">∑</span></span></span><span style="top:-4.3em;margin-left:0em;"><span class="pstrut" style="height:3.05em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">∞</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:1.3021em;"><span></span></span></span></span></span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.03148em;">k</span><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8991em;"><span style="top:-3.113em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.03148em;">k</span></span></span></span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:2.0436em;vertical-align:-0.936em;"></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.1076em;"><span style="top:-2.314em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mopen">(</span><span class="mord">1</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mord mathnormal">x</span><span class="mclose"><span class="mclose">)</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.7401em;"><span style="top:-2.989em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span></span></span></span></span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"></span><span class="frac-line" style="border-bottom-width:0.04em;"></span></span><span style="top:-3.677em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord mathnormal">x</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.936em;"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span></span></span></span></span></p>
</li>
<li>
<p>Finally, all we need to do is solve the equation:</p>
<p class="katex-block "><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><mfrac><mi>x</mi><mrow><mo stretchy="false">(</mo><mn>1</mn><mo>−</mo><mi>x</mi><msup><mo stretchy="false">)</mo><mn>2</mn></msup></mrow></mfrac><mo>=</mo><mi>S</mi><mo stretchy="false">(</mo><mtext>given already</mtext><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">\frac{x}{(1-x)^2} = S(\text{given already})
</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:2.0436em;vertical-align:-0.936em;"></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.1076em;"><span style="top:-2.314em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mopen">(</span><span class="mord">1</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mord mathnormal">x</span><span class="mclose"><span class="mclose">)</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.7401em;"><span style="top:-2.989em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span></span></span></span></span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"></span><span class="frac-line" style="border-bottom-width:0.04em;"></span></span><span style="top:-3.677em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord mathnormal">x</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.936em;"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal" style="margin-right:0.05764em;">S</span><span class="mopen">(</span><span class="mord text"><span class="mord">given already</span></span><span class="mclose">)</span></span></span></span></span></p>
<p>we get:</p>
<p class="katex-block "><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><mi>x</mi><mo>=</mo><mfrac><mrow><mo stretchy="false">(</mo><mn>2</mn><mi>S</mi><mo>+</mo><mn>1</mn><mo stretchy="false">)</mo><mo>±</mo><msqrt><mrow><mn>4</mn><mi>S</mi><mo>+</mo><mn>1</mn></mrow></msqrt></mrow><mrow><mn>2</mn><mi>S</mi></mrow></mfrac></mrow><annotation encoding="application/x-tex">x = \frac{(2S + 1) \pm \sqrt{4S + 1}}{2S}
</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.4306em;"></span><span class="mord mathnormal">x</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:2.248em;vertical-align:-0.686em;"></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.562em;"><span style="top:-2.314em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord">2</span><span class="mord mathnormal" style="margin-right:0.05764em;">S</span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"></span><span class="frac-line" style="border-bottom-width:0.04em;"></span></span><span style="top:-3.677em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mopen">(</span><span class="mord">2</span><span class="mord mathnormal" style="margin-right:0.05764em;">S</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mord">1</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">±</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mord sqrt"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.885em;"><span class="svg-align" style="top:-3em;"><span class="pstrut" style="height:3em;"></span><span class="mord" style="padding-left:0.833em;"><span class="mord">4</span><span class="mord mathnormal" style="margin-right:0.05764em;">S</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mord">1</span></span></span><span style="top:-2.845em;"><span class="pstrut" style="height:3em;"></span><span class="hide-tail" style="min-width:0.853em;height:1.08em;"><svg xmlns="http://www.w3.org/2000/svg" width="400em" height="1.08em" viewBox="0 0 400000 1080" preserveAspectRatio="xMinYMin slice"><path d="M95,702
c-2.7,0,-7.17,-2.7,-13.5,-8c-5.8,-5.3,-9.5,-10,-9.5,-14
c0,-2,0.3,-3.3,1,-4c1.3,-2.7,23.83,-20.7,67.5,-54
c44.2,-33.3,65.8,-50.3,66.5,-51c1.3,-1.3,3,-2,5,-2c4.7,0,8.7,3.3,12,10
s173,378,173,378c0.7,0,35.3,-71,104,-213c68.7,-142,137.5,-285,206.5,-429
c69,-144,104.5,-217.7,106.5,-221
l0 -0
c5.3,-9.3,12,-14,20,-14
H400000v40H845.2724
s-225.272,467,-225.272,467s-235,486,-235,486c-2.7,4.7,-9,7,-19,7
c-6,0,-10,-1,-12,-3s-194,-422,-194,-422s-65,47,-65,47z
M834 80h400000v40h-400000z"/></svg></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.155em;"><span></span></span></span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.686em;"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span></span></span></span></span></p>
<p>for <code>abs(x) &lt; 1</code>, we should choose this answer:</p>
<p class="katex-block "><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><mi>x</mi><mo>=</mo><mfrac><mrow><mo stretchy="false">(</mo><mn>2</mn><mi>S</mi><mo>+</mo><mn>1</mn><mo stretchy="false">)</mo><mo>−</mo><msqrt><mrow><mn>4</mn><mi>S</mi><mo>+</mo><mn>1</mn></mrow></msqrt></mrow><mrow><mn>2</mn><mi>S</mi></mrow></mfrac></mrow><annotation encoding="application/x-tex">x = \frac{(2S + 1) - \sqrt{4S + 1}}{2S}
</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.4306em;"></span><span class="mord mathnormal">x</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:2.248em;vertical-align:-0.686em;"></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.562em;"><span style="top:-2.314em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord">2</span><span class="mord mathnormal" style="margin-right:0.05764em;">S</span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"></span><span class="frac-line" style="border-bottom-width:0.04em;"></span></span><span style="top:-3.677em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mopen">(</span><span class="mord">2</span><span class="mord mathnormal" style="margin-right:0.05764em;">S</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mord">1</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mord sqrt"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.885em;"><span class="svg-align" style="top:-3em;"><span class="pstrut" style="height:3em;"></span><span class="mord" style="padding-left:0.833em;"><span class="mord">4</span><span class="mord mathnormal" style="margin-right:0.05764em;">S</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mord">1</span></span></span><span style="top:-2.845em;"><span class="pstrut" style="height:3em;"></span><span class="hide-tail" style="min-width:0.853em;height:1.08em;"><svg xmlns="http://www.w3.org/2000/svg" width="400em" height="1.08em" viewBox="0 0 400000 1080" preserveAspectRatio="xMinYMin slice"><path d="M95,702
c-2.7,0,-7.17,-2.7,-13.5,-8c-5.8,-5.3,-9.5,-10,-9.5,-14
c0,-2,0.3,-3.3,1,-4c1.3,-2.7,23.83,-20.7,67.5,-54
c44.2,-33.3,65.8,-50.3,66.5,-51c1.3,-1.3,3,-2,5,-2c4.7,0,8.7,3.3,12,10
s173,378,173,378c0.7,0,35.3,-71,104,-213c68.7,-142,137.5,-285,206.5,-429
c69,-144,104.5,-217.7,106.5,-221
l0 -0
c5.3,-9.3,12,-14,20,-14
H400000v40H845.2724
s-225.272,467,-225.272,467s-235,486,-235,486c-2.7,4.7,-9,7,-19,7
c-6,0,-10,-1,-12,-3s-194,-422,-194,-422s-65,47,-65,47z
M834 80h400000v40h-400000z"/></svg></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.155em;"><span></span></span></span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.686em;"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span></span></span></span></span></p>
<p>So the final code is:</p>
<div class="code-wrapper"><pre><code class="hljs rust"><span class="hljs-keyword">fn</span> <span class="hljs-title function_">solve</span>(S: <span class="hljs-type">f64</span>) <span class="hljs-punctuation">-&gt;</span> <span class="hljs-type">f64</span> &#123;
    ((<span class="hljs-number">2.0</span> * S + <span class="hljs-number">1.0</span>) - (<span class="hljs-number">4.0</span> * S + <span class="hljs-number">1.0</span>).<span class="hljs-title function_ invoke__">sqrt</span>()) / (<span class="hljs-number">2.0</span> * S)
&#125;</code></pre></div>
</li>
</ol>
<hr>
<h3 id="Power-Tower">Power Tower</h3>
<p>I ain’t gonna lie, it’s out of my league :-(</p>
<p>See this <a target="_blank" rel="noopener" href="https://www.codewars.com/kata/5518a860a73e708c0a000027/rust">kata</a>.</p>
<p>There are two important corollaries:</p>
<ol>
<li>
<p>(HARD) When we consider a number as a base, its behavior under the modulo 10 system depends only on its value under the modulo 20 systems.<br>
For example:</p>
<div class="code-wrapper"><pre><code class="hljs text">21^1 % 10 = 1^1 % 10
21^2 % 10 = 1^2 % 10
21^3 % 10 = 1^3 % 10</code></pre></div>
</li>
<li>
<p>(EASY) The last number of power calculation is periodic, and the period could reach to 4.<br>
For example:</p>
<div class="code-wrapper"><pre><code class="hljs text">0 = [0]
1 = [1]
2 = [2, 4, 8, 6, ...]
3 = [3, 9, 7, 1, ...]
4 = [4, 6, ...]
5 = [5]
6 = [6]
7 = [7, 9, 3, 1, ...]
8 = [8, 4, 2, 6, ...]
9 = [9, 1, ...]</code></pre></div>
</li>
</ol>
<p>With these two corollaries, we can easily solve this kata:</p>
<div class="code-wrapper"><pre><code class="hljs rust"><span class="hljs-keyword">fn</span> <span class="hljs-title function_">last_digit</span>(lst: &amp;[<span class="hljs-type">u64</span>]) <span class="hljs-punctuation">-&gt;</span> <span class="hljs-type">u64</span> &#123;
    lst.<span class="hljs-title function_ invoke__">into_iter</span>()
       .<span class="hljs-title function_ invoke__">rev</span>()
       .<span class="hljs-title function_ invoke__">fold</span>(<span class="hljs-number">1u64</span>, |p, &amp;v| &#123;
           <span class="hljs-keyword">let</span> <span class="hljs-variable">base</span> = <span class="hljs-keyword">if</span> v &gt;= <span class="hljs-number">20</span> &#123; v % <span class="hljs-number">20</span> + <span class="hljs-number">20</span> &#125; <span class="hljs-keyword">else</span> &#123; v &#125;;
           <span class="hljs-keyword">let</span> <span class="hljs-variable">exp</span> = <span class="hljs-keyword">if</span> p &gt;= <span class="hljs-number">4</span> &#123; p % <span class="hljs-number">4</span> + <span class="hljs-number">4</span> &#125; <span class="hljs-keyword">else</span> &#123; p &#125;;

           base.<span class="hljs-title function_ invoke__">pow</span>(exp <span class="hljs-keyword">as</span> <span class="hljs-type">u32</span>)
       &#125;) % <span class="hljs-number">10</span>
&#125;</code></pre></div>
<hr>
<h3 id="Magic-Square">Magic Square</h3>
<p>See the wiki <a target="_blank" rel="noopener" href="https://en.wikipedia.org/wiki/Siamese_method">here</a>.</p>
<hr>
<h3 id="Pascal’s-Triangle-杨辉三角">Pascal’s Triangle (杨辉三角)</h3>
<p>See the wiki <a target="_blank" rel="noopener" href="https://en.wikipedia.org/wiki/Pascal's_triangle">here</a></p>
<p>A important collary is the ith number at nth level(n start from 0) is:</p>
<p class="katex-block "><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><mi>N</mi><mi>u</mi><msub><mi>m</mi><mtext>n,i</mtext></msub><mo>=</mo><mfrac><mrow><mi>n</mi><mo stretchy="false">!</mo></mrow><mrow><mi>i</mi><mo stretchy="false">!</mo><mo stretchy="false">(</mo><mi>n</mi><mo>−</mo><mi>i</mi><mo stretchy="false">)</mo><mo stretchy="false">!</mo></mrow></mfrac></mrow><annotation encoding="application/x-tex">Num_\text{n,i} = \frac{n!}{i!(n-i)!}
</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.9694em;vertical-align:-0.2861em;"></span><span class="mord mathnormal" style="margin-right:0.10903em;">N</span><span class="mord mathnormal">u</span><span class="mord"><span class="mord mathnormal">m</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3175em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord text mtight"><span class="mord mtight">n,i</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2861em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:2.3074em;vertical-align:-0.936em;"></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.3714em;"><span style="top:-2.314em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord mathnormal">i</span><span class="mclose">!</span><span class="mopen">(</span><span class="mord mathnormal">n</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mord mathnormal">i</span><span class="mclose">)!</span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"></span><span class="frac-line" style="border-bottom-width:0.04em;"></span></span><span style="top:-3.677em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord mathnormal">n</span><span class="mclose">!</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.936em;"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span></span></span></span></span></p>
<h2 id="Network">Network</h2>
<h3 id="Hub-switch-router">Hub, switch, router</h3>
<ul>
<li>
<p>Hub: all the devices are connected to the hub(with cable), and the hub broadcasts the packets to all the devices.</p>
</li>
<li>
<p>Switch: basically the same as hub, but it has a MAC addr table, so it can forward the packets to the specific device.</p>
</li>
<li>
<p>Router: it’s used to connect different networks, and it has an IP addr table, so it can forward the packets to the specific network.</p>
</li>
</ul>
<p>To be short, assume the topology is like this:</p>
<div class="code-wrapper"><pre><code class="hljs text">A - Switch1 - B
      |
    Router
      |
C - Switch2 - D</code></pre></div>
<p>If a packet is send to a device which is in the same subnet, the packet will be sent to the target device directly (or through switch), like A to B.</p>
<blockquote>
<p>To judge whether the target device is in the same subnet, we do calculation like this: <code>IP &amp; Mask</code> and compare this value.</p>
</blockquote>
<p>Otherwise if the target device is not in the same subnet, the packet will be sent to the Router, and the Router will forward the packet to the target device.</p>
<p>And the router is normally known as the <strong>default gateway</strong>. Actually, in the real world, <u>the default gateway is somewhere you send the packet to when you don’t know where to send it</u>.</p>
<p>A typical route table can be like this:</p>
<table>
<thead>
<tr>
<th>Network</th>
<th>Gateway</th>
<th>Interface</th>
</tr>
</thead>
<tbody>
<tr>
<td>0.0.0.0/0</td>
<td>ISP Gateway</td>
<td>ppp0</td>
</tr>
<tr>
<td>…</td>
<td>…</td>
<td>…</td>
</tr>
</tbody>
</table>
<p>All the unrecognized packets will be treated as <code>0.0.0.0</code> and be sent to the ISP gateway.</p>
<hr>
<h3 id="NAT">NAT</h3>
<p>To be short, all the devices behind a router share the same public IP address, and the router will translate the private IP address to the public IP address when the packet is sent to the internet.</p>
<p>The NAT table is like this:</p>
<table>
<thead>
<tr>
<th>Source IP</th>
<th>Source Port</th>
<th>Target IP</th>
<th>Target Port</th>
<th>Status</th>
</tr>
</thead>
<tbody>
<tr>
<td>192.168.31.100</td>
<td>54321</td>
<td>140.82.113.3</td>
<td>443</td>
<td>ESTABLISHED</td>
</tr>
<tr>
<td>…</td>
<td>…</td>
<td>…</td>
<td>…</td>
<td>…</td>
</tr>
</tbody>
</table>
<p>If there’re 2 devices connected to the same target, we need to add <strong><em>another layer</em></strong> to avoid conflict:</p>
<table>
<thead>
<tr>
<th>Internal IP</th>
<th>Internal Port</th>
<th>External IP</th>
<th>External Port</th>
<th>Target IP</th>
<th>Target Port</th>
<th>Status</th>
</tr>
</thead>
<tbody>
<tr>
<td>192.168.31.100</td>
<td>54321</td>
<td>203.0.113.2</td>
<td>50001</td>
<td>140.82.113.3</td>
<td>443</td>
<td>ESTABLISHED</td>
</tr>
<tr>
<td>192.168.33.100</td>
<td>54321</td>
<td>203.0.113.2</td>
<td>50002</td>
<td>140.82.113.3</td>
<td>443</td>
<td>ESTABLISHED</td>
</tr>
<tr>
<td>…</td>
<td>…</td>
<td>…</td>
<td>…</td>
<td>…</td>
<td>…</td>
<td>…</td>
</tr>
</tbody>
</table>
<hr>

                
              </div>
            
            <hr/>
            <div>
              <div class="post-metas my-3">
  
    <div class="post-meta mr-3 d-flex align-items-center">
      <i class="iconfont icon-category"></i>
      

<span class="category-chains">
  
  
    
      <span class="category-chain">
        
  <a href="/categories/tech/" class="category-chain-item">tech</a>
  
  

      </span>
    
  
</span>

    </div>
  
  
    <div class="post-meta">
      <i class="iconfont icon-tags"></i>
      
        <a href="/tags/Backend/" class="print-no-link">#Backend</a>
      
        <a href="/tags/Misc/" class="print-no-link">#Misc</a>
      
    </div>
  
</div>


              
  

  <div class="license-box my-3">
    <div class="license-title">
      <div>Backend Misc</div>
      <div>https://kayce.world/tech/backend_misc/</div>
    </div>
    <div class="license-meta">
      
        <div class="license-meta-item">
          <div>Author</div>
          <div>kayce</div>
        </div>
      
      
        <div class="license-meta-item license-meta-date">
          <div>Posted on</div>
          <div>December 30, 2024</div>
        </div>
      
      
        <div class="license-meta-item license-meta-date">
          <div>Updated on</div>
          <div>April 14, 2025</div>
        </div>
      
      
        <div class="license-meta-item">
          <div>Licensed under</div>
          <div>
            
              
              
                <a class="print-no-link" target="_blank" href="https://creativecommons.org/licenses/by-nc-sa/4.0/">
                  <span class="hint--top hint--rounded" aria-label="BY - Attribution">
                    <i class="iconfont icon-cc-by"></i>
                  </span>
                </a>
              
                <a class="print-no-link" target="_blank" href="https://creativecommons.org/licenses/by-nc-sa/4.0/">
                  <span class="hint--top hint--rounded" aria-label="NC - Non-commercial">
                    <i class="iconfont icon-cc-nc"></i>
                  </span>
                </a>
              
                <a class="print-no-link" target="_blank" href="https://creativecommons.org/licenses/by-nc-sa/4.0/">
                  <span class="hint--top hint--rounded" aria-label="SA - Share-alike">
                    <i class="iconfont icon-cc-sa"></i>
                  </span>
                </a>
              
            
          </div>
        </div>
      
    </div>
    <div class="license-icon iconfont"></div>
  </div>



              
                <div class="post-prevnext my-3">
                  <article class="post-prev col-6">
                    
                    
                      <a href="/tech/rule_based_auth_sys/" title="基于规则的权限系统">
                        <i class="iconfont icon-arrowleft"></i>
                        <span class="hidden-mobile">基于规则的权限系统</span>
                        <span class="visible-mobile">Previous</span>
                      </a>
                    
                  </article>
                  <article class="post-next col-6">
                    
                    
                      <a href="/chores/network_topology_at_home/" title="Network Topology at Home">
                        <span class="hidden-mobile">Network Topology at Home</span>
                        <span class="visible-mobile">Next</span>
                        <i class="iconfont icon-arrowright"></i>
                      </a>
                    
                  </article>
                </div>
              
            </div>

            
  
  
    <article id="comments" lazyload>
      
  <div id="gitalk-container"></div>
  <script type="text/javascript">
    Fluid.utils.loadComments('#gitalk-container', function() {
      Fluid.utils.createCssLink('/css/gitalk.css')
      Fluid.utils.createScript('https://lib.baomitu.com/gitalk/1.8.0/gitalk.min.js', function() {
        var options = Object.assign(
          {"clientID":"b25aa0a3d88c5fc4dbeb","clientSecret":"485e76d306112a519d43b4118efa8971c3ff6069","repo":"sshelll.github.io","owner":"sshelll","admin":["sshelll"],"language":"en-US","labels":["Gitalk"],"perPage":10,"pagerDirection":"last","distractionFreeMode":false,"createIssueManually":true,"proxy":"https://cors-anywhere.azm.workers.dev/https://github.com/login/oauth/access_token"},
          {
            id: 'a7efac520e27696342849a6c00ef1e7e'
          }
        )
        var gitalk = new Gitalk(options);
        gitalk.render('gitalk-container');
      });
    });
  </script>
  <noscript>Please enable JavaScript to view the comments</noscript>


    </article>
  


          </article>
        </div>
      </div>
    </div>

    <div class="side-col d-none d-lg-block col-lg-2">
      
  <aside class="sidebar" style="margin-left: -1rem">
    <div id="toc">
  <p class="toc-header">
    <i class="iconfont icon-list"></i>
    <span>Table of Contents</span>
  </p>
  <div class="toc-body" id="toc-body"></div>
</div>



  </aside>


    </div>
  </div>
</div>





  



  



  



  



  


  
  








    

    
      <a id="scroll-top-button" aria-label="TOP" href="#" role="button">
        <i class="iconfont icon-arrowup" aria-hidden="true"></i>
      </a>
    

    
      <div class="modal fade" id="modalSearch" tabindex="-1" role="dialog" aria-labelledby="ModalLabel"
     aria-hidden="true">
  <div class="modal-dialog modal-dialog-scrollable modal-lg" role="document">
    <div class="modal-content">
      <div class="modal-header text-center">
        <h4 class="modal-title w-100 font-weight-bold">Search</h4>
        <button type="button" id="local-search-close" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body mx-3">
        <div class="md-form mb-5">
          <input type="text" id="local-search-input" class="form-control validate">
          <label data-error="x" data-success="v" for="local-search-input">Keyword</label>
        </div>
        <div class="list-group" id="local-search-result"></div>
      </div>
    </div>
  </div>
</div>

    

    
  </main>

  <footer>
    <div class="footer-inner">
  
    <div class="footer-content">
      <a>kayce</a>
    </div>
  
  
    <div class="statistics">
  
  

  
    
      <span id="busuanzi_container_site_pv" style="display: none">
        Views: 
        <span id="busuanzi_value_site_pv"></span>
        
      </span>
    
    
      <span id="busuanzi_container_site_uv" style="display: none">
        Visitors: 
        <span id="busuanzi_value_site_uv"></span>
        
      </span>
    
    

  

</div>

  
  
</div>

  </footer>

  <!-- Scripts -->
  
  <script  src="https://lib.baomitu.com/nprogress/0.2.0/nprogress.min.js" ></script>
  <link  rel="stylesheet" href="https://lib.baomitu.com/nprogress/0.2.0/nprogress.min.css" />

  <script>
    NProgress.configure({"showSpinner":false,"trickleSpeed":100})
    NProgress.start()
    window.addEventListener('load', function() {
      NProgress.done();
    })
  </script>


<script  src="https://lib.baomitu.com/jquery/3.6.0/jquery.min.js" ></script>
<script  src="https://lib.baomitu.com/twitter-bootstrap/4.6.1/js/bootstrap.min.js" ></script>
<script  src="/js/events.js" ></script>
<script  src="/js/plugins.js" ></script>


  <script  src="https://lib.baomitu.com/typed.js/2.0.12/typed.min.js" ></script>
  <script>
    (function (window, document) {
      var typing = Fluid.plugins.typing;
      var subtitle = document.getElementById('subtitle');
      if (!subtitle || !typing) {
        return;
      }
      var text = subtitle.getAttribute('data-typed-text');
      
        typing(text);
      
    })(window, document);
  </script>




  
    <script  src="/js/img-lazyload.js" ></script>
  




  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/tocbot/4.18.2/tocbot.min.js', function() {
    var toc = jQuery('#toc');
    if (toc.length === 0 || !window.tocbot) { return; }
    var boardCtn = jQuery('#board-ctn');
    var boardTop = boardCtn.offset().top;

    window.tocbot.init(Object.assign({
      tocSelector     : '#toc-body',
      contentSelector : '.markdown-body',
      linkClass       : 'tocbot-link',
      activeLinkClass : 'tocbot-active-link',
      listClass       : 'tocbot-list',
      isCollapsedClass: 'tocbot-is-collapsed',
      collapsibleClass: 'tocbot-is-collapsible',
      scrollSmooth    : true,
      includeTitleTags: true,
      headingsOffset  : -boardTop,
    }, CONFIG.toc));
    if (toc.find('.toc-list-item').length > 0) {
      toc.css('visibility', 'visible');
    }

    Fluid.events.registerRefreshCallback(function() {
      if ('tocbot' in window) {
        tocbot.refresh();
        var toc = jQuery('#toc');
        if (toc.length === 0 || !tocbot) {
          return;
        }
        if (toc.find('.toc-list-item').length > 0) {
          toc.css('visibility', 'visible');
        }
      }
    });
  });
</script>


  <script src=https://lib.baomitu.com/clipboard.js/2.0.11/clipboard.min.js></script>

  <script>Fluid.plugins.codeWidget();</script>


  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/anchor-js/4.3.1/anchor.min.js', function() {
    window.anchors.options = {
      placement: CONFIG.anchorjs.placement,
      visible  : CONFIG.anchorjs.visible
    };
    if (CONFIG.anchorjs.icon) {
      window.anchors.options.icon = CONFIG.anchorjs.icon;
    }
    var el = (CONFIG.anchorjs.element || 'h1,h2,h3,h4,h5,h6').split(',');
    var res = [];
    for (var item of el) {
      res.push('.markdown-body > ' + item.trim());
    }
    if (CONFIG.anchorjs.placement === 'left') {
      window.anchors.options.class = 'anchorjs-link-left';
    }
    window.anchors.add(res.join(', '));

    Fluid.events.registerRefreshCallback(function() {
      if ('anchors' in window) {
        anchors.removeAll();
        var el = (CONFIG.anchorjs.element || 'h1,h2,h3,h4,h5,h6').split(',');
        var res = [];
        for (var item of el) {
          res.push('.markdown-body > ' + item.trim());
        }
        if (CONFIG.anchorjs.placement === 'left') {
          anchors.options.class = 'anchorjs-link-left';
        }
        anchors.add(res.join(', '));
      }
    });
  });
</script>


  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/fancybox/3.5.7/jquery.fancybox.min.js', function() {
    Fluid.plugins.fancyBox();
  });
</script>


  <script>Fluid.plugins.imageCaption();</script>

  <script  src="/js/local-search.js" ></script>

  <script defer src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js" ></script>





<!-- 主题的启动项，将它保持在最底部 -->
<!-- the boot of the theme, keep it at the bottom -->
<script  src="/js/boot.js" ></script>


  

  <noscript>
    <div class="noscript-warning">Blog works best with JavaScript enabled</div>
  </noscript>
</body>
</html>
